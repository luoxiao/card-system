<?php
require_once 'AopEncrypt.php'; class AopClient { public $appId; public $rsaPrivateKeyFilePath; public $rsaPrivateKey; public $gatewayUrl = 'https://openapi.alipay.com/gateway.do'; public $format = 'json'; public $apiVersion = '1.0'; public $postCharset = 'UTF-8'; public $alipayPublicKey = null; public $alipayrsaPublicKey; public $debugInfo = false; private $fileCharset = 'UTF-8'; private $RESPONSE_SUFFIX = '_response'; private $ERROR_RESPONSE = 'error_response'; private $SIGN_NODE_NAME = 'sign'; private $ENCRYPT_XML_NODE_NAME = 'response_encrypted'; private $needEncrypt = false; public $signType = 'RSA'; public $encryptKey; public $encryptType = 'AES'; protected $alipaySdkVersion = 'alipay-sdk-php-20161101'; public function generateSign($sp5e6808, $sp1a305d = 'RSA') { return $this->sign($this->getSignContent($sp5e6808), $sp1a305d); } public function rsaSign($sp5e6808, $sp1a305d = 'RSA') { return $this->sign($this->getSignContent($sp5e6808), $sp1a305d); } protected function getSignContent($sp5e6808) { ksort($sp5e6808); $spe17937 = ''; $sp3deb2c = 0; foreach ($sp5e6808 as $sp467973 => $sp06d9c9) { if (false === $this->checkEmpty($sp06d9c9) && '@' != substr($sp06d9c9, 0, 1)) { $sp06d9c9 = $this->characet($sp06d9c9, $this->postCharset); if ($sp3deb2c == 0) { $spe17937 .= "{$sp467973}" . '=' . "{$sp06d9c9}"; } else { $spe17937 .= '&' . "{$sp467973}" . '=' . "{$sp06d9c9}"; } $sp3deb2c++; } } unset($sp467973, $sp06d9c9); return $spe17937; } protected function sign($sp631d11, $sp1a305d = 'RSA') { if ($this->checkEmpty($this->rsaPrivateKeyFilePath)) { $spb157af = $this->rsaPrivateKey; $spb12888 = '-----BEGIN RSA PRIVATE KEY-----
' . wordwrap($spb157af, 64, '
', true) . '
-----END RSA PRIVATE KEY-----'; } else { $spb157af = file_get_contents($this->rsaPrivateKeyFilePath); $spb12888 = openssl_get_privatekey($spb157af); } $spb12888 or die('æ‚¨ä½¿ç”¨çš„ç§é’¥æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥RSAç§é’¥é…ç½®'); if ('RSA2' == $sp1a305d) { openssl_sign($sp631d11, $sp7b1c1e, $spb12888, OPENSSL_ALGO_SHA256); } else { openssl_sign($sp631d11, $sp7b1c1e, $spb12888); } if (!$this->checkEmpty($this->rsaPrivateKeyFilePath)) { openssl_free_key($spb12888); } $sp7b1c1e = base64_encode($sp7b1c1e); return $sp7b1c1e; } protected function curl($spaf19c1, $spd72efa = null) { $sp03f466 = curl_init(); curl_setopt($sp03f466, CURLOPT_URL, $spaf19c1); curl_setopt($sp03f466, CURLOPT_FAILONERROR, false); curl_setopt($sp03f466, CURLOPT_RETURNTRANSFER, true); curl_setopt($sp03f466, CURLOPT_SSL_VERIFYPEER, false); $sp1a829b = ''; $sp576f8c = array(); $spb909fe = false; if (is_array($spd72efa) && 0 < count($spd72efa)) { foreach ($spd72efa as $sp467973 => $sp06d9c9) { if ('@' != substr($sp06d9c9, 0, 1)) { $sp1a829b .= "{$sp467973}=" . urlencode($this->characet($sp06d9c9, $this->postCharset)) . '&'; $sp576f8c[$sp467973] = $this->characet($sp06d9c9, $this->postCharset); } else { $spb909fe = true; $sp576f8c[$sp467973] = new \CURLFile(substr($sp06d9c9, 1)); } } unset($sp467973, $sp06d9c9); curl_setopt($sp03f466, CURLOPT_POST, true); if ($spb909fe) { curl_setopt($sp03f466, CURLOPT_POSTFIELDS, $sp576f8c); } else { curl_setopt($sp03f466, CURLOPT_POSTFIELDS, substr($sp1a829b, 0, -1)); } } if ($spb909fe) { $sp71f60e = array('content-type: multipart/form-data;charset=' . $this->postCharset . ';boundary=' . $this->getMillisecond()); } else { $sp71f60e = array('content-type: application/x-www-form-urlencoded;charset=' . $this->postCharset); } curl_setopt($sp03f466, CURLOPT_HTTPHEADER, $sp71f60e); $sp2d4566 = curl_exec($sp03f466); if (curl_errno($sp03f466)) { throw new Exception(curl_error($sp03f466), 0); } else { $sp52e441 = curl_getinfo($sp03f466, CURLINFO_HTTP_CODE); if (200 !== $sp52e441) { throw new Exception($sp2d4566, $sp52e441); } } curl_close($sp03f466); return $sp2d4566; } protected function getMillisecond() { list($spb67b56, $spc84e5a) = explode(' ', microtime()); return (double) sprintf('%.0f', (floatval($spb67b56) + floatval($spc84e5a)) * 1000); } protected function logCommunicationError($sp7377b3, $sp38adf7, $spee330c, $spfa1310) { $sp4c5670 = isset($_SERVER['SERVER_ADDR']) ? $_SERVER['SERVER_ADDR'] : 'CLI'; $sp58935b = new LtLogger(); $sp58935b->conf['log_file'] = rtrim(AOP_SDK_WORK_DIR, '\\/') . '/' . 'logs/aop_comm_err_' . $this->appId . '_' . date('Y-m-d') . '.log'; $sp58935b->conf['separator'] = '^_^'; $sp729104 = array(date('Y-m-d H:i:s'), $sp7377b3, $this->appId, $sp4c5670, PHP_OS, $this->alipaySdkVersion, $sp38adf7, $spee330c, str_replace('
', '', $spfa1310)); $sp58935b->log($sp729104); } public function sdkExecute($sp2f63b0) { $this->setupCharsets($sp2f63b0); $sp5e6808['app_id'] = $this->appId; $sp5e6808['method'] = $sp2f63b0->getApiMethodName(); $sp5e6808['format'] = $this->format; $sp5e6808['sign_type'] = $this->signType; $sp5e6808['timestamp'] = date('Y-m-d H:i:s'); $sp5e6808['alipay_sdk'] = $this->alipaySdkVersion; $sp5e6808['charset'] = $this->postCharset; $spf21bb0 = $sp2f63b0->getApiVersion(); $sp5e6808['version'] = $this->checkEmpty($spf21bb0) ? $this->apiVersion : $spf21bb0; if ($sp72a819 = $sp2f63b0->getNotifyUrl()) { $sp5e6808['notify_url'] = $sp72a819; } $sp66248c = $sp2f63b0->getApiParas(); $sp5e6808['biz_content'] = $sp66248c['biz_content']; ksort($sp5e6808); $sp5e6808['sign'] = $this->generateSign($sp5e6808, $this->signType); foreach ($sp5e6808 as &$spd77a65) { $spd77a65 = $this->characet($spd77a65, $sp5e6808['charset']); } return http_build_query($sp5e6808); } public function pageExecute($sp2f63b0, $spe14775 = 'POST') { $this->setupCharsets($sp2f63b0); if (strcasecmp($this->fileCharset, $this->postCharset)) { throw new Exception('æ–‡ä»¶ç¼–ç ï¼š[' . $this->fileCharset . '] ä¸Žè¡¨å•æäº¤ç¼–ç ï¼š[' . $this->postCharset . ']ä¸¤è€…ä¸ä¸€è‡´!'); } $sp9161ba = null; if (!$this->checkEmpty($sp2f63b0->getApiVersion())) { $sp9161ba = $sp2f63b0->getApiVersion(); } else { $sp9161ba = $this->apiVersion; } $spea8c18['app_id'] = $this->appId; $spea8c18['version'] = $sp9161ba; $spea8c18['format'] = $this->format; $spea8c18['sign_type'] = $this->signType; $spea8c18['method'] = $sp2f63b0->getApiMethodName(); $spea8c18['timestamp'] = date('Y-m-d H:i:s'); $spea8c18['alipay_sdk'] = $this->alipaySdkVersion; $spea8c18['terminal_type'] = $sp2f63b0->getTerminalType(); $spea8c18['terminal_info'] = $sp2f63b0->getTerminalInfo(); $spea8c18['prod_code'] = $sp2f63b0->getProdCode(); $spea8c18['notify_url'] = $sp2f63b0->getNotifyUrl(); $spea8c18['return_url'] = $sp2f63b0->getReturnUrl(); $spea8c18['charset'] = $this->postCharset; $sp00ab6b = $sp2f63b0->getApiParas(); if (method_exists($sp2f63b0, 'getNeedEncrypt') && $sp2f63b0->getNeedEncrypt()) { $spea8c18['encrypt_type'] = $this->encryptType; if ($this->checkEmpty($sp00ab6b['biz_content'])) { throw new Exception(' api request Fail! The reason : encrypt request is not supperted!'); } if ($this->checkEmpty($this->encryptKey) || $this->checkEmpty($this->encryptType)) { throw new Exception(' encryptType and encryptKey must not null! '); } if ('AES' != $this->encryptType) { throw new Exception('åŠ å¯†ç±»åž‹åªæ”¯æŒAES'); } $spe12d93 = aliqr_encrypt($sp00ab6b['biz_content'], $this->encryptKey); $sp00ab6b['biz_content'] = $spe12d93; } $spb240d5 = array_merge($sp00ab6b, $spea8c18); $sp1807b4 = $this->getSignContent($spb240d5); $spb240d5['sign'] = $this->generateSign($spb240d5, $this->signType); if ('GET' == $spe14775) { $sp38adf7 = $this->gatewayUrl . '?' . $sp1807b4 . '&sign=' . urlencode($spb240d5['sign']); return $sp38adf7; } else { return $this->buildRequestForm($spb240d5); } } protected function buildRequestForm($spb3c003) { $sp747f8a = '<form id=\'alipaysubmit\' name=\'alipaysubmit\' action=\'' . $this->gatewayUrl . '?charset=' . trim($this->postCharset) . '\' method=\'POST\'>'; while (list($spb5c5a0, $spe3999d) = each($spb3c003)) { if (false === $this->checkEmpty($spe3999d)) { $spe3999d = str_replace('\'', '&apos;', $spe3999d); $sp747f8a .= '<input type=\'hidden\' name=\'' . $spb5c5a0 . '\' value=\'' . $spe3999d . '\'/>'; } } $sp747f8a = $sp747f8a . '<input type=\'submit\' value=\'ok\' style=\'display:none;\'\'></form>'; $sp747f8a = $sp747f8a . '<script>document.forms[\'alipaysubmit\'].submit();</script>'; return $sp747f8a; } public function execute($sp2f63b0, $spccb0cb = null, $sp93a4da = null) { $this->setupCharsets($sp2f63b0); if (strcasecmp($this->fileCharset, $this->postCharset)) { throw new Exception('æ–‡ä»¶ç¼–ç ï¼š[' . $this->fileCharset . '] ä¸Žè¡¨å•æäº¤ç¼–ç ï¼š[' . $this->postCharset . ']ä¸¤è€…ä¸ä¸€è‡´!'); } $sp9161ba = null; if (!$this->checkEmpty($sp2f63b0->getApiVersion())) { $sp9161ba = $sp2f63b0->getApiVersion(); } else { $sp9161ba = $this->apiVersion; } $spea8c18['app_id'] = $this->appId; $spea8c18['version'] = $sp9161ba; $spea8c18['format'] = $this->format; $spea8c18['sign_type'] = $this->signType; $spea8c18['method'] = $sp2f63b0->getApiMethodName(); $spea8c18['timestamp'] = date('Y-m-d H:i:s'); $spea8c18['auth_token'] = $spccb0cb; $spea8c18['alipay_sdk'] = $this->alipaySdkVersion; $spea8c18['terminal_type'] = $sp2f63b0->getTerminalType(); $spea8c18['terminal_info'] = $sp2f63b0->getTerminalInfo(); $spea8c18['prod_code'] = $sp2f63b0->getProdCode(); $spea8c18['notify_url'] = $sp2f63b0->getNotifyUrl(); $spea8c18['charset'] = $this->postCharset; $spea8c18['app_auth_token'] = $sp93a4da; $sp00ab6b = $sp2f63b0->getApiParas(); if (method_exists($sp2f63b0, 'getNeedEncrypt') && $sp2f63b0->getNeedEncrypt()) { $spea8c18['encrypt_type'] = $this->encryptType; if ($this->checkEmpty($sp00ab6b['biz_content'])) { throw new Exception(' api request Fail! The reason : encrypt request is not supperted!'); } if ($this->checkEmpty($this->encryptKey) || $this->checkEmpty($this->encryptType)) { throw new Exception(' encryptType and encryptKey must not null! '); } if ('AES' != $this->encryptType) { throw new Exception('åŠ å¯†ç±»åž‹åªæ”¯æŒAES'); } $spe12d93 = aliqr_encrypt($sp00ab6b['biz_content'], $this->encryptKey); $sp00ab6b['biz_content'] = $spe12d93; } $spea8c18['sign'] = $this->generateSign(array_merge($sp00ab6b, $spea8c18), $this->signType); $sp38adf7 = $this->gatewayUrl . '?'; foreach ($spea8c18 as $sp2b885e => $sp9aba40) { $sp38adf7 .= "{$sp2b885e}=" . urlencode($this->characet($sp9aba40, $this->postCharset)) . '&'; } $sp38adf7 = substr($sp38adf7, 0, -1); try { $sp95f2fa = $this->curl($sp38adf7, $sp00ab6b); } catch (Exception $spa9e936) { $this->logCommunicationError($spea8c18['method'], $sp38adf7, 'HTTP_ERROR_' . $spa9e936->getCode(), $spa9e936->getMessage()); return false; } $sp6d60b5 = false; $spc0edfe = iconv($this->postCharset, $this->fileCharset . '//IGNORE', $sp95f2fa); $spc91b75 = null; if ('json' == $this->format) { $spcb151e = json_decode($spc0edfe); if (null !== $spcb151e) { $sp6d60b5 = true; $spc91b75 = $this->parserJSONSignData($sp2f63b0, $sp95f2fa, $spcb151e); } } else { if ('xml' == $this->format) { $spcb151e = @simplexml_load_string($sp95f2fa); if (false !== $spcb151e) { $sp6d60b5 = true; $spc91b75 = $this->parserXMLSignData($sp2f63b0, $sp95f2fa); } } } if (false === $sp6d60b5) { $this->logCommunicationError($spea8c18['method'], $sp38adf7, 'HTTP_RESPONSE_NOT_WELL_FORMED', $sp95f2fa); return false; } $this->checkResponseSign($sp2f63b0, $spc91b75, $sp95f2fa, $spcb151e); if (method_exists($sp2f63b0, 'getNeedEncrypt') && $sp2f63b0->getNeedEncrypt()) { if ('json' == $this->format) { $sp95f2fa = $this->encryptJSONSignSource($sp2f63b0, $sp95f2fa); $spc0edfe = iconv($this->postCharset, $this->fileCharset . '//IGNORE', $sp95f2fa); $spcb151e = json_decode($spc0edfe); } else { $sp95f2fa = $this->encryptXMLSignSource($sp2f63b0, $sp95f2fa); $spc0edfe = iconv($this->postCharset, $this->fileCharset . '//IGNORE', $sp95f2fa); $spcb151e = @simplexml_load_string($spc0edfe); } } return $spcb151e; } function characet($sp631d11, $spebfdd1) { if (!empty($sp631d11)) { $spc92161 = $this->fileCharset; if (strcasecmp($spc92161, $spebfdd1) != 0) { $sp631d11 = mb_convert_encoding($sp631d11, $spebfdd1, $spc92161); } } return $sp631d11; } public function exec($sp8ca8cb) { if (!isset($sp8ca8cb['method'])) { trigger_error('No api name passed'); } $spc0a60f = new LtInflector(); $spc0a60f->conf['separator'] = '.'; $sp0579da = ucfirst($spc0a60f->camelize(substr($sp8ca8cb['method'], 7))) . 'Request'; if (!class_exists($sp0579da)) { trigger_error('No such api: ' . $sp8ca8cb['method']); } $sp9f524b = isset($sp8ca8cb['session']) ? $sp8ca8cb['session'] : null; $sp6399bd = new $sp0579da(); foreach ($sp8ca8cb as $sp1fedae => $sp3a516e) { $spc0a60f->conf['separator'] = '_'; $spe29c7b = $spc0a60f->camelize($sp1fedae); $spc0a60f->conf['separator'] = '.'; $spe29c7b = 'set' . $spc0a60f->camelize($spe29c7b); if (method_exists($sp6399bd, $spe29c7b)) { $sp6399bd->{$spe29c7b}($sp3a516e); } } return $this->execute($sp6399bd, $sp9f524b); } protected function checkEmpty($spd77a65) { if (!isset($spd77a65)) { return true; } if ($spd77a65 === null) { return true; } if (trim($spd77a65) === '') { return true; } return false; } public function rsaCheckV1($sp5e6808, $sp03cc90, $sp1a305d = 'RSA') { $sp7b1c1e = $sp5e6808['sign']; $sp5e6808['sign_type'] = null; $sp5e6808['sign'] = null; return $this->verify($this->getSignContent($sp5e6808), $sp7b1c1e, $sp03cc90, $sp1a305d); } public function rsaCheckV2($sp5e6808, $sp03cc90, $sp1a305d = 'RSA') { print_r($sp5e6808); $sp7b1c1e = $sp5e6808['sign']; $sp5e6808['sign'] = null; return $this->verify($this->getSignContent($sp5e6808), $sp7b1c1e, $sp03cc90, $sp1a305d); } function verify($sp631d11, $sp7b1c1e, $sp03cc90, $sp1a305d = 'RSA') { if ($this->checkEmpty($this->alipayPublicKey)) { $spcbca3e = $this->alipayrsaPublicKey; $spb12888 = '-----BEGIN PUBLIC KEY-----
' . wordwrap($spcbca3e, 64, '
', true) . '
-----END PUBLIC KEY-----'; } else { $spcbca3e = file_get_contents($sp03cc90); $spb12888 = openssl_get_publickey($spcbca3e); } $spb12888 or die('æ”¯ä»˜å®RSAå…¬é’¥é”™è¯¯ã€‚è¯·æ£€æŸ¥å…¬é’¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®'); if ('RSA2' == $sp1a305d) { $sp594fbb = (bool) openssl_verify($sp631d11, base64_decode($sp7b1c1e), $spb12888, OPENSSL_ALGO_SHA256); } else { $sp594fbb = (bool) openssl_verify($sp631d11, base64_decode($sp7b1c1e), $spb12888); } if (!$this->checkEmpty($this->alipayPublicKey)) { openssl_free_key($spb12888); } return $sp594fbb; } public function checkSignAndDecrypt($sp5e6808, $sp8ea980, $sp83f302, $sp531aa8, $sp88d59d) { $sp293204 = $sp5e6808['charset']; $spe0aa15 = $sp5e6808['biz_content']; if ($sp531aa8) { if (!$this->rsaCheckV2($sp5e6808, $sp8ea980)) { echo '<br/>checkSign failure<br/>'; die; } } if ($sp88d59d) { return $this->rsaDecrypt($spe0aa15, $sp83f302, $sp293204); } return $spe0aa15; } public function encryptAndSign($spe0aa15, $sp8ea980, $sp83f302, $sp293204, $sped7a9b, $sp80c28f) { if ($sped7a9b && $sp80c28f) { $sp9574dd = $this->rsaEncrypt($spe0aa15, $sp8ea980, $sp293204); $sp7b1c1e = $this->sign($spe0aa15); $spf1d2fd = "<?xml version=\"1.0\" encoding=\"{$sp293204}\"?><alipay><response>{$sp9574dd}</response><encryption_type>RSA</encryption_type><sign>{$sp7b1c1e}</sign><sign_type>RSA</sign_type></alipay>"; return $spf1d2fd; } if ($sped7a9b && !$sp80c28f) { $sp9574dd = $this->rsaEncrypt($spe0aa15, $sp8ea980, $sp293204); $spf1d2fd = "<?xml version=\"1.0\" encoding=\"{$sp293204}\"?><alipay><response>{$sp9574dd}</response><encryption_type>RSA</encryption_type></alipay>"; return $spf1d2fd; } if (!$sped7a9b && $sp80c28f) { $sp7b1c1e = $this->sign($spe0aa15); $spf1d2fd = "<?xml version=\"1.0\" encoding=\"{$sp293204}\"?><alipay><response>{$spe0aa15}</response><sign>{$sp7b1c1e}</sign><sign_type>RSA</sign_type></alipay>"; return $spf1d2fd; } $spf1d2fd = "<?xml version=\"1.0\" encoding=\"{$sp293204}\"?>{$spe0aa15}"; return $spf1d2fd; } public function rsaEncrypt($sp631d11, $sp8ea980, $sp293204) { $spcbca3e = file_get_contents($sp8ea980); $spb12888 = openssl_get_publickey($spcbca3e); $spf7f33e = $this->splitCN($sp631d11, 0, 30, $sp293204); $sp45a308 = null; $sp8c76af = array(); foreach ($spf7f33e as $sp719186 => $spd76a83) { if (!openssl_public_encrypt($spd76a83, $sp45a308, $spb12888)) { echo '<br/>' . openssl_error_string() . '<br/>'; } $sp9546e7[] = $sp45a308; } $sp5196d6 = implode(',', $sp9546e7); return $sp5196d6; } public function rsaDecrypt($sp631d11, $sp83f302, $sp293204) { $spb157af = file_get_contents($sp83f302); $spb12888 = openssl_get_privatekey($spb157af); $sp695b98 = explode(',', $sp631d11); $spbccbae = ''; $sp0cb2ae = ''; foreach ($sp695b98 as $sp719186 => $sp314685) { if (!openssl_private_decrypt($sp314685, $sp0cb2ae, $spb12888)) { echo '<br/>' . openssl_error_string() . '<br/>'; } $spbccbae .= $sp0cb2ae; } return $spbccbae; } function splitCN($sp32309a, $sp719186 = 0, $spba4c57, $sp293204) { $spc41306 = array(); for ($sp3deb2c = $sp719186; $sp3deb2c < strlen($sp32309a); $sp3deb2c += $spba4c57) { $spb12888 = $this->subCNchar($sp32309a, $sp3deb2c, $spba4c57, $sp293204); if (!empty($spb12888)) { $spc41306[] = $spb12888; } } return $spc41306; } function subCNchar($spf2d586, $sp2a0765 = 0, $sp46bdd0, $sp293204 = 'gbk') { if (strlen($spf2d586) <= $sp46bdd0) { return $spf2d586; } $sp0e2106['utf-8'] = '/[-]|[Â-ß][€-¿]|[à-ï][€-¿]{2}|[ð-ÿ][€-¿]{3}/'; $sp0e2106['gb2312'] = '/[-]|[°-÷][ -þ]/'; $sp0e2106['gbk'] = '/[-]|[-þ][@-þ]/'; $sp0e2106['big5'] = '/[-]|[-þ]([@-~]|¡-þ])/'; preg_match_all($sp0e2106[$sp293204], $spf2d586, $sp6c4e57); $sp607377 = join('', array_slice($sp6c4e57[0], $sp2a0765, $sp46bdd0)); return $sp607377; } function parserResponseSubCode($sp2f63b0, $spf53fbb, $spcb151e, $spd977f3) { if ('json' == $spd977f3) { $sp7377b3 = $sp2f63b0->getApiMethodName(); $sp4879bf = str_replace('.', '_', $sp7377b3) . $this->RESPONSE_SUFFIX; $spbd3f64 = $this->ERROR_RESPONSE; $spdce071 = strpos($spf53fbb, $sp4879bf); $spa31f56 = strpos($spf53fbb, $spbd3f64); if ($spdce071 > 0) { $sp702e90 = $spcb151e->{$sp4879bf}; } elseif ($spa31f56 > 0) { $sp702e90 = $spcb151e->{$spbd3f64}; } else { return null; } if (isset($sp702e90->sub_code)) { return $sp702e90->sub_code; } else { return null; } } elseif ('xml' == $spd977f3) { return $spcb151e->sub_code; } } function parserJSONSignData($sp2f63b0, $spf53fbb, $sp1a6b65) { $spc91b75 = new SignData(); $spc91b75->sign = $this->parserJSONSign($sp1a6b65); $spc91b75->signSourceData = $this->parserJSONSignSource($sp2f63b0, $spf53fbb); return $spc91b75; } function parserJSONSignSource($sp2f63b0, $spf53fbb) { $sp7377b3 = $sp2f63b0->getApiMethodName(); $sp4879bf = str_replace('.', '_', $sp7377b3) . $this->RESPONSE_SUFFIX; $spdce071 = strpos($spf53fbb, $sp4879bf); $spa31f56 = strpos($spf53fbb, $this->ERROR_RESPONSE); if ($spdce071 > 0) { return $this->parserJSONSource($spf53fbb, $sp4879bf, $spdce071); } else { if ($spa31f56 > 0) { return $this->parserJSONSource($spf53fbb, $this->ERROR_RESPONSE, $spa31f56); } else { return null; } } } function parserJSONSource($spf53fbb, $spd99a63, $sp281fce) { $sp50acc2 = $sp281fce + strlen($spd99a63) + 2; $spadacdd = strpos($spf53fbb, '"' . $this->SIGN_NODE_NAME . '"'); $spf6a004 = $spadacdd - 1; $sp7428fb = $spf6a004 - $sp50acc2; if ($sp7428fb < 0) { return null; } return substr($spf53fbb, $sp50acc2, $sp7428fb); } function parserJSONSign($sp983052) { return $sp983052->sign; } function parserXMLSignData($sp2f63b0, $spf53fbb) { $spc91b75 = new SignData(); $spc91b75->sign = $this->parserXMLSign($spf53fbb); $spc91b75->signSourceData = $this->parserXMLSignSource($sp2f63b0, $spf53fbb); return $spc91b75; } function parserXMLSignSource($sp2f63b0, $spf53fbb) { $sp7377b3 = $sp2f63b0->getApiMethodName(); $sp4879bf = str_replace('.', '_', $sp7377b3) . $this->RESPONSE_SUFFIX; $spdce071 = strpos($spf53fbb, $sp4879bf); $spa31f56 = strpos($spf53fbb, $this->ERROR_RESPONSE); if ($spdce071 > 0) { return $this->parserXMLSource($spf53fbb, $sp4879bf, $spdce071); } else { if ($spa31f56 > 0) { return $this->parserXMLSource($spf53fbb, $this->ERROR_RESPONSE, $spa31f56); } else { return null; } } } function parserXMLSource($spf53fbb, $spd99a63, $sp281fce) { $sp50acc2 = $sp281fce + strlen($spd99a63) + 1; $spadacdd = strpos($spf53fbb, '<' . $this->SIGN_NODE_NAME . '>'); $spf6a004 = $spadacdd - 1; $sp7428fb = $spf6a004 - $sp50acc2 + 1; if ($sp7428fb < 0) { return null; } return substr($spf53fbb, $sp50acc2, $sp7428fb); } function parserXMLSign($spf53fbb) { $sp5104f4 = '<' . $this->SIGN_NODE_NAME . '>'; $sp537846 = '</' . $this->SIGN_NODE_NAME . '>'; $spcac3aa = strpos($spf53fbb, $sp5104f4); $spb80db5 = strpos($spf53fbb, $sp537846); if ($spcac3aa < 0 || $spb80db5 < 0) { return null; } $sp281fce = $spcac3aa + strlen($sp5104f4); $sp7428fb = $spb80db5 - $sp281fce; if ($sp7428fb < 0) { return null; } return substr($spf53fbb, $sp281fce, $sp7428fb); } public function checkResponseSign($sp2f63b0, $spc91b75, $sp95f2fa, $spcb151e) { if (!$this->checkEmpty($this->alipayPublicKey) || !$this->checkEmpty($this->alipayrsaPublicKey)) { if ($spc91b75 == null || $this->checkEmpty($spc91b75->sign) || $this->checkEmpty($spc91b75->signSourceData)) { throw new Exception(' check sign Fail! The reason : signData is Empty'); } $spee68d9 = $this->parserResponseSubCode($sp2f63b0, $sp95f2fa, $spcb151e, $this->format); if (!$this->checkEmpty($spee68d9) || $this->checkEmpty($spee68d9) && !$this->checkEmpty($spc91b75->sign)) { $spce4d62 = $this->verify($spc91b75->signSourceData, $spc91b75->sign, $this->alipayPublicKey, $this->signType); if (!$spce4d62) { if (strpos($spc91b75->signSourceData, '\\/') > 0) { $spc91b75->signSourceData = str_replace('\\/', '/', $spc91b75->signSourceData); $spce4d62 = $this->verify($spc91b75->signSourceData, $spc91b75->sign, $this->alipayPublicKey, $this->signType); if (!$spce4d62) { throw new Exception('check sign Fail! [sign=' . $spc91b75->sign . ', signSourceData=' . $spc91b75->signSourceData . ']'); } } else { throw new Exception('check sign Fail! [sign=' . $spc91b75->sign . ', signSourceData=' . $spc91b75->signSourceData . ']'); } } } } } private function setupCharsets($sp2f63b0) { if ($this->checkEmpty($this->postCharset)) { $this->postCharset = 'UTF-8'; } $spf2d586 = preg_match('/[\\x80-\\xff]/', $this->appId) ? $this->appId : print_r($sp2f63b0, true); $this->fileCharset = mb_detect_encoding($spf2d586, 'UTF-8, GBK') == 'UTF-8' ? 'UTF-8' : 'GBK'; } private function encryptJSONSignSource($sp2f63b0, $spf53fbb) { $sp347352 = $this->parserEncryptJSONSignSource($sp2f63b0, $spf53fbb); $sp2928a9 = substr($spf53fbb, 0, $sp347352->startIndex); $sp5fa7bb = substr($spf53fbb, $sp347352->endIndex, strlen($spf53fbb) + 1 - $sp347352->endIndex); $spe0aa15 = aliqr_decrypt($sp347352->encryptContent, $this->encryptKey); return $sp2928a9 . $spe0aa15 . $sp5fa7bb; } private function parserEncryptJSONSignSource($sp2f63b0, $spf53fbb) { $sp7377b3 = $sp2f63b0->getApiMethodName(); $sp4879bf = str_replace('.', '_', $sp7377b3) . $this->RESPONSE_SUFFIX; $spdce071 = strpos($spf53fbb, $sp4879bf); $spa31f56 = strpos($spf53fbb, $this->ERROR_RESPONSE); if ($spdce071 > 0) { return $this->parserEncryptJSONItem($spf53fbb, $sp4879bf, $spdce071); } else { if ($spa31f56 > 0) { return $this->parserEncryptJSONItem($spf53fbb, $this->ERROR_RESPONSE, $spa31f56); } else { return null; } } } private function parserEncryptJSONItem($spf53fbb, $spd99a63, $sp281fce) { $sp50acc2 = $sp281fce + strlen($spd99a63) + 2; $spadacdd = strpos($spf53fbb, '"' . $this->SIGN_NODE_NAME . '"'); $spf6a004 = $spadacdd - 1; if ($spf6a004 < 0) { $spf6a004 = strlen($spf53fbb) - 1; } $sp7428fb = $spf6a004 - $sp50acc2; $spf9eedc = substr($spf53fbb, $sp50acc2 + 1, $sp7428fb - 2); $sp3d3b49 = new EncryptParseItem(); $sp3d3b49->encryptContent = $spf9eedc; $sp3d3b49->startIndex = $sp50acc2; $sp3d3b49->endIndex = $spf6a004; return $sp3d3b49; } private function encryptXMLSignSource($sp2f63b0, $spf53fbb) { $sp347352 = $this->parserEncryptXMLSignSource($sp2f63b0, $spf53fbb); $sp2928a9 = substr($spf53fbb, 0, $sp347352->startIndex); $sp5fa7bb = substr($spf53fbb, $sp347352->endIndex, strlen($spf53fbb) + 1 - $sp347352->endIndex); $spe0aa15 = aliqr_decrypt($sp347352->encryptContent, $this->encryptKey); return $sp2928a9 . $spe0aa15 . $sp5fa7bb; } private function parserEncryptXMLSignSource($sp2f63b0, $spf53fbb) { $sp7377b3 = $sp2f63b0->getApiMethodName(); $sp4879bf = str_replace('.', '_', $sp7377b3) . $this->RESPONSE_SUFFIX; $spdce071 = strpos($spf53fbb, $sp4879bf); $spa31f56 = strpos($spf53fbb, $this->ERROR_RESPONSE); if ($spdce071 > 0) { return $this->parserEncryptXMLItem($spf53fbb, $sp4879bf, $spdce071); } else { if ($spa31f56 > 0) { return $this->parserEncryptXMLItem($spf53fbb, $this->ERROR_RESPONSE, $spa31f56); } else { return null; } } } private function parserEncryptXMLItem($spf53fbb, $spd99a63, $sp281fce) { $sp50acc2 = $sp281fce + strlen($spd99a63) + 1; $sp05272c = '<' . $this->ENCRYPT_XML_NODE_NAME . '>'; $sp93c65d = '</' . $this->ENCRYPT_XML_NODE_NAME . '>'; $sp8290e8 = strpos($spf53fbb, $sp93c65d); if ($sp8290e8 < 0) { $sp795ea1 = new EncryptParseItem(); $sp795ea1->encryptContent = null; $sp795ea1->startIndex = 0; $sp795ea1->endIndex = 0; return $sp795ea1; } $sp5535e7 = $sp50acc2 + strlen($sp05272c); $spc9a552 = $sp8290e8 - $sp5535e7; $spe0aa15 = substr($spf53fbb, $sp5535e7, $spc9a552); $sp3d3b49 = new EncryptParseItem(); $sp3d3b49->encryptContent = $spe0aa15; $sp3d3b49->startIndex = $sp50acc2; $sp3d3b49->endIndex = $sp8290e8 + strlen($sp93c65d); return $sp3d3b49; } function echoDebug($sp154c4a) { if ($this->debugInfo) { echo '<br/>' . $sp154c4a; } } }