<?php
require_once 'AopEncrypt.php'; class AopClient { public $appId; public $rsaPrivateKeyFilePath; public $rsaPrivateKey; public $gatewayUrl = 'https://openapi.alipay.com/gateway.do'; public $format = 'json'; public $apiVersion = '1.0'; public $postCharset = 'UTF-8'; public $alipayPublicKey = null; public $alipayrsaPublicKey; public $debugInfo = false; private $fileCharset = 'UTF-8'; private $RESPONSE_SUFFIX = '_response'; private $ERROR_RESPONSE = 'error_response'; private $SIGN_NODE_NAME = 'sign'; private $ENCRYPT_XML_NODE_NAME = 'response_encrypted'; private $needEncrypt = false; public $signType = 'RSA'; public $encryptKey; public $encryptType = 'AES'; protected $alipaySdkVersion = 'alipay-sdk-php-20161101'; public function generateSign($sp31ee10, $sp254b29 = 'RSA') { return $this->sign($this->getSignContent($sp31ee10), $sp254b29); } public function rsaSign($sp31ee10, $sp254b29 = 'RSA') { return $this->sign($this->getSignContent($sp31ee10), $sp254b29); } protected function getSignContent($sp31ee10) { ksort($sp31ee10); $sp7c3d6e = ''; $spcecaa9 = 0; foreach ($sp31ee10 as $spf169bd => $spb83a69) { if (false === $this->checkEmpty($spb83a69) && '@' != substr($spb83a69, 0, 1)) { $spb83a69 = $this->characet($spb83a69, $this->postCharset); if ($spcecaa9 == 0) { $sp7c3d6e .= "{$spf169bd}" . '=' . "{$spb83a69}"; } else { $sp7c3d6e .= '&' . "{$spf169bd}" . '=' . "{$spb83a69}"; } $spcecaa9++; } } unset($spf169bd, $spb83a69); return $sp7c3d6e; } protected function sign($sp94131d, $sp254b29 = 'RSA') { if ($this->checkEmpty($this->rsaPrivateKeyFilePath)) { $sp2c95ab = $this->rsaPrivateKey; $sp904799 = '-----BEGIN RSA PRIVATE KEY-----
' . wordwrap($sp2c95ab, 64, '
', true) . '
-----END RSA PRIVATE KEY-----'; } else { $sp2c95ab = file_get_contents($this->rsaPrivateKeyFilePath); $sp904799 = openssl_get_privatekey($sp2c95ab); } $sp904799 or die('æ‚¨ä½¿ç”¨çš„ç§é’¥æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥RSAç§é’¥é…ç½®'); if ('RSA2' == $sp254b29) { openssl_sign($sp94131d, $sp36c1ea, $sp904799, OPENSSL_ALGO_SHA256); } else { openssl_sign($sp94131d, $sp36c1ea, $sp904799); } if (!$this->checkEmpty($this->rsaPrivateKeyFilePath)) { openssl_free_key($sp904799); } $sp36c1ea = base64_encode($sp36c1ea); return $sp36c1ea; } protected function curl($sp833b34, $spf18ba7 = null) { $speafaa9 = curl_init(); curl_setopt($speafaa9, CURLOPT_URL, $sp833b34); curl_setopt($speafaa9, CURLOPT_FAILONERROR, false); curl_setopt($speafaa9, CURLOPT_RETURNTRANSFER, true); curl_setopt($speafaa9, CURLOPT_SSL_VERIFYPEER, false); $sp112e0e = ''; $spe825cf = array(); $sp97686d = false; if (is_array($spf18ba7) && 0 < count($spf18ba7)) { foreach ($spf18ba7 as $spf169bd => $spb83a69) { if ('@' != substr($spb83a69, 0, 1)) { $sp112e0e .= "{$spf169bd}=" . urlencode($this->characet($spb83a69, $this->postCharset)) . '&'; $spe825cf[$spf169bd] = $this->characet($spb83a69, $this->postCharset); } else { $sp97686d = true; $spe825cf[$spf169bd] = new \CURLFile(substr($spb83a69, 1)); } } unset($spf169bd, $spb83a69); curl_setopt($speafaa9, CURLOPT_POST, true); if ($sp97686d) { curl_setopt($speafaa9, CURLOPT_POSTFIELDS, $spe825cf); } else { curl_setopt($speafaa9, CURLOPT_POSTFIELDS, substr($sp112e0e, 0, -1)); } } if ($sp97686d) { $sp955824 = array('content-type: multipart/form-data;charset=' . $this->postCharset . ';boundary=' . $this->getMillisecond()); } else { $sp955824 = array('content-type: application/x-www-form-urlencoded;charset=' . $this->postCharset); } curl_setopt($speafaa9, CURLOPT_HTTPHEADER, $sp955824); $sp7750f8 = curl_exec($speafaa9); if (curl_errno($speafaa9)) { throw new Exception(curl_error($speafaa9), 0); } else { $sp712a08 = curl_getinfo($speafaa9, CURLINFO_HTTP_CODE); if (200 !== $sp712a08) { throw new Exception($sp7750f8, $sp712a08); } } curl_close($speafaa9); return $sp7750f8; } protected function getMillisecond() { list($sp4d3aca, $sp116636) = explode(' ', microtime()); return (double) sprintf('%.0f', (floatval($sp4d3aca) + floatval($sp116636)) * 1000); } protected function logCommunicationError($spd18938, $spaadc11, $spa7aa00, $spb8a16b) { $sp6a3404 = isset($_SERVER['SERVER_ADDR']) ? $_SERVER['SERVER_ADDR'] : 'CLI'; $spa28602 = new LtLogger(); $spa28602->conf['log_file'] = rtrim(AOP_SDK_WORK_DIR, '\\/') . '/' . 'logs/aop_comm_err_' . $this->appId . '_' . date('Y-m-d') . '.log'; $spa28602->conf['separator'] = '^_^'; $sp7a9aa3 = array(date('Y-m-d H:i:s'), $spd18938, $this->appId, $sp6a3404, PHP_OS, $this->alipaySdkVersion, $spaadc11, $spa7aa00, str_replace('
', '', $spb8a16b)); $spa28602->log($sp7a9aa3); } public function sdkExecute($sp2d83a6) { $this->setupCharsets($sp2d83a6); $sp31ee10['app_id'] = $this->appId; $sp31ee10['method'] = $sp2d83a6->getApiMethodName(); $sp31ee10['format'] = $this->format; $sp31ee10['sign_type'] = $this->signType; $sp31ee10['timestamp'] = date('Y-m-d H:i:s'); $sp31ee10['alipay_sdk'] = $this->alipaySdkVersion; $sp31ee10['charset'] = $this->postCharset; $sp6735ba = $sp2d83a6->getApiVersion(); $sp31ee10['version'] = $this->checkEmpty($sp6735ba) ? $this->apiVersion : $sp6735ba; if ($spbc65a7 = $sp2d83a6->getNotifyUrl()) { $sp31ee10['notify_url'] = $spbc65a7; } $sp67bf8a = $sp2d83a6->getApiParas(); $sp31ee10['biz_content'] = $sp67bf8a['biz_content']; ksort($sp31ee10); $sp31ee10['sign'] = $this->generateSign($sp31ee10, $this->signType); foreach ($sp31ee10 as &$sp308e09) { $sp308e09 = $this->characet($sp308e09, $sp31ee10['charset']); } return http_build_query($sp31ee10); } public function pageExecute($sp2d83a6, $sp7bbc13 = 'POST') { $this->setupCharsets($sp2d83a6); if (strcasecmp($this->fileCharset, $this->postCharset)) { throw new Exception('æ–‡ä»¶ç¼–ç ï¼š[' . $this->fileCharset . '] ä¸Žè¡¨å•æäº¤ç¼–ç ï¼š[' . $this->postCharset . ']ä¸¤è€…ä¸ä¸€è‡´!'); } $sp8ba572 = null; if (!$this->checkEmpty($sp2d83a6->getApiVersion())) { $sp8ba572 = $sp2d83a6->getApiVersion(); } else { $sp8ba572 = $this->apiVersion; } $spa8b551['app_id'] = $this->appId; $spa8b551['version'] = $sp8ba572; $spa8b551['format'] = $this->format; $spa8b551['sign_type'] = $this->signType; $spa8b551['method'] = $sp2d83a6->getApiMethodName(); $spa8b551['timestamp'] = date('Y-m-d H:i:s'); $spa8b551['alipay_sdk'] = $this->alipaySdkVersion; $spa8b551['terminal_type'] = $sp2d83a6->getTerminalType(); $spa8b551['terminal_info'] = $sp2d83a6->getTerminalInfo(); $spa8b551['prod_code'] = $sp2d83a6->getProdCode(); $spa8b551['notify_url'] = $sp2d83a6->getNotifyUrl(); $spa8b551['return_url'] = $sp2d83a6->getReturnUrl(); $spa8b551['charset'] = $this->postCharset; $spb11fdc = $sp2d83a6->getApiParas(); if (method_exists($sp2d83a6, 'getNeedEncrypt') && $sp2d83a6->getNeedEncrypt()) { $spa8b551['encrypt_type'] = $this->encryptType; if ($this->checkEmpty($spb11fdc['biz_content'])) { throw new Exception(' api request Fail! The reason : encrypt request is not supperted!'); } if ($this->checkEmpty($this->encryptKey) || $this->checkEmpty($this->encryptType)) { throw new Exception(' encryptType and encryptKey must not null! '); } if ('AES' != $this->encryptType) { throw new Exception('åŠ å¯†ç±»åž‹åªæ”¯æŒAES'); } $spf241f1 = aliqr_encrypt($spb11fdc['biz_content'], $this->encryptKey); $spb11fdc['biz_content'] = $spf241f1; } $spd3f849 = array_merge($spb11fdc, $spa8b551); $spc2a296 = $this->getSignContent($spd3f849); $spd3f849['sign'] = $this->generateSign($spd3f849, $this->signType); if ('GET' == $sp7bbc13) { $spaadc11 = $this->gatewayUrl . '?' . $spc2a296 . '&sign=' . urlencode($spd3f849['sign']); return $spaadc11; } else { return $this->buildRequestForm($spd3f849); } } protected function buildRequestForm($spd42b29) { $spa6fcfd = '<form id=\'alipaysubmit\' name=\'alipaysubmit\' action=\'' . $this->gatewayUrl . '?charset=' . trim($this->postCharset) . '\' method=\'POST\'>'; while (list($sp63ae76, $sp679ba2) = each($spd42b29)) { if (false === $this->checkEmpty($sp679ba2)) { $sp679ba2 = str_replace('\'', '&apos;', $sp679ba2); $spa6fcfd .= '<input type=\'hidden\' name=\'' . $sp63ae76 . '\' value=\'' . $sp679ba2 . '\'/>'; } } $spa6fcfd = $spa6fcfd . '<input type=\'submit\' value=\'ok\' style=\'display:none;\'\'></form>'; $spa6fcfd = $spa6fcfd . '<script>document.forms[\'alipaysubmit\'].submit();</script>'; return $spa6fcfd; } public function execute($sp2d83a6, $spcd5c6d = null, $sp05ab50 = null) { $this->setupCharsets($sp2d83a6); if (strcasecmp($this->fileCharset, $this->postCharset)) { throw new Exception('æ–‡ä»¶ç¼–ç ï¼š[' . $this->fileCharset . '] ä¸Žè¡¨å•æäº¤ç¼–ç ï¼š[' . $this->postCharset . ']ä¸¤è€…ä¸ä¸€è‡´!'); } $sp8ba572 = null; if (!$this->checkEmpty($sp2d83a6->getApiVersion())) { $sp8ba572 = $sp2d83a6->getApiVersion(); } else { $sp8ba572 = $this->apiVersion; } $spa8b551['app_id'] = $this->appId; $spa8b551['version'] = $sp8ba572; $spa8b551['format'] = $this->format; $spa8b551['sign_type'] = $this->signType; $spa8b551['method'] = $sp2d83a6->getApiMethodName(); $spa8b551['timestamp'] = date('Y-m-d H:i:s'); $spa8b551['auth_token'] = $spcd5c6d; $spa8b551['alipay_sdk'] = $this->alipaySdkVersion; $spa8b551['terminal_type'] = $sp2d83a6->getTerminalType(); $spa8b551['terminal_info'] = $sp2d83a6->getTerminalInfo(); $spa8b551['prod_code'] = $sp2d83a6->getProdCode(); $spa8b551['notify_url'] = $sp2d83a6->getNotifyUrl(); $spa8b551['charset'] = $this->postCharset; $spa8b551['app_auth_token'] = $sp05ab50; $spb11fdc = $sp2d83a6->getApiParas(); if (method_exists($sp2d83a6, 'getNeedEncrypt') && $sp2d83a6->getNeedEncrypt()) { $spa8b551['encrypt_type'] = $this->encryptType; if ($this->checkEmpty($spb11fdc['biz_content'])) { throw new Exception(' api request Fail! The reason : encrypt request is not supperted!'); } if ($this->checkEmpty($this->encryptKey) || $this->checkEmpty($this->encryptType)) { throw new Exception(' encryptType and encryptKey must not null! '); } if ('AES' != $this->encryptType) { throw new Exception('åŠ å¯†ç±»åž‹åªæ”¯æŒAES'); } $spf241f1 = aliqr_encrypt($spb11fdc['biz_content'], $this->encryptKey); $spb11fdc['biz_content'] = $spf241f1; } $spa8b551['sign'] = $this->generateSign(array_merge($spb11fdc, $spa8b551), $this->signType); $spaadc11 = $this->gatewayUrl . '?'; foreach ($spa8b551 as $sp52c98e => $spd99fea) { $spaadc11 .= "{$sp52c98e}=" . urlencode($this->characet($spd99fea, $this->postCharset)) . '&'; } $spaadc11 = substr($spaadc11, 0, -1); try { $sp131c0f = $this->curl($spaadc11, $spb11fdc); } catch (Exception $spfda1c7) { $this->logCommunicationError($spa8b551['method'], $spaadc11, 'HTTP_ERROR_' . $spfda1c7->getCode(), $spfda1c7->getMessage()); return false; } $sp9a028d = false; $sp7713fd = iconv($this->postCharset, $this->fileCharset . '//IGNORE', $sp131c0f); $sp2e3f4a = null; if ('json' == $this->format) { $sp84ec22 = json_decode($sp7713fd); if (null !== $sp84ec22) { $sp9a028d = true; $sp2e3f4a = $this->parserJSONSignData($sp2d83a6, $sp131c0f, $sp84ec22); } } else { if ('xml' == $this->format) { $sp84ec22 = @simplexml_load_string($sp131c0f); if (false !== $sp84ec22) { $sp9a028d = true; $sp2e3f4a = $this->parserXMLSignData($sp2d83a6, $sp131c0f); } } } if (false === $sp9a028d) { $this->logCommunicationError($spa8b551['method'], $spaadc11, 'HTTP_RESPONSE_NOT_WELL_FORMED', $sp131c0f); return false; } $this->checkResponseSign($sp2d83a6, $sp2e3f4a, $sp131c0f, $sp84ec22); if (method_exists($sp2d83a6, 'getNeedEncrypt') && $sp2d83a6->getNeedEncrypt()) { if ('json' == $this->format) { $sp131c0f = $this->encryptJSONSignSource($sp2d83a6, $sp131c0f); $sp7713fd = iconv($this->postCharset, $this->fileCharset . '//IGNORE', $sp131c0f); $sp84ec22 = json_decode($sp7713fd); } else { $sp131c0f = $this->encryptXMLSignSource($sp2d83a6, $sp131c0f); $sp7713fd = iconv($this->postCharset, $this->fileCharset . '//IGNORE', $sp131c0f); $sp84ec22 = @simplexml_load_string($sp7713fd); } } return $sp84ec22; } function characet($sp94131d, $spa901b1) { if (!empty($sp94131d)) { $spa78c2e = $this->fileCharset; if (strcasecmp($spa78c2e, $spa901b1) != 0) { $sp94131d = mb_convert_encoding($sp94131d, $spa901b1, $spa78c2e); } } return $sp94131d; } public function exec($spd93ec3) { if (!isset($spd93ec3['method'])) { trigger_error('No api name passed'); } $sp5048d3 = new LtInflector(); $sp5048d3->conf['separator'] = '.'; $spe4a11c = ucfirst($sp5048d3->camelize(substr($spd93ec3['method'], 7))) . 'Request'; if (!class_exists($spe4a11c)) { trigger_error('No such api: ' . $spd93ec3['method']); } $sp4042ef = isset($spd93ec3['session']) ? $spd93ec3['session'] : null; $sp266ee2 = new $spe4a11c(); foreach ($spd93ec3 as $sp4e4a86 => $sp8c9fcb) { $sp5048d3->conf['separator'] = '_'; $sp672600 = $sp5048d3->camelize($sp4e4a86); $sp5048d3->conf['separator'] = '.'; $sp672600 = 'set' . $sp5048d3->camelize($sp672600); if (method_exists($sp266ee2, $sp672600)) { $sp266ee2->{$sp672600}($sp8c9fcb); } } return $this->execute($sp266ee2, $sp4042ef); } protected function checkEmpty($sp308e09) { if (!isset($sp308e09)) { return true; } if ($sp308e09 === null) { return true; } if (trim($sp308e09) === '') { return true; } return false; } public function rsaCheckV1($sp31ee10, $sp31f730, $sp254b29 = 'RSA') { $sp36c1ea = $sp31ee10['sign']; $sp31ee10['sign_type'] = null; $sp31ee10['sign'] = null; return $this->verify($this->getSignContent($sp31ee10), $sp36c1ea, $sp31f730, $sp254b29); } public function rsaCheckV2($sp31ee10, $sp31f730, $sp254b29 = 'RSA') { print_r($sp31ee10); $sp36c1ea = $sp31ee10['sign']; $sp31ee10['sign'] = null; return $this->verify($this->getSignContent($sp31ee10), $sp36c1ea, $sp31f730, $sp254b29); } function verify($sp94131d, $sp36c1ea, $sp31f730, $sp254b29 = 'RSA') { if ($this->checkEmpty($this->alipayPublicKey)) { $sp9ce40b = $this->alipayrsaPublicKey; $sp904799 = '-----BEGIN PUBLIC KEY-----
' . wordwrap($sp9ce40b, 64, '
', true) . '
-----END PUBLIC KEY-----'; } else { $sp9ce40b = file_get_contents($sp31f730); $sp904799 = openssl_get_publickey($sp9ce40b); } $sp904799 or die('æ”¯ä»˜å®RSAå…¬é’¥é”™è¯¯ã€‚è¯·æ£€æŸ¥å…¬é’¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®'); if ('RSA2' == $sp254b29) { $sp836ce6 = (bool) openssl_verify($sp94131d, base64_decode($sp36c1ea), $sp904799, OPENSSL_ALGO_SHA256); } else { $sp836ce6 = (bool) openssl_verify($sp94131d, base64_decode($sp36c1ea), $sp904799); } if (!$this->checkEmpty($this->alipayPublicKey)) { openssl_free_key($sp904799); } return $sp836ce6; } public function checkSignAndDecrypt($sp31ee10, $sp0ef89e, $sp8e7b28, $sp397c9c, $sp5d2dc5) { $sped661f = $sp31ee10['charset']; $sp4b3179 = $sp31ee10['biz_content']; if ($sp397c9c) { if (!$this->rsaCheckV2($sp31ee10, $sp0ef89e)) { echo '<br/>checkSign failure<br/>'; die; } } if ($sp5d2dc5) { return $this->rsaDecrypt($sp4b3179, $sp8e7b28, $sped661f); } return $sp4b3179; } public function encryptAndSign($sp4b3179, $sp0ef89e, $sp8e7b28, $sped661f, $sp35b7ac, $sp6f7a0b) { if ($sp35b7ac && $sp6f7a0b) { $sp51fd4e = $this->rsaEncrypt($sp4b3179, $sp0ef89e, $sped661f); $sp36c1ea = $this->sign($sp4b3179); $spfd13d8 = "<?xml version=\"1.0\" encoding=\"{$sped661f}\"?><alipay><response>{$sp51fd4e}</response><encryption_type>RSA</encryption_type><sign>{$sp36c1ea}</sign><sign_type>RSA</sign_type></alipay>"; return $spfd13d8; } if ($sp35b7ac && !$sp6f7a0b) { $sp51fd4e = $this->rsaEncrypt($sp4b3179, $sp0ef89e, $sped661f); $spfd13d8 = "<?xml version=\"1.0\" encoding=\"{$sped661f}\"?><alipay><response>{$sp51fd4e}</response><encryption_type>RSA</encryption_type></alipay>"; return $spfd13d8; } if (!$sp35b7ac && $sp6f7a0b) { $sp36c1ea = $this->sign($sp4b3179); $spfd13d8 = "<?xml version=\"1.0\" encoding=\"{$sped661f}\"?><alipay><response>{$sp4b3179}</response><sign>{$sp36c1ea}</sign><sign_type>RSA</sign_type></alipay>"; return $spfd13d8; } $spfd13d8 = "<?xml version=\"1.0\" encoding=\"{$sped661f}\"?>{$sp4b3179}"; return $spfd13d8; } public function rsaEncrypt($sp94131d, $sp0ef89e, $sped661f) { $sp9ce40b = file_get_contents($sp0ef89e); $sp904799 = openssl_get_publickey($sp9ce40b); $sp6d4716 = $this->splitCN($sp94131d, 0, 30, $sped661f); $spb64b5b = null; $sp7e56fc = array(); foreach ($sp6d4716 as $spc42437 => $sp99a130) { if (!openssl_public_encrypt($sp99a130, $spb64b5b, $sp904799)) { echo '<br/>' . openssl_error_string() . '<br/>'; } $sp38bf2d[] = $spb64b5b; } $sp7f2705 = implode(',', $sp38bf2d); return $sp7f2705; } public function rsaDecrypt($sp94131d, $sp8e7b28, $sped661f) { $sp2c95ab = file_get_contents($sp8e7b28); $sp904799 = openssl_get_privatekey($sp2c95ab); $sped215f = explode(',', $sp94131d); $sp9f8301 = ''; $sp6186e9 = ''; foreach ($sped215f as $spc42437 => $sp112f43) { if (!openssl_private_decrypt($sp112f43, $sp6186e9, $sp904799)) { echo '<br/>' . openssl_error_string() . '<br/>'; } $sp9f8301 .= $sp6186e9; } return $sp9f8301; } function splitCN($sp8a4262, $spc42437 = 0, $sp2b70c9, $sped661f) { $sp2ca01d = array(); for ($spcecaa9 = $spc42437; $spcecaa9 < strlen($sp8a4262); $spcecaa9 += $sp2b70c9) { $sp904799 = $this->subCNchar($sp8a4262, $spcecaa9, $sp2b70c9, $sped661f); if (!empty($sp904799)) { $sp2ca01d[] = $sp904799; } } return $sp2ca01d; } function subCNchar($spf6683b, $sp6c75e7 = 0, $sp6f7e8a, $sped661f = 'gbk') { if (strlen($spf6683b) <= $sp6f7e8a) { return $spf6683b; } $sp3b254d['utf-8'] = '/[-]|[Â-ß][€-¿]|[à-ï][€-¿]{2}|[ð-ÿ][€-¿]{3}/'; $sp3b254d['gb2312'] = '/[-]|[°-÷][ -þ]/'; $sp3b254d['gbk'] = '/[-]|[-þ][@-þ]/'; $sp3b254d['big5'] = '/[-]|[-þ]([@-~]|¡-þ])/'; preg_match_all($sp3b254d[$sped661f], $spf6683b, $sp944a5f); $sp4f7bdc = join('', array_slice($sp944a5f[0], $sp6c75e7, $sp6f7e8a)); return $sp4f7bdc; } function parserResponseSubCode($sp2d83a6, $sp9e36ec, $sp84ec22, $sp76cfc0) { if ('json' == $sp76cfc0) { $spd18938 = $sp2d83a6->getApiMethodName(); $spc07d12 = str_replace('.', '_', $spd18938) . $this->RESPONSE_SUFFIX; $sp343318 = $this->ERROR_RESPONSE; $sp5a1f97 = strpos($sp9e36ec, $spc07d12); $spfa22f4 = strpos($sp9e36ec, $sp343318); if ($sp5a1f97 > 0) { $sp59373a = $sp84ec22->{$spc07d12}; } elseif ($spfa22f4 > 0) { $sp59373a = $sp84ec22->{$sp343318}; } else { return null; } if (isset($sp59373a->sub_code)) { return $sp59373a->sub_code; } else { return null; } } elseif ('xml' == $sp76cfc0) { return $sp84ec22->sub_code; } } function parserJSONSignData($sp2d83a6, $sp9e36ec, $spde2426) { $sp2e3f4a = new SignData(); $sp2e3f4a->sign = $this->parserJSONSign($spde2426); $sp2e3f4a->signSourceData = $this->parserJSONSignSource($sp2d83a6, $sp9e36ec); return $sp2e3f4a; } function parserJSONSignSource($sp2d83a6, $sp9e36ec) { $spd18938 = $sp2d83a6->getApiMethodName(); $spc07d12 = str_replace('.', '_', $spd18938) . $this->RESPONSE_SUFFIX; $sp5a1f97 = strpos($sp9e36ec, $spc07d12); $spfa22f4 = strpos($sp9e36ec, $this->ERROR_RESPONSE); if ($sp5a1f97 > 0) { return $this->parserJSONSource($sp9e36ec, $spc07d12, $sp5a1f97); } else { if ($spfa22f4 > 0) { return $this->parserJSONSource($sp9e36ec, $this->ERROR_RESPONSE, $spfa22f4); } else { return null; } } } function parserJSONSource($sp9e36ec, $sp90169c, $sp8f81ba) { $sp8f196a = $sp8f81ba + strlen($sp90169c) + 2; $spc9c52a = strpos($sp9e36ec, '"' . $this->SIGN_NODE_NAME . '"'); $spbd9936 = $spc9c52a - 1; $spf8348b = $spbd9936 - $sp8f196a; if ($spf8348b < 0) { return null; } return substr($sp9e36ec, $sp8f196a, $spf8348b); } function parserJSONSign($spea19f6) { return $spea19f6->sign; } function parserXMLSignData($sp2d83a6, $sp9e36ec) { $sp2e3f4a = new SignData(); $sp2e3f4a->sign = $this->parserXMLSign($sp9e36ec); $sp2e3f4a->signSourceData = $this->parserXMLSignSource($sp2d83a6, $sp9e36ec); return $sp2e3f4a; } function parserXMLSignSource($sp2d83a6, $sp9e36ec) { $spd18938 = $sp2d83a6->getApiMethodName(); $spc07d12 = str_replace('.', '_', $spd18938) . $this->RESPONSE_SUFFIX; $sp5a1f97 = strpos($sp9e36ec, $spc07d12); $spfa22f4 = strpos($sp9e36ec, $this->ERROR_RESPONSE); if ($sp5a1f97 > 0) { return $this->parserXMLSource($sp9e36ec, $spc07d12, $sp5a1f97); } else { if ($spfa22f4 > 0) { return $this->parserXMLSource($sp9e36ec, $this->ERROR_RESPONSE, $spfa22f4); } else { return null; } } } function parserXMLSource($sp9e36ec, $sp90169c, $sp8f81ba) { $sp8f196a = $sp8f81ba + strlen($sp90169c) + 1; $spc9c52a = strpos($sp9e36ec, '<' . $this->SIGN_NODE_NAME . '>'); $spbd9936 = $spc9c52a - 1; $spf8348b = $spbd9936 - $sp8f196a + 1; if ($spf8348b < 0) { return null; } return substr($sp9e36ec, $sp8f196a, $spf8348b); } function parserXMLSign($sp9e36ec) { $spca1a72 = '<' . $this->SIGN_NODE_NAME . '>'; $spca04d9 = '</' . $this->SIGN_NODE_NAME . '>'; $spbfdc2a = strpos($sp9e36ec, $spca1a72); $spc8b27c = strpos($sp9e36ec, $spca04d9); if ($spbfdc2a < 0 || $spc8b27c < 0) { return null; } $sp8f81ba = $spbfdc2a + strlen($spca1a72); $spf8348b = $spc8b27c - $sp8f81ba; if ($spf8348b < 0) { return null; } return substr($sp9e36ec, $sp8f81ba, $spf8348b); } public function checkResponseSign($sp2d83a6, $sp2e3f4a, $sp131c0f, $sp84ec22) { if (!$this->checkEmpty($this->alipayPublicKey) || !$this->checkEmpty($this->alipayrsaPublicKey)) { if ($sp2e3f4a == null || $this->checkEmpty($sp2e3f4a->sign) || $this->checkEmpty($sp2e3f4a->signSourceData)) { throw new Exception(' check sign Fail! The reason : signData is Empty'); } $spbb9eb9 = $this->parserResponseSubCode($sp2d83a6, $sp131c0f, $sp84ec22, $this->format); if (!$this->checkEmpty($spbb9eb9) || $this->checkEmpty($spbb9eb9) && !$this->checkEmpty($sp2e3f4a->sign)) { $sp52e56e = $this->verify($sp2e3f4a->signSourceData, $sp2e3f4a->sign, $this->alipayPublicKey, $this->signType); if (!$sp52e56e) { if (strpos($sp2e3f4a->signSourceData, '\\/') > 0) { $sp2e3f4a->signSourceData = str_replace('\\/', '/', $sp2e3f4a->signSourceData); $sp52e56e = $this->verify($sp2e3f4a->signSourceData, $sp2e3f4a->sign, $this->alipayPublicKey, $this->signType); if (!$sp52e56e) { throw new Exception('check sign Fail! [sign=' . $sp2e3f4a->sign . ', signSourceData=' . $sp2e3f4a->signSourceData . ']'); } } else { throw new Exception('check sign Fail! [sign=' . $sp2e3f4a->sign . ', signSourceData=' . $sp2e3f4a->signSourceData . ']'); } } } } } private function setupCharsets($sp2d83a6) { if ($this->checkEmpty($this->postCharset)) { $this->postCharset = 'UTF-8'; } $spf6683b = preg_match('/[\\x80-\\xff]/', $this->appId) ? $this->appId : print_r($sp2d83a6, true); $this->fileCharset = mb_detect_encoding($spf6683b, 'UTF-8, GBK') == 'UTF-8' ? 'UTF-8' : 'GBK'; } private function encryptJSONSignSource($sp2d83a6, $sp9e36ec) { $spf02698 = $this->parserEncryptJSONSignSource($sp2d83a6, $sp9e36ec); $sp64ffd5 = substr($sp9e36ec, 0, $spf02698->startIndex); $spb4147f = substr($sp9e36ec, $spf02698->endIndex, strlen($sp9e36ec) + 1 - $spf02698->endIndex); $sp4b3179 = aliqr_decrypt($spf02698->encryptContent, $this->encryptKey); return $sp64ffd5 . $sp4b3179 . $spb4147f; } private function parserEncryptJSONSignSource($sp2d83a6, $sp9e36ec) { $spd18938 = $sp2d83a6->getApiMethodName(); $spc07d12 = str_replace('.', '_', $spd18938) . $this->RESPONSE_SUFFIX; $sp5a1f97 = strpos($sp9e36ec, $spc07d12); $spfa22f4 = strpos($sp9e36ec, $this->ERROR_RESPONSE); if ($sp5a1f97 > 0) { return $this->parserEncryptJSONItem($sp9e36ec, $spc07d12, $sp5a1f97); } else { if ($spfa22f4 > 0) { return $this->parserEncryptJSONItem($sp9e36ec, $this->ERROR_RESPONSE, $spfa22f4); } else { return null; } } } private function parserEncryptJSONItem($sp9e36ec, $sp90169c, $sp8f81ba) { $sp8f196a = $sp8f81ba + strlen($sp90169c) + 2; $spc9c52a = strpos($sp9e36ec, '"' . $this->SIGN_NODE_NAME . '"'); $spbd9936 = $spc9c52a - 1; if ($spbd9936 < 0) { $spbd9936 = strlen($sp9e36ec) - 1; } $spf8348b = $spbd9936 - $sp8f196a; $sp26fa53 = substr($sp9e36ec, $sp8f196a + 1, $spf8348b - 2); $sp518a1d = new EncryptParseItem(); $sp518a1d->encryptContent = $sp26fa53; $sp518a1d->startIndex = $sp8f196a; $sp518a1d->endIndex = $spbd9936; return $sp518a1d; } private function encryptXMLSignSource($sp2d83a6, $sp9e36ec) { $spf02698 = $this->parserEncryptXMLSignSource($sp2d83a6, $sp9e36ec); $sp64ffd5 = substr($sp9e36ec, 0, $spf02698->startIndex); $spb4147f = substr($sp9e36ec, $spf02698->endIndex, strlen($sp9e36ec) + 1 - $spf02698->endIndex); $sp4b3179 = aliqr_decrypt($spf02698->encryptContent, $this->encryptKey); return $sp64ffd5 . $sp4b3179 . $spb4147f; } private function parserEncryptXMLSignSource($sp2d83a6, $sp9e36ec) { $spd18938 = $sp2d83a6->getApiMethodName(); $spc07d12 = str_replace('.', '_', $spd18938) . $this->RESPONSE_SUFFIX; $sp5a1f97 = strpos($sp9e36ec, $spc07d12); $spfa22f4 = strpos($sp9e36ec, $this->ERROR_RESPONSE); if ($sp5a1f97 > 0) { return $this->parserEncryptXMLItem($sp9e36ec, $spc07d12, $sp5a1f97); } else { if ($spfa22f4 > 0) { return $this->parserEncryptXMLItem($sp9e36ec, $this->ERROR_RESPONSE, $spfa22f4); } else { return null; } } } private function parserEncryptXMLItem($sp9e36ec, $sp90169c, $sp8f81ba) { $sp8f196a = $sp8f81ba + strlen($sp90169c) + 1; $spae82fe = '<' . $this->ENCRYPT_XML_NODE_NAME . '>'; $sp98655d = '</' . $this->ENCRYPT_XML_NODE_NAME . '>'; $sp4b397b = strpos($sp9e36ec, $sp98655d); if ($sp4b397b < 0) { $sp8f5e71 = new EncryptParseItem(); $sp8f5e71->encryptContent = null; $sp8f5e71->startIndex = 0; $sp8f5e71->endIndex = 0; return $sp8f5e71; } $sp042434 = $sp8f196a + strlen($spae82fe); $spe3ebbf = $sp4b397b - $sp042434; $sp4b3179 = substr($sp9e36ec, $sp042434, $spe3ebbf); $sp518a1d = new EncryptParseItem(); $sp518a1d->encryptContent = $sp4b3179; $sp518a1d->startIndex = $sp8f196a; $sp518a1d->endIndex = $sp4b397b + strlen($sp98655d); return $sp518a1d; } function echoDebug($sp9811e7) { if ($this->debugInfo) { echo '<br/>' . $sp9811e7; } } }