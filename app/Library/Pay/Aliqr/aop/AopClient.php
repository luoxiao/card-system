<?php
require_once 'AopEncrypt.php'; class AopClient { public $appId; public $rsaPrivateKeyFilePath; public $rsaPrivateKey; public $gatewayUrl = 'https://openapi.alipay.com/gateway.do'; public $format = 'json'; public $apiVersion = '1.0'; public $postCharset = 'UTF-8'; public $alipayPublicKey = null; public $alipayrsaPublicKey; public $debugInfo = false; private $fileCharset = 'UTF-8'; private $RESPONSE_SUFFIX = '_response'; private $ERROR_RESPONSE = 'error_response'; private $SIGN_NODE_NAME = 'sign'; private $ENCRYPT_XML_NODE_NAME = 'response_encrypted'; private $needEncrypt = false; public $signType = 'RSA'; public $encryptKey; public $encryptType = 'AES'; protected $alipaySdkVersion = 'alipay-sdk-php-20161101'; public function generateSign($spf44b7f, $spb569c8 = 'RSA') { return $this->sign($this->getSignContent($spf44b7f), $spb569c8); } public function rsaSign($spf44b7f, $spb569c8 = 'RSA') { return $this->sign($this->getSignContent($spf44b7f), $spb569c8); } protected function getSignContent($spf44b7f) { ksort($spf44b7f); $spe522ab = ''; $sp836a84 = 0; foreach ($spf44b7f as $sp1e32fe => $sp398610) { if (false === $this->checkEmpty($sp398610) && '@' != substr($sp398610, 0, 1)) { $sp398610 = $this->characet($sp398610, $this->postCharset); if ($sp836a84 == 0) { $spe522ab .= "{$sp1e32fe}" . '=' . "{$sp398610}"; } else { $spe522ab .= '&' . "{$sp1e32fe}" . '=' . "{$sp398610}"; } $sp836a84++; } } unset($sp1e32fe, $sp398610); return $spe522ab; } protected function sign($sp38c5ae, $spb569c8 = 'RSA') { if ($this->checkEmpty($this->rsaPrivateKeyFilePath)) { $sp267097 = $this->rsaPrivateKey; $sp19a4e0 = '-----BEGIN RSA PRIVATE KEY-----
' . wordwrap($sp267097, 64, '
', true) . '
-----END RSA PRIVATE KEY-----'; } else { $sp267097 = file_get_contents($this->rsaPrivateKeyFilePath); $sp19a4e0 = openssl_get_privatekey($sp267097); } $sp19a4e0 or die('æ‚¨ä½¿ç”¨çš„ç§é’¥æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥RSAç§é’¥é…ç½®'); if ('RSA2' == $spb569c8) { openssl_sign($sp38c5ae, $sp885ea3, $sp19a4e0, OPENSSL_ALGO_SHA256); } else { openssl_sign($sp38c5ae, $sp885ea3, $sp19a4e0); } if (!$this->checkEmpty($this->rsaPrivateKeyFilePath)) { openssl_free_key($sp19a4e0); } $sp885ea3 = base64_encode($sp885ea3); return $sp885ea3; } protected function curl($sp7a0d0d, $spb95549 = null) { $spb70507 = curl_init(); curl_setopt($spb70507, CURLOPT_URL, $sp7a0d0d); curl_setopt($spb70507, CURLOPT_FAILONERROR, false); curl_setopt($spb70507, CURLOPT_RETURNTRANSFER, true); curl_setopt($spb70507, CURLOPT_SSL_VERIFYPEER, false); $spbd905a = ''; $sp461175 = array(); $sp374cd6 = false; if (is_array($spb95549) && 0 < count($spb95549)) { foreach ($spb95549 as $sp1e32fe => $sp398610) { if ('@' != substr($sp398610, 0, 1)) { $spbd905a .= "{$sp1e32fe}=" . urlencode($this->characet($sp398610, $this->postCharset)) . '&'; $sp461175[$sp1e32fe] = $this->characet($sp398610, $this->postCharset); } else { $sp374cd6 = true; $sp461175[$sp1e32fe] = new \CURLFile(substr($sp398610, 1)); } } unset($sp1e32fe, $sp398610); curl_setopt($spb70507, CURLOPT_POST, true); if ($sp374cd6) { curl_setopt($spb70507, CURLOPT_POSTFIELDS, $sp461175); } else { curl_setopt($spb70507, CURLOPT_POSTFIELDS, substr($spbd905a, 0, -1)); } } if ($sp374cd6) { $sp21afdb = array('content-type: multipart/form-data;charset=' . $this->postCharset . ';boundary=' . $this->getMillisecond()); } else { $sp21afdb = array('content-type: application/x-www-form-urlencoded;charset=' . $this->postCharset); } curl_setopt($spb70507, CURLOPT_HTTPHEADER, $sp21afdb); $sp83c081 = curl_exec($spb70507); if (curl_errno($spb70507)) { throw new Exception(curl_error($spb70507), 0); } else { $sp217535 = curl_getinfo($spb70507, CURLINFO_HTTP_CODE); if (200 !== $sp217535) { throw new Exception($sp83c081, $sp217535); } } curl_close($spb70507); return $sp83c081; } protected function getMillisecond() { list($spd47e3e, $spf3ab03) = explode(' ', microtime()); return (double) sprintf('%.0f', (floatval($spd47e3e) + floatval($spf3ab03)) * 1000); } protected function logCommunicationError($sp863351, $sp734a97, $sp81a507, $spa8c67c) { $sp8e1ef7 = isset($_SERVER['SERVER_ADDR']) ? $_SERVER['SERVER_ADDR'] : 'CLI'; $sp9fe785 = new LtLogger(); $sp9fe785->conf['log_file'] = rtrim(AOP_SDK_WORK_DIR, '\\/') . '/' . 'logs/aop_comm_err_' . $this->appId . '_' . date('Y-m-d') . '.log'; $sp9fe785->conf['separator'] = '^_^'; $sp14f82a = array(date('Y-m-d H:i:s'), $sp863351, $this->appId, $sp8e1ef7, PHP_OS, $this->alipaySdkVersion, $sp734a97, $sp81a507, str_replace('
', '', $spa8c67c)); $sp9fe785->log($sp14f82a); } public function sdkExecute($sp845342) { $this->setupCharsets($sp845342); $spf44b7f['app_id'] = $this->appId; $spf44b7f['method'] = $sp845342->getApiMethodName(); $spf44b7f['format'] = $this->format; $spf44b7f['sign_type'] = $this->signType; $spf44b7f['timestamp'] = date('Y-m-d H:i:s'); $spf44b7f['alipay_sdk'] = $this->alipaySdkVersion; $spf44b7f['charset'] = $this->postCharset; $sp1fa9d0 = $sp845342->getApiVersion(); $spf44b7f['version'] = $this->checkEmpty($sp1fa9d0) ? $this->apiVersion : $sp1fa9d0; if ($sp23be1c = $sp845342->getNotifyUrl()) { $spf44b7f['notify_url'] = $sp23be1c; } $spca4351 = $sp845342->getApiParas(); $spf44b7f['biz_content'] = $spca4351['biz_content']; ksort($spf44b7f); $spf44b7f['sign'] = $this->generateSign($spf44b7f, $this->signType); foreach ($spf44b7f as &$spffe9f9) { $spffe9f9 = $this->characet($spffe9f9, $spf44b7f['charset']); } return http_build_query($spf44b7f); } public function pageExecute($sp845342, $sp1a2f7b = 'POST') { $this->setupCharsets($sp845342); if (strcasecmp($this->fileCharset, $this->postCharset)) { throw new Exception('æ–‡ä»¶ç¼–ç ï¼š[' . $this->fileCharset . '] ä¸Žè¡¨å•æäº¤ç¼–ç ï¼š[' . $this->postCharset . ']ä¸¤è€…ä¸ä¸€è‡´!'); } $sp5a04cd = null; if (!$this->checkEmpty($sp845342->getApiVersion())) { $sp5a04cd = $sp845342->getApiVersion(); } else { $sp5a04cd = $this->apiVersion; } $sp460be3['app_id'] = $this->appId; $sp460be3['version'] = $sp5a04cd; $sp460be3['format'] = $this->format; $sp460be3['sign_type'] = $this->signType; $sp460be3['method'] = $sp845342->getApiMethodName(); $sp460be3['timestamp'] = date('Y-m-d H:i:s'); $sp460be3['alipay_sdk'] = $this->alipaySdkVersion; $sp460be3['terminal_type'] = $sp845342->getTerminalType(); $sp460be3['terminal_info'] = $sp845342->getTerminalInfo(); $sp460be3['prod_code'] = $sp845342->getProdCode(); $sp460be3['notify_url'] = $sp845342->getNotifyUrl(); $sp460be3['return_url'] = $sp845342->getReturnUrl(); $sp460be3['charset'] = $this->postCharset; $spc75333 = $sp845342->getApiParas(); if (method_exists($sp845342, 'getNeedEncrypt') && $sp845342->getNeedEncrypt()) { $sp460be3['encrypt_type'] = $this->encryptType; if ($this->checkEmpty($spc75333['biz_content'])) { throw new Exception(' api request Fail! The reason : encrypt request is not supperted!'); } if ($this->checkEmpty($this->encryptKey) || $this->checkEmpty($this->encryptType)) { throw new Exception(' encryptType and encryptKey must not null! '); } if ('AES' != $this->encryptType) { throw new Exception('åŠ å¯†ç±»åž‹åªæ”¯æŒAES'); } $spb882e7 = aliqr_encrypt($spc75333['biz_content'], $this->encryptKey); $spc75333['biz_content'] = $spb882e7; } $sp4a0c98 = array_merge($spc75333, $sp460be3); $sped82e7 = $this->getSignContent($sp4a0c98); $sp4a0c98['sign'] = $this->generateSign($sp4a0c98, $this->signType); if ('GET' == $sp1a2f7b) { $sp734a97 = $this->gatewayUrl . '?' . $sped82e7 . '&sign=' . urlencode($sp4a0c98['sign']); return $sp734a97; } else { return $this->buildRequestForm($sp4a0c98); } } protected function buildRequestForm($sp570e90) { $sp567372 = '<form id=\'alipaysubmit\' name=\'alipaysubmit\' action=\'' . $this->gatewayUrl . '?charset=' . trim($this->postCharset) . '\' method=\'POST\'>'; while (list($spa8a71b, $sp3172ba) = each($sp570e90)) { if (false === $this->checkEmpty($sp3172ba)) { $sp3172ba = str_replace('\'', '&apos;', $sp3172ba); $sp567372 .= '<input type=\'hidden\' name=\'' . $spa8a71b . '\' value=\'' . $sp3172ba . '\'/>'; } } $sp567372 = $sp567372 . '<input type=\'submit\' value=\'ok\' style=\'display:none;\'\'></form>'; $sp567372 = $sp567372 . '<script>document.forms[\'alipaysubmit\'].submit();</script>'; return $sp567372; } public function execute($sp845342, $spff58f1 = null, $sp61a796 = null) { $this->setupCharsets($sp845342); if (strcasecmp($this->fileCharset, $this->postCharset)) { throw new Exception('æ–‡ä»¶ç¼–ç ï¼š[' . $this->fileCharset . '] ä¸Žè¡¨å•æäº¤ç¼–ç ï¼š[' . $this->postCharset . ']ä¸¤è€…ä¸ä¸€è‡´!'); } $sp5a04cd = null; if (!$this->checkEmpty($sp845342->getApiVersion())) { $sp5a04cd = $sp845342->getApiVersion(); } else { $sp5a04cd = $this->apiVersion; } $sp460be3['app_id'] = $this->appId; $sp460be3['version'] = $sp5a04cd; $sp460be3['format'] = $this->format; $sp460be3['sign_type'] = $this->signType; $sp460be3['method'] = $sp845342->getApiMethodName(); $sp460be3['timestamp'] = date('Y-m-d H:i:s'); $sp460be3['auth_token'] = $spff58f1; $sp460be3['alipay_sdk'] = $this->alipaySdkVersion; $sp460be3['terminal_type'] = $sp845342->getTerminalType(); $sp460be3['terminal_info'] = $sp845342->getTerminalInfo(); $sp460be3['prod_code'] = $sp845342->getProdCode(); $sp460be3['notify_url'] = $sp845342->getNotifyUrl(); $sp460be3['charset'] = $this->postCharset; $sp460be3['app_auth_token'] = $sp61a796; $spc75333 = $sp845342->getApiParas(); if (method_exists($sp845342, 'getNeedEncrypt') && $sp845342->getNeedEncrypt()) { $sp460be3['encrypt_type'] = $this->encryptType; if ($this->checkEmpty($spc75333['biz_content'])) { throw new Exception(' api request Fail! The reason : encrypt request is not supperted!'); } if ($this->checkEmpty($this->encryptKey) || $this->checkEmpty($this->encryptType)) { throw new Exception(' encryptType and encryptKey must not null! '); } if ('AES' != $this->encryptType) { throw new Exception('åŠ å¯†ç±»åž‹åªæ”¯æŒAES'); } $spb882e7 = aliqr_encrypt($spc75333['biz_content'], $this->encryptKey); $spc75333['biz_content'] = $spb882e7; } $sp460be3['sign'] = $this->generateSign(array_merge($spc75333, $sp460be3), $this->signType); $sp734a97 = $this->gatewayUrl . '?'; foreach ($sp460be3 as $sp7034ab => $spb8f071) { $sp734a97 .= "{$sp7034ab}=" . urlencode($this->characet($spb8f071, $this->postCharset)) . '&'; } $sp734a97 = substr($sp734a97, 0, -1); try { $sp0b91ff = $this->curl($sp734a97, $spc75333); } catch (Exception $sp805d3e) { $this->logCommunicationError($sp460be3['method'], $sp734a97, 'HTTP_ERROR_' . $sp805d3e->getCode(), $sp805d3e->getMessage()); return false; } $sp5ea993 = false; $sp3ece32 = iconv($this->postCharset, $this->fileCharset . '//IGNORE', $sp0b91ff); $sp6d5030 = null; if ('json' == $this->format) { $sp0be99d = json_decode($sp3ece32); if (null !== $sp0be99d) { $sp5ea993 = true; $sp6d5030 = $this->parserJSONSignData($sp845342, $sp0b91ff, $sp0be99d); } } else { if ('xml' == $this->format) { $sp0be99d = @simplexml_load_string($sp0b91ff); if (false !== $sp0be99d) { $sp5ea993 = true; $sp6d5030 = $this->parserXMLSignData($sp845342, $sp0b91ff); } } } if (false === $sp5ea993) { $this->logCommunicationError($sp460be3['method'], $sp734a97, 'HTTP_RESPONSE_NOT_WELL_FORMED', $sp0b91ff); return false; } $this->checkResponseSign($sp845342, $sp6d5030, $sp0b91ff, $sp0be99d); if (method_exists($sp845342, 'getNeedEncrypt') && $sp845342->getNeedEncrypt()) { if ('json' == $this->format) { $sp0b91ff = $this->encryptJSONSignSource($sp845342, $sp0b91ff); $sp3ece32 = iconv($this->postCharset, $this->fileCharset . '//IGNORE', $sp0b91ff); $sp0be99d = json_decode($sp3ece32); } else { $sp0b91ff = $this->encryptXMLSignSource($sp845342, $sp0b91ff); $sp3ece32 = iconv($this->postCharset, $this->fileCharset . '//IGNORE', $sp0b91ff); $sp0be99d = @simplexml_load_string($sp3ece32); } } return $sp0be99d; } function characet($sp38c5ae, $spc77760) { if (!empty($sp38c5ae)) { $spc905b2 = $this->fileCharset; if (strcasecmp($spc905b2, $spc77760) != 0) { $sp38c5ae = mb_convert_encoding($sp38c5ae, $spc77760, $spc905b2); } } return $sp38c5ae; } public function exec($spd11e21) { if (!isset($spd11e21['method'])) { trigger_error('No api name passed'); } $sp55c461 = new LtInflector(); $sp55c461->conf['separator'] = '.'; $spf0eba7 = ucfirst($sp55c461->camelize(substr($spd11e21['method'], 7))) . 'Request'; if (!class_exists($spf0eba7)) { trigger_error('No such api: ' . $spd11e21['method']); } $sp56eb38 = isset($spd11e21['session']) ? $spd11e21['session'] : null; $sp16ff63 = new $spf0eba7(); foreach ($spd11e21 as $sp11abed => $spc7fd8f) { $sp55c461->conf['separator'] = '_'; $sp5dac04 = $sp55c461->camelize($sp11abed); $sp55c461->conf['separator'] = '.'; $sp5dac04 = 'set' . $sp55c461->camelize($sp5dac04); if (method_exists($sp16ff63, $sp5dac04)) { $sp16ff63->{$sp5dac04}($spc7fd8f); } } return $this->execute($sp16ff63, $sp56eb38); } protected function checkEmpty($spffe9f9) { if (!isset($spffe9f9)) { return true; } if ($spffe9f9 === null) { return true; } if (trim($spffe9f9) === '') { return true; } return false; } public function rsaCheckV1($spf44b7f, $sp6712a4, $spb569c8 = 'RSA') { $sp885ea3 = $spf44b7f['sign']; $spf44b7f['sign_type'] = null; $spf44b7f['sign'] = null; return $this->verify($this->getSignContent($spf44b7f), $sp885ea3, $sp6712a4, $spb569c8); } public function rsaCheckV2($spf44b7f, $sp6712a4, $spb569c8 = 'RSA') { print_r($spf44b7f); $sp885ea3 = $spf44b7f['sign']; $spf44b7f['sign'] = null; return $this->verify($this->getSignContent($spf44b7f), $sp885ea3, $sp6712a4, $spb569c8); } function verify($sp38c5ae, $sp885ea3, $sp6712a4, $spb569c8 = 'RSA') { if ($this->checkEmpty($this->alipayPublicKey)) { $sp2fbc19 = $this->alipayrsaPublicKey; $sp19a4e0 = '-----BEGIN PUBLIC KEY-----
' . wordwrap($sp2fbc19, 64, '
', true) . '
-----END PUBLIC KEY-----'; } else { $sp2fbc19 = file_get_contents($sp6712a4); $sp19a4e0 = openssl_get_publickey($sp2fbc19); } $sp19a4e0 or die('æ”¯ä»˜å®RSAå…¬é’¥é”™è¯¯ã€‚è¯·æ£€æŸ¥å…¬é’¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®'); if ('RSA2' == $spb569c8) { $spcc4042 = (bool) openssl_verify($sp38c5ae, base64_decode($sp885ea3), $sp19a4e0, OPENSSL_ALGO_SHA256); } else { $spcc4042 = (bool) openssl_verify($sp38c5ae, base64_decode($sp885ea3), $sp19a4e0); } if (!$this->checkEmpty($this->alipayPublicKey)) { openssl_free_key($sp19a4e0); } return $spcc4042; } public function checkSignAndDecrypt($spf44b7f, $sp98890e, $spe65534, $sp1d788f, $spc235c3) { $spa6120e = $spf44b7f['charset']; $sp336810 = $spf44b7f['biz_content']; if ($sp1d788f) { if (!$this->rsaCheckV2($spf44b7f, $sp98890e)) { echo '<br/>checkSign failure<br/>'; die; } } if ($spc235c3) { return $this->rsaDecrypt($sp336810, $spe65534, $spa6120e); } return $sp336810; } public function encryptAndSign($sp336810, $sp98890e, $spe65534, $spa6120e, $spa32681, $sp93307f) { if ($spa32681 && $sp93307f) { $spd60f4e = $this->rsaEncrypt($sp336810, $sp98890e, $spa6120e); $sp885ea3 = $this->sign($sp336810); $sp73b7ae = "<?xml version=\"1.0\" encoding=\"{$spa6120e}\"?><alipay><response>{$spd60f4e}</response><encryption_type>RSA</encryption_type><sign>{$sp885ea3}</sign><sign_type>RSA</sign_type></alipay>"; return $sp73b7ae; } if ($spa32681 && !$sp93307f) { $spd60f4e = $this->rsaEncrypt($sp336810, $sp98890e, $spa6120e); $sp73b7ae = "<?xml version=\"1.0\" encoding=\"{$spa6120e}\"?><alipay><response>{$spd60f4e}</response><encryption_type>RSA</encryption_type></alipay>"; return $sp73b7ae; } if (!$spa32681 && $sp93307f) { $sp885ea3 = $this->sign($sp336810); $sp73b7ae = "<?xml version=\"1.0\" encoding=\"{$spa6120e}\"?><alipay><response>{$sp336810}</response><sign>{$sp885ea3}</sign><sign_type>RSA</sign_type></alipay>"; return $sp73b7ae; } $sp73b7ae = "<?xml version=\"1.0\" encoding=\"{$spa6120e}\"?>{$sp336810}"; return $sp73b7ae; } public function rsaEncrypt($sp38c5ae, $sp98890e, $spa6120e) { $sp2fbc19 = file_get_contents($sp98890e); $sp19a4e0 = openssl_get_publickey($sp2fbc19); $spc4b030 = $this->splitCN($sp38c5ae, 0, 30, $spa6120e); $sp524423 = null; $spc975ec = array(); foreach ($spc4b030 as $sp0b22c6 => $sp53ba11) { if (!openssl_public_encrypt($sp53ba11, $sp524423, $sp19a4e0)) { echo '<br/>' . openssl_error_string() . '<br/>'; } $sp53acdf[] = $sp524423; } $sp11e87b = implode(',', $sp53acdf); return $sp11e87b; } public function rsaDecrypt($sp38c5ae, $spe65534, $spa6120e) { $sp267097 = file_get_contents($spe65534); $sp19a4e0 = openssl_get_privatekey($sp267097); $sp9c269f = explode(',', $sp38c5ae); $spd248c2 = ''; $sp1f9c6e = ''; foreach ($sp9c269f as $sp0b22c6 => $sp00f62b) { if (!openssl_private_decrypt($sp00f62b, $sp1f9c6e, $sp19a4e0)) { echo '<br/>' . openssl_error_string() . '<br/>'; } $spd248c2 .= $sp1f9c6e; } return $spd248c2; } function splitCN($sp6582ca, $sp0b22c6 = 0, $sp3f793a, $spa6120e) { $spb57e9c = array(); for ($sp836a84 = $sp0b22c6; $sp836a84 < strlen($sp6582ca); $sp836a84 += $sp3f793a) { $sp19a4e0 = $this->subCNchar($sp6582ca, $sp836a84, $sp3f793a, $spa6120e); if (!empty($sp19a4e0)) { $spb57e9c[] = $sp19a4e0; } } return $spb57e9c; } function subCNchar($spfcf742, $spbb5ef3 = 0, $sp287970, $spa6120e = 'gbk') { if (strlen($spfcf742) <= $sp287970) { return $spfcf742; } $spcd3f9c['utf-8'] = '/[-]|[Â-ß][€-¿]|[à-ï][€-¿]{2}|[ð-ÿ][€-¿]{3}/'; $spcd3f9c['gb2312'] = '/[-]|[°-÷][ -þ]/'; $spcd3f9c['gbk'] = '/[-]|[-þ][@-þ]/'; $spcd3f9c['big5'] = '/[-]|[-þ]([@-~]|¡-þ])/'; preg_match_all($spcd3f9c[$spa6120e], $spfcf742, $spf57c79); $spa4215a = join('', array_slice($spf57c79[0], $spbb5ef3, $sp287970)); return $spa4215a; } function parserResponseSubCode($sp845342, $sp26b794, $sp0be99d, $spbbf2b0) { if ('json' == $spbbf2b0) { $sp863351 = $sp845342->getApiMethodName(); $sp46e285 = str_replace('.', '_', $sp863351) . $this->RESPONSE_SUFFIX; $spff132a = $this->ERROR_RESPONSE; $spce47ba = strpos($sp26b794, $sp46e285); $spf659d2 = strpos($sp26b794, $spff132a); if ($spce47ba > 0) { $spe684df = $sp0be99d->{$sp46e285}; } elseif ($spf659d2 > 0) { $spe684df = $sp0be99d->{$spff132a}; } else { return null; } if (isset($spe684df->sub_code)) { return $spe684df->sub_code; } else { return null; } } elseif ('xml' == $spbbf2b0) { return $sp0be99d->sub_code; } } function parserJSONSignData($sp845342, $sp26b794, $spde8342) { $sp6d5030 = new SignData(); $sp6d5030->sign = $this->parserJSONSign($spde8342); $sp6d5030->signSourceData = $this->parserJSONSignSource($sp845342, $sp26b794); return $sp6d5030; } function parserJSONSignSource($sp845342, $sp26b794) { $sp863351 = $sp845342->getApiMethodName(); $sp46e285 = str_replace('.', '_', $sp863351) . $this->RESPONSE_SUFFIX; $spce47ba = strpos($sp26b794, $sp46e285); $spf659d2 = strpos($sp26b794, $this->ERROR_RESPONSE); if ($spce47ba > 0) { return $this->parserJSONSource($sp26b794, $sp46e285, $spce47ba); } else { if ($spf659d2 > 0) { return $this->parserJSONSource($sp26b794, $this->ERROR_RESPONSE, $spf659d2); } else { return null; } } } function parserJSONSource($sp26b794, $sp2157c2, $spdde430) { $sp48e028 = $spdde430 + strlen($sp2157c2) + 2; $spc3cd60 = strpos($sp26b794, '"' . $this->SIGN_NODE_NAME . '"'); $sp9eec73 = $spc3cd60 - 1; $spb32f8f = $sp9eec73 - $sp48e028; if ($spb32f8f < 0) { return null; } return substr($sp26b794, $sp48e028, $spb32f8f); } function parserJSONSign($spbb130a) { return $spbb130a->sign; } function parserXMLSignData($sp845342, $sp26b794) { $sp6d5030 = new SignData(); $sp6d5030->sign = $this->parserXMLSign($sp26b794); $sp6d5030->signSourceData = $this->parserXMLSignSource($sp845342, $sp26b794); return $sp6d5030; } function parserXMLSignSource($sp845342, $sp26b794) { $sp863351 = $sp845342->getApiMethodName(); $sp46e285 = str_replace('.', '_', $sp863351) . $this->RESPONSE_SUFFIX; $spce47ba = strpos($sp26b794, $sp46e285); $spf659d2 = strpos($sp26b794, $this->ERROR_RESPONSE); if ($spce47ba > 0) { return $this->parserXMLSource($sp26b794, $sp46e285, $spce47ba); } else { if ($spf659d2 > 0) { return $this->parserXMLSource($sp26b794, $this->ERROR_RESPONSE, $spf659d2); } else { return null; } } } function parserXMLSource($sp26b794, $sp2157c2, $spdde430) { $sp48e028 = $spdde430 + strlen($sp2157c2) + 1; $spc3cd60 = strpos($sp26b794, '<' . $this->SIGN_NODE_NAME . '>'); $sp9eec73 = $spc3cd60 - 1; $spb32f8f = $sp9eec73 - $sp48e028 + 1; if ($spb32f8f < 0) { return null; } return substr($sp26b794, $sp48e028, $spb32f8f); } function parserXMLSign($sp26b794) { $sp41a7e8 = '<' . $this->SIGN_NODE_NAME . '>'; $spb1a9b0 = '</' . $this->SIGN_NODE_NAME . '>'; $spa51a0d = strpos($sp26b794, $sp41a7e8); $spbf283f = strpos($sp26b794, $spb1a9b0); if ($spa51a0d < 0 || $spbf283f < 0) { return null; } $spdde430 = $spa51a0d + strlen($sp41a7e8); $spb32f8f = $spbf283f - $spdde430; if ($spb32f8f < 0) { return null; } return substr($sp26b794, $spdde430, $spb32f8f); } public function checkResponseSign($sp845342, $sp6d5030, $sp0b91ff, $sp0be99d) { if (!$this->checkEmpty($this->alipayPublicKey) || !$this->checkEmpty($this->alipayrsaPublicKey)) { if ($sp6d5030 == null || $this->checkEmpty($sp6d5030->sign) || $this->checkEmpty($sp6d5030->signSourceData)) { throw new Exception(' check sign Fail! The reason : signData is Empty'); } $sp3a1691 = $this->parserResponseSubCode($sp845342, $sp0b91ff, $sp0be99d, $this->format); if (!$this->checkEmpty($sp3a1691) || $this->checkEmpty($sp3a1691) && !$this->checkEmpty($sp6d5030->sign)) { $sp01006a = $this->verify($sp6d5030->signSourceData, $sp6d5030->sign, $this->alipayPublicKey, $this->signType); if (!$sp01006a) { if (strpos($sp6d5030->signSourceData, '\\/') > 0) { $sp6d5030->signSourceData = str_replace('\\/', '/', $sp6d5030->signSourceData); $sp01006a = $this->verify($sp6d5030->signSourceData, $sp6d5030->sign, $this->alipayPublicKey, $this->signType); if (!$sp01006a) { throw new Exception('check sign Fail! [sign=' . $sp6d5030->sign . ', signSourceData=' . $sp6d5030->signSourceData . ']'); } } else { throw new Exception('check sign Fail! [sign=' . $sp6d5030->sign . ', signSourceData=' . $sp6d5030->signSourceData . ']'); } } } } } private function setupCharsets($sp845342) { if ($this->checkEmpty($this->postCharset)) { $this->postCharset = 'UTF-8'; } $spfcf742 = preg_match('/[\\x80-\\xff]/', $this->appId) ? $this->appId : print_r($sp845342, true); $this->fileCharset = mb_detect_encoding($spfcf742, 'UTF-8, GBK') == 'UTF-8' ? 'UTF-8' : 'GBK'; } private function encryptJSONSignSource($sp845342, $sp26b794) { $sp2d8973 = $this->parserEncryptJSONSignSource($sp845342, $sp26b794); $spd7409a = substr($sp26b794, 0, $sp2d8973->startIndex); $sp8a7581 = substr($sp26b794, $sp2d8973->endIndex, strlen($sp26b794) + 1 - $sp2d8973->endIndex); $sp336810 = aliqr_decrypt($sp2d8973->encryptContent, $this->encryptKey); return $spd7409a . $sp336810 . $sp8a7581; } private function parserEncryptJSONSignSource($sp845342, $sp26b794) { $sp863351 = $sp845342->getApiMethodName(); $sp46e285 = str_replace('.', '_', $sp863351) . $this->RESPONSE_SUFFIX; $spce47ba = strpos($sp26b794, $sp46e285); $spf659d2 = strpos($sp26b794, $this->ERROR_RESPONSE); if ($spce47ba > 0) { return $this->parserEncryptJSONItem($sp26b794, $sp46e285, $spce47ba); } else { if ($spf659d2 > 0) { return $this->parserEncryptJSONItem($sp26b794, $this->ERROR_RESPONSE, $spf659d2); } else { return null; } } } private function parserEncryptJSONItem($sp26b794, $sp2157c2, $spdde430) { $sp48e028 = $spdde430 + strlen($sp2157c2) + 2; $spc3cd60 = strpos($sp26b794, '"' . $this->SIGN_NODE_NAME . '"'); $sp9eec73 = $spc3cd60 - 1; if ($sp9eec73 < 0) { $sp9eec73 = strlen($sp26b794) - 1; } $spb32f8f = $sp9eec73 - $sp48e028; $spab8e93 = substr($sp26b794, $sp48e028 + 1, $spb32f8f - 2); $spc60c8d = new EncryptParseItem(); $spc60c8d->encryptContent = $spab8e93; $spc60c8d->startIndex = $sp48e028; $spc60c8d->endIndex = $sp9eec73; return $spc60c8d; } private function encryptXMLSignSource($sp845342, $sp26b794) { $sp2d8973 = $this->parserEncryptXMLSignSource($sp845342, $sp26b794); $spd7409a = substr($sp26b794, 0, $sp2d8973->startIndex); $sp8a7581 = substr($sp26b794, $sp2d8973->endIndex, strlen($sp26b794) + 1 - $sp2d8973->endIndex); $sp336810 = aliqr_decrypt($sp2d8973->encryptContent, $this->encryptKey); return $spd7409a . $sp336810 . $sp8a7581; } private function parserEncryptXMLSignSource($sp845342, $sp26b794) { $sp863351 = $sp845342->getApiMethodName(); $sp46e285 = str_replace('.', '_', $sp863351) . $this->RESPONSE_SUFFIX; $spce47ba = strpos($sp26b794, $sp46e285); $spf659d2 = strpos($sp26b794, $this->ERROR_RESPONSE); if ($spce47ba > 0) { return $this->parserEncryptXMLItem($sp26b794, $sp46e285, $spce47ba); } else { if ($spf659d2 > 0) { return $this->parserEncryptXMLItem($sp26b794, $this->ERROR_RESPONSE, $spf659d2); } else { return null; } } } private function parserEncryptXMLItem($sp26b794, $sp2157c2, $spdde430) { $sp48e028 = $spdde430 + strlen($sp2157c2) + 1; $spb926be = '<' . $this->ENCRYPT_XML_NODE_NAME . '>'; $sp3dcbf0 = '</' . $this->ENCRYPT_XML_NODE_NAME . '>'; $spf7e397 = strpos($sp26b794, $sp3dcbf0); if ($spf7e397 < 0) { $spb18bb2 = new EncryptParseItem(); $spb18bb2->encryptContent = null; $spb18bb2->startIndex = 0; $spb18bb2->endIndex = 0; return $spb18bb2; } $sp1d4043 = $sp48e028 + strlen($spb926be); $sp3e1a3b = $spf7e397 - $sp1d4043; $sp336810 = substr($sp26b794, $sp1d4043, $sp3e1a3b); $spc60c8d = new EncryptParseItem(); $spc60c8d->encryptContent = $sp336810; $spc60c8d->startIndex = $sp48e028; $spc60c8d->endIndex = $spf7e397 + strlen($sp3dcbf0); return $spc60c8d; } function echoDebug($spdf4cae) { if ($this->debugInfo) { echo '<br/>' . $spdf4cae; } } }