<?php
require_once 'AopEncrypt.php'; class AopClient { public $appId; public $rsaPrivateKeyFilePath; public $rsaPrivateKey; public $gatewayUrl = 'https://openapi.alipay.com/gateway.do'; public $format = 'json'; public $apiVersion = '1.0'; public $postCharset = 'UTF-8'; public $alipayPublicKey = null; public $alipayrsaPublicKey; public $debugInfo = false; private $fileCharset = 'UTF-8'; private $RESPONSE_SUFFIX = '_response'; private $ERROR_RESPONSE = 'error_response'; private $SIGN_NODE_NAME = 'sign'; private $ENCRYPT_XML_NODE_NAME = 'response_encrypted'; private $needEncrypt = false; public $signType = 'RSA'; public $encryptKey; public $encryptType = 'AES'; protected $alipaySdkVersion = 'alipay-sdk-php-20161101'; public function generateSign($sp50fc45, $spad4c33 = 'RSA') { return $this->sign($this->getSignContent($sp50fc45), $spad4c33); } public function rsaSign($sp50fc45, $spad4c33 = 'RSA') { return $this->sign($this->getSignContent($sp50fc45), $spad4c33); } protected function getSignContent($sp50fc45) { ksort($sp50fc45); $spf51493 = ''; $spfae064 = 0; foreach ($sp50fc45 as $sp08a7aa => $sp99652d) { if (false === $this->checkEmpty($sp99652d) && '@' != substr($sp99652d, 0, 1)) { $sp99652d = $this->characet($sp99652d, $this->postCharset); if ($spfae064 == 0) { $spf51493 .= "{$sp08a7aa}" . '=' . "{$sp99652d}"; } else { $spf51493 .= '&' . "{$sp08a7aa}" . '=' . "{$sp99652d}"; } $spfae064++; } } unset($sp08a7aa, $sp99652d); return $spf51493; } protected function sign($sp151100, $spad4c33 = 'RSA') { if ($this->checkEmpty($this->rsaPrivateKeyFilePath)) { $sp1b2d2a = $this->rsaPrivateKey; $spa4652a = '-----BEGIN RSA PRIVATE KEY-----
' . wordwrap($sp1b2d2a, 64, '
', true) . '
-----END RSA PRIVATE KEY-----'; } else { $sp1b2d2a = file_get_contents($this->rsaPrivateKeyFilePath); $spa4652a = openssl_get_privatekey($sp1b2d2a); } $spa4652a or die('æ‚¨ä½¿ç”¨çš„ç§é’¥æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥RSAç§é’¥é…ç½®'); if ('RSA2' == $spad4c33) { openssl_sign($sp151100, $sp26d1d6, $spa4652a, OPENSSL_ALGO_SHA256); } else { openssl_sign($sp151100, $sp26d1d6, $spa4652a); } if (!$this->checkEmpty($this->rsaPrivateKeyFilePath)) { openssl_free_key($spa4652a); } $sp26d1d6 = base64_encode($sp26d1d6); return $sp26d1d6; } protected function curl($sp78f833, $sp1d1057 = null) { $sp7a336f = curl_init(); curl_setopt($sp7a336f, CURLOPT_URL, $sp78f833); curl_setopt($sp7a336f, CURLOPT_FAILONERROR, false); curl_setopt($sp7a336f, CURLOPT_RETURNTRANSFER, true); curl_setopt($sp7a336f, CURLOPT_SSL_VERIFYPEER, false); $sp6aa2bd = ''; $spd7cf8a = array(); $sp1c6263 = false; if (is_array($sp1d1057) && 0 < count($sp1d1057)) { foreach ($sp1d1057 as $sp08a7aa => $sp99652d) { if ('@' != substr($sp99652d, 0, 1)) { $sp6aa2bd .= "{$sp08a7aa}=" . urlencode($this->characet($sp99652d, $this->postCharset)) . '&'; $spd7cf8a[$sp08a7aa] = $this->characet($sp99652d, $this->postCharset); } else { $sp1c6263 = true; $spd7cf8a[$sp08a7aa] = new \CURLFile(substr($sp99652d, 1)); } } unset($sp08a7aa, $sp99652d); curl_setopt($sp7a336f, CURLOPT_POST, true); if ($sp1c6263) { curl_setopt($sp7a336f, CURLOPT_POSTFIELDS, $spd7cf8a); } else { curl_setopt($sp7a336f, CURLOPT_POSTFIELDS, substr($sp6aa2bd, 0, -1)); } } if ($sp1c6263) { $sp8298e9 = array('content-type: multipart/form-data;charset=' . $this->postCharset . ';boundary=' . $this->getMillisecond()); } else { $sp8298e9 = array('content-type: application/x-www-form-urlencoded;charset=' . $this->postCharset); } curl_setopt($sp7a336f, CURLOPT_HTTPHEADER, $sp8298e9); $sp28bb1a = curl_exec($sp7a336f); if (curl_errno($sp7a336f)) { throw new Exception(curl_error($sp7a336f), 0); } else { $sp208d0c = curl_getinfo($sp7a336f, CURLINFO_HTTP_CODE); if (200 !== $sp208d0c) { throw new Exception($sp28bb1a, $sp208d0c); } } curl_close($sp7a336f); return $sp28bb1a; } protected function getMillisecond() { list($spd5fe00, $sp8e45a3) = explode(' ', microtime()); return (double) sprintf('%.0f', (floatval($spd5fe00) + floatval($sp8e45a3)) * 1000); } protected function logCommunicationError($sp2b4f40, $sp5c8cdd, $spc416f8, $spb1e474) { $sp901d93 = isset($_SERVER['SERVER_ADDR']) ? $_SERVER['SERVER_ADDR'] : 'CLI'; $spb4d2fc = new LtLogger(); $spb4d2fc->conf['log_file'] = rtrim(AOP_SDK_WORK_DIR, '\\/') . '/' . 'logs/aop_comm_err_' . $this->appId . '_' . date('Y-m-d') . '.log'; $spb4d2fc->conf['separator'] = '^_^'; $sp38d2b8 = array(date('Y-m-d H:i:s'), $sp2b4f40, $this->appId, $sp901d93, PHP_OS, $this->alipaySdkVersion, $sp5c8cdd, $spc416f8, str_replace('
', '', $spb1e474)); $spb4d2fc->log($sp38d2b8); } public function sdkExecute($spdd9f33) { $this->setupCharsets($spdd9f33); $sp50fc45['app_id'] = $this->appId; $sp50fc45['method'] = $spdd9f33->getApiMethodName(); $sp50fc45['format'] = $this->format; $sp50fc45['sign_type'] = $this->signType; $sp50fc45['timestamp'] = date('Y-m-d H:i:s'); $sp50fc45['alipay_sdk'] = $this->alipaySdkVersion; $sp50fc45['charset'] = $this->postCharset; $sp283726 = $spdd9f33->getApiVersion(); $sp50fc45['version'] = $this->checkEmpty($sp283726) ? $this->apiVersion : $sp283726; if ($spafbd1d = $spdd9f33->getNotifyUrl()) { $sp50fc45['notify_url'] = $spafbd1d; } $spd36047 = $spdd9f33->getApiParas(); $sp50fc45['biz_content'] = $spd36047['biz_content']; ksort($sp50fc45); $sp50fc45['sign'] = $this->generateSign($sp50fc45, $this->signType); foreach ($sp50fc45 as &$spd0bf21) { $spd0bf21 = $this->characet($spd0bf21, $sp50fc45['charset']); } return http_build_query($sp50fc45); } public function pageExecute($spdd9f33, $spdac380 = 'POST') { $this->setupCharsets($spdd9f33); if (strcasecmp($this->fileCharset, $this->postCharset)) { throw new Exception('æ–‡ä»¶ç¼–ç ï¼š[' . $this->fileCharset . '] ä¸Žè¡¨å•æäº¤ç¼–ç ï¼š[' . $this->postCharset . ']ä¸¤è€…ä¸ä¸€è‡´!'); } $sp85dc00 = null; if (!$this->checkEmpty($spdd9f33->getApiVersion())) { $sp85dc00 = $spdd9f33->getApiVersion(); } else { $sp85dc00 = $this->apiVersion; } $sp305d17['app_id'] = $this->appId; $sp305d17['version'] = $sp85dc00; $sp305d17['format'] = $this->format; $sp305d17['sign_type'] = $this->signType; $sp305d17['method'] = $spdd9f33->getApiMethodName(); $sp305d17['timestamp'] = date('Y-m-d H:i:s'); $sp305d17['alipay_sdk'] = $this->alipaySdkVersion; $sp305d17['terminal_type'] = $spdd9f33->getTerminalType(); $sp305d17['terminal_info'] = $spdd9f33->getTerminalInfo(); $sp305d17['prod_code'] = $spdd9f33->getProdCode(); $sp305d17['notify_url'] = $spdd9f33->getNotifyUrl(); $sp305d17['return_url'] = $spdd9f33->getReturnUrl(); $sp305d17['charset'] = $this->postCharset; $sp2bfd7e = $spdd9f33->getApiParas(); if (method_exists($spdd9f33, 'getNeedEncrypt') && $spdd9f33->getNeedEncrypt()) { $sp305d17['encrypt_type'] = $this->encryptType; if ($this->checkEmpty($sp2bfd7e['biz_content'])) { throw new Exception(' api request Fail! The reason : encrypt request is not supperted!'); } if ($this->checkEmpty($this->encryptKey) || $this->checkEmpty($this->encryptType)) { throw new Exception(' encryptType and encryptKey must not null! '); } if ('AES' != $this->encryptType) { throw new Exception('åŠ å¯†ç±»åž‹åªæ”¯æŒAES'); } $sp36e731 = aliqr_encrypt($sp2bfd7e['biz_content'], $this->encryptKey); $sp2bfd7e['biz_content'] = $sp36e731; } $spb90535 = array_merge($sp2bfd7e, $sp305d17); $sp14975b = $this->getSignContent($spb90535); $spb90535['sign'] = $this->generateSign($spb90535, $this->signType); if ('GET' == $spdac380) { $sp5c8cdd = $this->gatewayUrl . '?' . $sp14975b . '&sign=' . urlencode($spb90535['sign']); return $sp5c8cdd; } else { return $this->buildRequestForm($spb90535); } } protected function buildRequestForm($sp1a550c) { $spb9f293 = '<form id=\'alipaysubmit\' name=\'alipaysubmit\' action=\'' . $this->gatewayUrl . '?charset=' . trim($this->postCharset) . '\' method=\'POST\'>'; while (list($spfcd1b0, $sp1f05d8) = each($sp1a550c)) { if (false === $this->checkEmpty($sp1f05d8)) { $sp1f05d8 = str_replace('\'', '&apos;', $sp1f05d8); $spb9f293 .= '<input type=\'hidden\' name=\'' . $spfcd1b0 . '\' value=\'' . $sp1f05d8 . '\'/>'; } } $spb9f293 = $spb9f293 . '<input type=\'submit\' value=\'ok\' style=\'display:none;\'\'></form>'; $spb9f293 = $spb9f293 . '<script>document.forms[\'alipaysubmit\'].submit();</script>'; return $spb9f293; } public function execute($spdd9f33, $sp052db5 = null, $sp38d2dc = null) { $this->setupCharsets($spdd9f33); if (strcasecmp($this->fileCharset, $this->postCharset)) { throw new Exception('æ–‡ä»¶ç¼–ç ï¼š[' . $this->fileCharset . '] ä¸Žè¡¨å•æäº¤ç¼–ç ï¼š[' . $this->postCharset . ']ä¸¤è€…ä¸ä¸€è‡´!'); } $sp85dc00 = null; if (!$this->checkEmpty($spdd9f33->getApiVersion())) { $sp85dc00 = $spdd9f33->getApiVersion(); } else { $sp85dc00 = $this->apiVersion; } $sp305d17['app_id'] = $this->appId; $sp305d17['version'] = $sp85dc00; $sp305d17['format'] = $this->format; $sp305d17['sign_type'] = $this->signType; $sp305d17['method'] = $spdd9f33->getApiMethodName(); $sp305d17['timestamp'] = date('Y-m-d H:i:s'); $sp305d17['auth_token'] = $sp052db5; $sp305d17['alipay_sdk'] = $this->alipaySdkVersion; $sp305d17['terminal_type'] = $spdd9f33->getTerminalType(); $sp305d17['terminal_info'] = $spdd9f33->getTerminalInfo(); $sp305d17['prod_code'] = $spdd9f33->getProdCode(); $sp305d17['notify_url'] = $spdd9f33->getNotifyUrl(); $sp305d17['charset'] = $this->postCharset; $sp305d17['app_auth_token'] = $sp38d2dc; $sp2bfd7e = $spdd9f33->getApiParas(); if (method_exists($spdd9f33, 'getNeedEncrypt') && $spdd9f33->getNeedEncrypt()) { $sp305d17['encrypt_type'] = $this->encryptType; if ($this->checkEmpty($sp2bfd7e['biz_content'])) { throw new Exception(' api request Fail! The reason : encrypt request is not supperted!'); } if ($this->checkEmpty($this->encryptKey) || $this->checkEmpty($this->encryptType)) { throw new Exception(' encryptType and encryptKey must not null! '); } if ('AES' != $this->encryptType) { throw new Exception('åŠ å¯†ç±»åž‹åªæ”¯æŒAES'); } $sp36e731 = aliqr_encrypt($sp2bfd7e['biz_content'], $this->encryptKey); $sp2bfd7e['biz_content'] = $sp36e731; } $sp305d17['sign'] = $this->generateSign(array_merge($sp2bfd7e, $sp305d17), $this->signType); $sp5c8cdd = $this->gatewayUrl . '?'; foreach ($sp305d17 as $sp4ff499 => $sp9a6a57) { $sp5c8cdd .= "{$sp4ff499}=" . urlencode($this->characet($sp9a6a57, $this->postCharset)) . '&'; } $sp5c8cdd = substr($sp5c8cdd, 0, -1); try { $sp742a89 = $this->curl($sp5c8cdd, $sp2bfd7e); } catch (Exception $sp9e5801) { $this->logCommunicationError($sp305d17['method'], $sp5c8cdd, 'HTTP_ERROR_' . $sp9e5801->getCode(), $sp9e5801->getMessage()); return false; } $sp7d2877 = false; $sp9748ce = iconv($this->postCharset, $this->fileCharset . '//IGNORE', $sp742a89); $spda668a = null; if ('json' == $this->format) { $sp7996f2 = json_decode($sp9748ce); if (null !== $sp7996f2) { $sp7d2877 = true; $spda668a = $this->parserJSONSignData($spdd9f33, $sp742a89, $sp7996f2); } } else { if ('xml' == $this->format) { $sp7996f2 = @simplexml_load_string($sp742a89); if (false !== $sp7996f2) { $sp7d2877 = true; $spda668a = $this->parserXMLSignData($spdd9f33, $sp742a89); } } } if (false === $sp7d2877) { $this->logCommunicationError($sp305d17['method'], $sp5c8cdd, 'HTTP_RESPONSE_NOT_WELL_FORMED', $sp742a89); return false; } $this->checkResponseSign($spdd9f33, $spda668a, $sp742a89, $sp7996f2); if (method_exists($spdd9f33, 'getNeedEncrypt') && $spdd9f33->getNeedEncrypt()) { if ('json' == $this->format) { $sp742a89 = $this->encryptJSONSignSource($spdd9f33, $sp742a89); $sp9748ce = iconv($this->postCharset, $this->fileCharset . '//IGNORE', $sp742a89); $sp7996f2 = json_decode($sp9748ce); } else { $sp742a89 = $this->encryptXMLSignSource($spdd9f33, $sp742a89); $sp9748ce = iconv($this->postCharset, $this->fileCharset . '//IGNORE', $sp742a89); $sp7996f2 = @simplexml_load_string($sp9748ce); } } return $sp7996f2; } function characet($sp151100, $spd74e62) { if (!empty($sp151100)) { $sp049167 = $this->fileCharset; if (strcasecmp($sp049167, $spd74e62) != 0) { $sp151100 = mb_convert_encoding($sp151100, $spd74e62, $sp049167); } } return $sp151100; } public function exec($spc34cf5) { if (!isset($spc34cf5['method'])) { trigger_error('No api name passed'); } $spcfcb09 = new LtInflector(); $spcfcb09->conf['separator'] = '.'; $spa9a680 = ucfirst($spcfcb09->camelize(substr($spc34cf5['method'], 7))) . 'Request'; if (!class_exists($spa9a680)) { trigger_error('No such api: ' . $spc34cf5['method']); } $spfe14fc = isset($spc34cf5['session']) ? $spc34cf5['session'] : null; $sp62eb9d = new $spa9a680(); foreach ($spc34cf5 as $sp43e7d3 => $sp9aa456) { $spcfcb09->conf['separator'] = '_'; $sp2ad8f2 = $spcfcb09->camelize($sp43e7d3); $spcfcb09->conf['separator'] = '.'; $sp2ad8f2 = 'set' . $spcfcb09->camelize($sp2ad8f2); if (method_exists($sp62eb9d, $sp2ad8f2)) { $sp62eb9d->{$sp2ad8f2}($sp9aa456); } } return $this->execute($sp62eb9d, $spfe14fc); } protected function checkEmpty($spd0bf21) { if (!isset($spd0bf21)) { return true; } if ($spd0bf21 === null) { return true; } if (trim($spd0bf21) === '') { return true; } return false; } public function rsaCheckV1($sp50fc45, $spba3cd9, $spad4c33 = 'RSA') { $sp26d1d6 = $sp50fc45['sign']; $sp50fc45['sign_type'] = null; $sp50fc45['sign'] = null; return $this->verify($this->getSignContent($sp50fc45), $sp26d1d6, $spba3cd9, $spad4c33); } public function rsaCheckV2($sp50fc45, $spba3cd9, $spad4c33 = 'RSA') { print_r($sp50fc45); $sp26d1d6 = $sp50fc45['sign']; $sp50fc45['sign'] = null; return $this->verify($this->getSignContent($sp50fc45), $sp26d1d6, $spba3cd9, $spad4c33); } function verify($sp151100, $sp26d1d6, $spba3cd9, $spad4c33 = 'RSA') { if ($this->checkEmpty($this->alipayPublicKey)) { $sp5e37a6 = $this->alipayrsaPublicKey; $spa4652a = '-----BEGIN PUBLIC KEY-----
' . wordwrap($sp5e37a6, 64, '
', true) . '
-----END PUBLIC KEY-----'; } else { $sp5e37a6 = file_get_contents($spba3cd9); $spa4652a = openssl_get_publickey($sp5e37a6); } $spa4652a or die('æ”¯ä»˜å®RSAå…¬é’¥é”™è¯¯ã€‚è¯·æ£€æŸ¥å…¬é’¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®'); if ('RSA2' == $spad4c33) { $spc4a98e = (bool) openssl_verify($sp151100, base64_decode($sp26d1d6), $spa4652a, OPENSSL_ALGO_SHA256); } else { $spc4a98e = (bool) openssl_verify($sp151100, base64_decode($sp26d1d6), $spa4652a); } if (!$this->checkEmpty($this->alipayPublicKey)) { openssl_free_key($spa4652a); } return $spc4a98e; } public function checkSignAndDecrypt($sp50fc45, $spd7bacf, $spf48ceb, $spca26ea, $sp352c8d) { $spa7721b = $sp50fc45['charset']; $spd4f863 = $sp50fc45['biz_content']; if ($spca26ea) { if (!$this->rsaCheckV2($sp50fc45, $spd7bacf)) { echo '<br/>checkSign failure<br/>'; die; } } if ($sp352c8d) { return $this->rsaDecrypt($spd4f863, $spf48ceb, $spa7721b); } return $spd4f863; } public function encryptAndSign($spd4f863, $spd7bacf, $spf48ceb, $spa7721b, $sp3c1d19, $spb12925) { if ($sp3c1d19 && $spb12925) { $spf0e4c1 = $this->rsaEncrypt($spd4f863, $spd7bacf, $spa7721b); $sp26d1d6 = $this->sign($spd4f863); $sp1de750 = "<?xml version=\"1.0\" encoding=\"{$spa7721b}\"?><alipay><response>{$spf0e4c1}</response><encryption_type>RSA</encryption_type><sign>{$sp26d1d6}</sign><sign_type>RSA</sign_type></alipay>"; return $sp1de750; } if ($sp3c1d19 && !$spb12925) { $spf0e4c1 = $this->rsaEncrypt($spd4f863, $spd7bacf, $spa7721b); $sp1de750 = "<?xml version=\"1.0\" encoding=\"{$spa7721b}\"?><alipay><response>{$spf0e4c1}</response><encryption_type>RSA</encryption_type></alipay>"; return $sp1de750; } if (!$sp3c1d19 && $spb12925) { $sp26d1d6 = $this->sign($spd4f863); $sp1de750 = "<?xml version=\"1.0\" encoding=\"{$spa7721b}\"?><alipay><response>{$spd4f863}</response><sign>{$sp26d1d6}</sign><sign_type>RSA</sign_type></alipay>"; return $sp1de750; } $sp1de750 = "<?xml version=\"1.0\" encoding=\"{$spa7721b}\"?>{$spd4f863}"; return $sp1de750; } public function rsaEncrypt($sp151100, $spd7bacf, $spa7721b) { $sp5e37a6 = file_get_contents($spd7bacf); $spa4652a = openssl_get_publickey($sp5e37a6); $spda400c = $this->splitCN($sp151100, 0, 30, $spa7721b); $sp76f96f = null; $spcfbd88 = array(); foreach ($spda400c as $sp488699 => $sp5ee6ed) { if (!openssl_public_encrypt($sp5ee6ed, $sp76f96f, $spa4652a)) { echo '<br/>' . openssl_error_string() . '<br/>'; } $sp6d693c[] = $sp76f96f; } $sp20c5c6 = implode(',', $sp6d693c); return $sp20c5c6; } public function rsaDecrypt($sp151100, $spf48ceb, $spa7721b) { $sp1b2d2a = file_get_contents($spf48ceb); $spa4652a = openssl_get_privatekey($sp1b2d2a); $sp0009c4 = explode(',', $sp151100); $spde31a5 = ''; $sp0fc6be = ''; foreach ($sp0009c4 as $sp488699 => $sp624ac7) { if (!openssl_private_decrypt($sp624ac7, $sp0fc6be, $spa4652a)) { echo '<br/>' . openssl_error_string() . '<br/>'; } $spde31a5 .= $sp0fc6be; } return $spde31a5; } function splitCN($sp1502c0, $sp488699 = 0, $sp6b9e6a, $spa7721b) { $sped0ec5 = array(); for ($spfae064 = $sp488699; $spfae064 < strlen($sp1502c0); $spfae064 += $sp6b9e6a) { $spa4652a = $this->subCNchar($sp1502c0, $spfae064, $sp6b9e6a, $spa7721b); if (!empty($spa4652a)) { $sped0ec5[] = $spa4652a; } } return $sped0ec5; } function subCNchar($spdeb044, $sp1024c6 = 0, $spef2f8c, $spa7721b = 'gbk') { if (strlen($spdeb044) <= $spef2f8c) { return $spdeb044; } $spba8c2c['utf-8'] = '/[-]|[Â-ß][€-¿]|[à-ï][€-¿]{2}|[ð-ÿ][€-¿]{3}/'; $spba8c2c['gb2312'] = '/[-]|[°-÷][ -þ]/'; $spba8c2c['gbk'] = '/[-]|[-þ][@-þ]/'; $spba8c2c['big5'] = '/[-]|[-þ]([@-~]|¡-þ])/'; preg_match_all($spba8c2c[$spa7721b], $spdeb044, $sp8b4134); $sp872fed = join('', array_slice($sp8b4134[0], $sp1024c6, $spef2f8c)); return $sp872fed; } function parserResponseSubCode($spdd9f33, $sp0f2202, $sp7996f2, $sp002bbb) { if ('json' == $sp002bbb) { $sp2b4f40 = $spdd9f33->getApiMethodName(); $sp1ffdd1 = str_replace('.', '_', $sp2b4f40) . $this->RESPONSE_SUFFIX; $sp42c765 = $this->ERROR_RESPONSE; $sp560019 = strpos($sp0f2202, $sp1ffdd1); $sp56eb56 = strpos($sp0f2202, $sp42c765); if ($sp560019 > 0) { $sp811873 = $sp7996f2->{$sp1ffdd1}; } elseif ($sp56eb56 > 0) { $sp811873 = $sp7996f2->{$sp42c765}; } else { return null; } if (isset($sp811873->sub_code)) { return $sp811873->sub_code; } else { return null; } } elseif ('xml' == $sp002bbb) { return $sp7996f2->sub_code; } } function parserJSONSignData($spdd9f33, $sp0f2202, $sp0b91f3) { $spda668a = new SignData(); $spda668a->sign = $this->parserJSONSign($sp0b91f3); $spda668a->signSourceData = $this->parserJSONSignSource($spdd9f33, $sp0f2202); return $spda668a; } function parserJSONSignSource($spdd9f33, $sp0f2202) { $sp2b4f40 = $spdd9f33->getApiMethodName(); $sp1ffdd1 = str_replace('.', '_', $sp2b4f40) . $this->RESPONSE_SUFFIX; $sp560019 = strpos($sp0f2202, $sp1ffdd1); $sp56eb56 = strpos($sp0f2202, $this->ERROR_RESPONSE); if ($sp560019 > 0) { return $this->parserJSONSource($sp0f2202, $sp1ffdd1, $sp560019); } else { if ($sp56eb56 > 0) { return $this->parserJSONSource($sp0f2202, $this->ERROR_RESPONSE, $sp56eb56); } else { return null; } } } function parserJSONSource($sp0f2202, $spa0c304, $sp6af816) { $spce0327 = $sp6af816 + strlen($spa0c304) + 2; $sp3e90f4 = strpos($sp0f2202, '"' . $this->SIGN_NODE_NAME . '"'); $sp8010a8 = $sp3e90f4 - 1; $spe78eba = $sp8010a8 - $spce0327; if ($spe78eba < 0) { return null; } return substr($sp0f2202, $spce0327, $spe78eba); } function parserJSONSign($sp515720) { return $sp515720->sign; } function parserXMLSignData($spdd9f33, $sp0f2202) { $spda668a = new SignData(); $spda668a->sign = $this->parserXMLSign($sp0f2202); $spda668a->signSourceData = $this->parserXMLSignSource($spdd9f33, $sp0f2202); return $spda668a; } function parserXMLSignSource($spdd9f33, $sp0f2202) { $sp2b4f40 = $spdd9f33->getApiMethodName(); $sp1ffdd1 = str_replace('.', '_', $sp2b4f40) . $this->RESPONSE_SUFFIX; $sp560019 = strpos($sp0f2202, $sp1ffdd1); $sp56eb56 = strpos($sp0f2202, $this->ERROR_RESPONSE); if ($sp560019 > 0) { return $this->parserXMLSource($sp0f2202, $sp1ffdd1, $sp560019); } else { if ($sp56eb56 > 0) { return $this->parserXMLSource($sp0f2202, $this->ERROR_RESPONSE, $sp56eb56); } else { return null; } } } function parserXMLSource($sp0f2202, $spa0c304, $sp6af816) { $spce0327 = $sp6af816 + strlen($spa0c304) + 1; $sp3e90f4 = strpos($sp0f2202, '<' . $this->SIGN_NODE_NAME . '>'); $sp8010a8 = $sp3e90f4 - 1; $spe78eba = $sp8010a8 - $spce0327 + 1; if ($spe78eba < 0) { return null; } return substr($sp0f2202, $spce0327, $spe78eba); } function parserXMLSign($sp0f2202) { $sp6329e9 = '<' . $this->SIGN_NODE_NAME . '>'; $sp9607cc = '</' . $this->SIGN_NODE_NAME . '>'; $spa8b063 = strpos($sp0f2202, $sp6329e9); $sp673008 = strpos($sp0f2202, $sp9607cc); if ($spa8b063 < 0 || $sp673008 < 0) { return null; } $sp6af816 = $spa8b063 + strlen($sp6329e9); $spe78eba = $sp673008 - $sp6af816; if ($spe78eba < 0) { return null; } return substr($sp0f2202, $sp6af816, $spe78eba); } public function checkResponseSign($spdd9f33, $spda668a, $sp742a89, $sp7996f2) { if (!$this->checkEmpty($this->alipayPublicKey) || !$this->checkEmpty($this->alipayrsaPublicKey)) { if ($spda668a == null || $this->checkEmpty($spda668a->sign) || $this->checkEmpty($spda668a->signSourceData)) { throw new Exception(' check sign Fail! The reason : signData is Empty'); } $sp126d61 = $this->parserResponseSubCode($spdd9f33, $sp742a89, $sp7996f2, $this->format); if (!$this->checkEmpty($sp126d61) || $this->checkEmpty($sp126d61) && !$this->checkEmpty($spda668a->sign)) { $spe9fc02 = $this->verify($spda668a->signSourceData, $spda668a->sign, $this->alipayPublicKey, $this->signType); if (!$spe9fc02) { if (strpos($spda668a->signSourceData, '\\/') > 0) { $spda668a->signSourceData = str_replace('\\/', '/', $spda668a->signSourceData); $spe9fc02 = $this->verify($spda668a->signSourceData, $spda668a->sign, $this->alipayPublicKey, $this->signType); if (!$spe9fc02) { throw new Exception('check sign Fail! [sign=' . $spda668a->sign . ', signSourceData=' . $spda668a->signSourceData . ']'); } } else { throw new Exception('check sign Fail! [sign=' . $spda668a->sign . ', signSourceData=' . $spda668a->signSourceData . ']'); } } } } } private function setupCharsets($spdd9f33) { if ($this->checkEmpty($this->postCharset)) { $this->postCharset = 'UTF-8'; } $spdeb044 = preg_match('/[\\x80-\\xff]/', $this->appId) ? $this->appId : print_r($spdd9f33, true); $this->fileCharset = mb_detect_encoding($spdeb044, 'UTF-8, GBK') == 'UTF-8' ? 'UTF-8' : 'GBK'; } private function encryptJSONSignSource($spdd9f33, $sp0f2202) { $sp3446c9 = $this->parserEncryptJSONSignSource($spdd9f33, $sp0f2202); $sp336c0f = substr($sp0f2202, 0, $sp3446c9->startIndex); $speaf67d = substr($sp0f2202, $sp3446c9->endIndex, strlen($sp0f2202) + 1 - $sp3446c9->endIndex); $spd4f863 = aliqr_decrypt($sp3446c9->encryptContent, $this->encryptKey); return $sp336c0f . $spd4f863 . $speaf67d; } private function parserEncryptJSONSignSource($spdd9f33, $sp0f2202) { $sp2b4f40 = $spdd9f33->getApiMethodName(); $sp1ffdd1 = str_replace('.', '_', $sp2b4f40) . $this->RESPONSE_SUFFIX; $sp560019 = strpos($sp0f2202, $sp1ffdd1); $sp56eb56 = strpos($sp0f2202, $this->ERROR_RESPONSE); if ($sp560019 > 0) { return $this->parserEncryptJSONItem($sp0f2202, $sp1ffdd1, $sp560019); } else { if ($sp56eb56 > 0) { return $this->parserEncryptJSONItem($sp0f2202, $this->ERROR_RESPONSE, $sp56eb56); } else { return null; } } } private function parserEncryptJSONItem($sp0f2202, $spa0c304, $sp6af816) { $spce0327 = $sp6af816 + strlen($spa0c304) + 2; $sp3e90f4 = strpos($sp0f2202, '"' . $this->SIGN_NODE_NAME . '"'); $sp8010a8 = $sp3e90f4 - 1; if ($sp8010a8 < 0) { $sp8010a8 = strlen($sp0f2202) - 1; } $spe78eba = $sp8010a8 - $spce0327; $sp5cce51 = substr($sp0f2202, $spce0327 + 1, $spe78eba - 2); $spe53a77 = new EncryptParseItem(); $spe53a77->encryptContent = $sp5cce51; $spe53a77->startIndex = $spce0327; $spe53a77->endIndex = $sp8010a8; return $spe53a77; } private function encryptXMLSignSource($spdd9f33, $sp0f2202) { $sp3446c9 = $this->parserEncryptXMLSignSource($spdd9f33, $sp0f2202); $sp336c0f = substr($sp0f2202, 0, $sp3446c9->startIndex); $speaf67d = substr($sp0f2202, $sp3446c9->endIndex, strlen($sp0f2202) + 1 - $sp3446c9->endIndex); $spd4f863 = aliqr_decrypt($sp3446c9->encryptContent, $this->encryptKey); return $sp336c0f . $spd4f863 . $speaf67d; } private function parserEncryptXMLSignSource($spdd9f33, $sp0f2202) { $sp2b4f40 = $spdd9f33->getApiMethodName(); $sp1ffdd1 = str_replace('.', '_', $sp2b4f40) . $this->RESPONSE_SUFFIX; $sp560019 = strpos($sp0f2202, $sp1ffdd1); $sp56eb56 = strpos($sp0f2202, $this->ERROR_RESPONSE); if ($sp560019 > 0) { return $this->parserEncryptXMLItem($sp0f2202, $sp1ffdd1, $sp560019); } else { if ($sp56eb56 > 0) { return $this->parserEncryptXMLItem($sp0f2202, $this->ERROR_RESPONSE, $sp56eb56); } else { return null; } } } private function parserEncryptXMLItem($sp0f2202, $spa0c304, $sp6af816) { $spce0327 = $sp6af816 + strlen($spa0c304) + 1; $sp229bd5 = '<' . $this->ENCRYPT_XML_NODE_NAME . '>'; $sp7ea37a = '</' . $this->ENCRYPT_XML_NODE_NAME . '>'; $sp47dcd7 = strpos($sp0f2202, $sp7ea37a); if ($sp47dcd7 < 0) { $spa41ce4 = new EncryptParseItem(); $spa41ce4->encryptContent = null; $spa41ce4->startIndex = 0; $spa41ce4->endIndex = 0; return $spa41ce4; } $sp68980d = $spce0327 + strlen($sp229bd5); $spa25aa3 = $sp47dcd7 - $sp68980d; $spd4f863 = substr($sp0f2202, $sp68980d, $spa25aa3); $spe53a77 = new EncryptParseItem(); $spe53a77->encryptContent = $spd4f863; $spe53a77->startIndex = $spce0327; $spe53a77->endIndex = $sp47dcd7 + strlen($sp7ea37a); return $spe53a77; } function echoDebug($sp05263d) { if ($this->debugInfo) { echo '<br/>' . $sp05263d; } } }