<?php
require_once 'AopEncrypt.php'; class AopClient { public $appId; public $rsaPrivateKeyFilePath; public $rsaPrivateKey; public $gatewayUrl = 'https://openapi.alipay.com/gateway.do'; public $format = 'json'; public $apiVersion = '1.0'; public $postCharset = 'UTF-8'; public $alipayPublicKey = null; public $alipayrsaPublicKey; public $debugInfo = false; private $fileCharset = 'UTF-8'; private $RESPONSE_SUFFIX = '_response'; private $ERROR_RESPONSE = 'error_response'; private $SIGN_NODE_NAME = 'sign'; private $ENCRYPT_XML_NODE_NAME = 'response_encrypted'; private $needEncrypt = false; public $signType = 'RSA'; public $encryptKey; public $encryptType = 'AES'; protected $alipaySdkVersion = 'alipay-sdk-php-20161101'; public function generateSign($spb9d69c, $speac990 = 'RSA') { return $this->sign($this->getSignContent($spb9d69c), $speac990); } public function rsaSign($spb9d69c, $speac990 = 'RSA') { return $this->sign($this->getSignContent($spb9d69c), $speac990); } protected function getSignContent($spb9d69c) { ksort($spb9d69c); $spfb54eb = ''; $sp1b7341 = 0; foreach ($spb9d69c as $spa8af52 => $sp651922) { if (false === $this->checkEmpty($sp651922) && '@' != substr($sp651922, 0, 1)) { $sp651922 = $this->characet($sp651922, $this->postCharset); if ($sp1b7341 == 0) { $spfb54eb .= "{$spa8af52}" . '=' . "{$sp651922}"; } else { $spfb54eb .= '&' . "{$spa8af52}" . '=' . "{$sp651922}"; } $sp1b7341++; } } unset($spa8af52, $sp651922); return $spfb54eb; } protected function sign($sp1835de, $speac990 = 'RSA') { if ($this->checkEmpty($this->rsaPrivateKeyFilePath)) { $spc46b1e = $this->rsaPrivateKey; $sp36d3e9 = '-----BEGIN RSA PRIVATE KEY-----
' . wordwrap($spc46b1e, 64, '
', true) . '
-----END RSA PRIVATE KEY-----'; } else { $spc46b1e = file_get_contents($this->rsaPrivateKeyFilePath); $sp36d3e9 = openssl_get_privatekey($spc46b1e); } $sp36d3e9 or die('æ‚¨ä½¿ç”¨çš„ç§é’¥æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥RSAç§é’¥é…ç½®'); if ('RSA2' == $speac990) { openssl_sign($sp1835de, $sp23eef6, $sp36d3e9, OPENSSL_ALGO_SHA256); } else { openssl_sign($sp1835de, $sp23eef6, $sp36d3e9); } if (!$this->checkEmpty($this->rsaPrivateKeyFilePath)) { openssl_free_key($sp36d3e9); } $sp23eef6 = base64_encode($sp23eef6); return $sp23eef6; } protected function curl($spdfc1ea, $sp087a72 = null) { $spde874d = curl_init(); curl_setopt($spde874d, CURLOPT_URL, $spdfc1ea); curl_setopt($spde874d, CURLOPT_FAILONERROR, false); curl_setopt($spde874d, CURLOPT_RETURNTRANSFER, true); curl_setopt($spde874d, CURLOPT_SSL_VERIFYPEER, false); $sp6e0e31 = ''; $spbbba2a = array(); $sp19846a = false; if (is_array($sp087a72) && 0 < count($sp087a72)) { foreach ($sp087a72 as $spa8af52 => $sp651922) { if ('@' != substr($sp651922, 0, 1)) { $sp6e0e31 .= "{$spa8af52}=" . urlencode($this->characet($sp651922, $this->postCharset)) . '&'; $spbbba2a[$spa8af52] = $this->characet($sp651922, $this->postCharset); } else { $sp19846a = true; $spbbba2a[$spa8af52] = new \CURLFile(substr($sp651922, 1)); } } unset($spa8af52, $sp651922); curl_setopt($spde874d, CURLOPT_POST, true); if ($sp19846a) { curl_setopt($spde874d, CURLOPT_POSTFIELDS, $spbbba2a); } else { curl_setopt($spde874d, CURLOPT_POSTFIELDS, substr($sp6e0e31, 0, -1)); } } if ($sp19846a) { $spdbbeeb = array('content-type: multipart/form-data;charset=' . $this->postCharset . ';boundary=' . $this->getMillisecond()); } else { $spdbbeeb = array('content-type: application/x-www-form-urlencoded;charset=' . $this->postCharset); } curl_setopt($spde874d, CURLOPT_HTTPHEADER, $spdbbeeb); $sp7a19f0 = curl_exec($spde874d); if (curl_errno($spde874d)) { throw new Exception(curl_error($spde874d), 0); } else { $sp3f7471 = curl_getinfo($spde874d, CURLINFO_HTTP_CODE); if (200 !== $sp3f7471) { throw new Exception($sp7a19f0, $sp3f7471); } } curl_close($spde874d); return $sp7a19f0; } protected function getMillisecond() { list($sp889151, $sp9dcf4f) = explode(' ', microtime()); return (double) sprintf('%.0f', (floatval($sp889151) + floatval($sp9dcf4f)) * 1000); } protected function logCommunicationError($spb0ddd2, $sp4eaf9a, $sp351d0d, $spcf074b) { $spc5fe25 = isset($_SERVER['SERVER_ADDR']) ? $_SERVER['SERVER_ADDR'] : 'CLI'; $spd7db99 = new LtLogger(); $spd7db99->conf['log_file'] = rtrim(AOP_SDK_WORK_DIR, '\\/') . '/' . 'logs/aop_comm_err_' . $this->appId . '_' . date('Y-m-d') . '.log'; $spd7db99->conf['separator'] = '^_^'; $sp59b844 = array(date('Y-m-d H:i:s'), $spb0ddd2, $this->appId, $spc5fe25, PHP_OS, $this->alipaySdkVersion, $sp4eaf9a, $sp351d0d, str_replace('
', '', $spcf074b)); $spd7db99->log($sp59b844); } public function sdkExecute($sp0fc69c) { $this->setupCharsets($sp0fc69c); $spb9d69c['app_id'] = $this->appId; $spb9d69c['method'] = $sp0fc69c->getApiMethodName(); $spb9d69c['format'] = $this->format; $spb9d69c['sign_type'] = $this->signType; $spb9d69c['timestamp'] = date('Y-m-d H:i:s'); $spb9d69c['alipay_sdk'] = $this->alipaySdkVersion; $spb9d69c['charset'] = $this->postCharset; $spb091dd = $sp0fc69c->getApiVersion(); $spb9d69c['version'] = $this->checkEmpty($spb091dd) ? $this->apiVersion : $spb091dd; if ($spfe26f8 = $sp0fc69c->getNotifyUrl()) { $spb9d69c['notify_url'] = $spfe26f8; } $sp547a72 = $sp0fc69c->getApiParas(); $spb9d69c['biz_content'] = $sp547a72['biz_content']; ksort($spb9d69c); $spb9d69c['sign'] = $this->generateSign($spb9d69c, $this->signType); foreach ($spb9d69c as &$spb66e06) { $spb66e06 = $this->characet($spb66e06, $spb9d69c['charset']); } return http_build_query($spb9d69c); } public function pageExecute($sp0fc69c, $sp3a30b5 = 'POST') { $this->setupCharsets($sp0fc69c); if (strcasecmp($this->fileCharset, $this->postCharset)) { throw new Exception('æ–‡ä»¶ç¼–ç ï¼š[' . $this->fileCharset . '] ä¸Žè¡¨å•æäº¤ç¼–ç ï¼š[' . $this->postCharset . ']ä¸¤è€…ä¸ä¸€è‡´!'); } $spc2c51b = null; if (!$this->checkEmpty($sp0fc69c->getApiVersion())) { $spc2c51b = $sp0fc69c->getApiVersion(); } else { $spc2c51b = $this->apiVersion; } $sp9961ca['app_id'] = $this->appId; $sp9961ca['version'] = $spc2c51b; $sp9961ca['format'] = $this->format; $sp9961ca['sign_type'] = $this->signType; $sp9961ca['method'] = $sp0fc69c->getApiMethodName(); $sp9961ca['timestamp'] = date('Y-m-d H:i:s'); $sp9961ca['alipay_sdk'] = $this->alipaySdkVersion; $sp9961ca['terminal_type'] = $sp0fc69c->getTerminalType(); $sp9961ca['terminal_info'] = $sp0fc69c->getTerminalInfo(); $sp9961ca['prod_code'] = $sp0fc69c->getProdCode(); $sp9961ca['notify_url'] = $sp0fc69c->getNotifyUrl(); $sp9961ca['return_url'] = $sp0fc69c->getReturnUrl(); $sp9961ca['charset'] = $this->postCharset; $sp04ce15 = $sp0fc69c->getApiParas(); if (method_exists($sp0fc69c, 'getNeedEncrypt') && $sp0fc69c->getNeedEncrypt()) { $sp9961ca['encrypt_type'] = $this->encryptType; if ($this->checkEmpty($sp04ce15['biz_content'])) { throw new Exception(' api request Fail! The reason : encrypt request is not supperted!'); } if ($this->checkEmpty($this->encryptKey) || $this->checkEmpty($this->encryptType)) { throw new Exception(' encryptType and encryptKey must not null! '); } if ('AES' != $this->encryptType) { throw new Exception('åŠ å¯†ç±»åž‹åªæ”¯æŒAES'); } $spb1142b = aliqr_encrypt($sp04ce15['biz_content'], $this->encryptKey); $sp04ce15['biz_content'] = $spb1142b; } $spcbd677 = array_merge($sp04ce15, $sp9961ca); $sp174520 = $this->getSignContent($spcbd677); $spcbd677['sign'] = $this->generateSign($spcbd677, $this->signType); if ('GET' == $sp3a30b5) { $sp4eaf9a = $this->gatewayUrl . '?' . $sp174520 . '&sign=' . urlencode($spcbd677['sign']); return $sp4eaf9a; } else { return $this->buildRequestForm($spcbd677); } } protected function buildRequestForm($sp159e40) { $sp273d5c = '<form id=\'alipaysubmit\' name=\'alipaysubmit\' action=\'' . $this->gatewayUrl . '?charset=' . trim($this->postCharset) . '\' method=\'POST\'>'; while (list($sp9684a3, $spc28c86) = each($sp159e40)) { if (false === $this->checkEmpty($spc28c86)) { $spc28c86 = str_replace('\'', '&apos;', $spc28c86); $sp273d5c .= '<input type=\'hidden\' name=\'' . $sp9684a3 . '\' value=\'' . $spc28c86 . '\'/>'; } } $sp273d5c = $sp273d5c . '<input type=\'submit\' value=\'ok\' style=\'display:none;\'\'></form>'; $sp273d5c = $sp273d5c . '<script>document.forms[\'alipaysubmit\'].submit();</script>'; return $sp273d5c; } public function execute($sp0fc69c, $sp15d646 = null, $sp59b246 = null) { $this->setupCharsets($sp0fc69c); if (strcasecmp($this->fileCharset, $this->postCharset)) { throw new Exception('æ–‡ä»¶ç¼–ç ï¼š[' . $this->fileCharset . '] ä¸Žè¡¨å•æäº¤ç¼–ç ï¼š[' . $this->postCharset . ']ä¸¤è€…ä¸ä¸€è‡´!'); } $spc2c51b = null; if (!$this->checkEmpty($sp0fc69c->getApiVersion())) { $spc2c51b = $sp0fc69c->getApiVersion(); } else { $spc2c51b = $this->apiVersion; } $sp9961ca['app_id'] = $this->appId; $sp9961ca['version'] = $spc2c51b; $sp9961ca['format'] = $this->format; $sp9961ca['sign_type'] = $this->signType; $sp9961ca['method'] = $sp0fc69c->getApiMethodName(); $sp9961ca['timestamp'] = date('Y-m-d H:i:s'); $sp9961ca['auth_token'] = $sp15d646; $sp9961ca['alipay_sdk'] = $this->alipaySdkVersion; $sp9961ca['terminal_type'] = $sp0fc69c->getTerminalType(); $sp9961ca['terminal_info'] = $sp0fc69c->getTerminalInfo(); $sp9961ca['prod_code'] = $sp0fc69c->getProdCode(); $sp9961ca['notify_url'] = $sp0fc69c->getNotifyUrl(); $sp9961ca['charset'] = $this->postCharset; $sp9961ca['app_auth_token'] = $sp59b246; $sp04ce15 = $sp0fc69c->getApiParas(); if (method_exists($sp0fc69c, 'getNeedEncrypt') && $sp0fc69c->getNeedEncrypt()) { $sp9961ca['encrypt_type'] = $this->encryptType; if ($this->checkEmpty($sp04ce15['biz_content'])) { throw new Exception(' api request Fail! The reason : encrypt request is not supperted!'); } if ($this->checkEmpty($this->encryptKey) || $this->checkEmpty($this->encryptType)) { throw new Exception(' encryptType and encryptKey must not null! '); } if ('AES' != $this->encryptType) { throw new Exception('åŠ å¯†ç±»åž‹åªæ”¯æŒAES'); } $spb1142b = aliqr_encrypt($sp04ce15['biz_content'], $this->encryptKey); $sp04ce15['biz_content'] = $spb1142b; } $sp9961ca['sign'] = $this->generateSign(array_merge($sp04ce15, $sp9961ca), $this->signType); $sp4eaf9a = $this->gatewayUrl . '?'; foreach ($sp9961ca as $sp3c1b29 => $sp898f56) { $sp4eaf9a .= "{$sp3c1b29}=" . urlencode($this->characet($sp898f56, $this->postCharset)) . '&'; } $sp4eaf9a = substr($sp4eaf9a, 0, -1); try { $sp60acd7 = $this->curl($sp4eaf9a, $sp04ce15); } catch (Exception $sp2a4a9a) { $this->logCommunicationError($sp9961ca['method'], $sp4eaf9a, 'HTTP_ERROR_' . $sp2a4a9a->getCode(), $sp2a4a9a->getMessage()); return false; } $sp5987fc = false; $spc1e80b = iconv($this->postCharset, $this->fileCharset . '//IGNORE', $sp60acd7); $sp2f2822 = null; if ('json' == $this->format) { $sp4a73bc = json_decode($spc1e80b); if (null !== $sp4a73bc) { $sp5987fc = true; $sp2f2822 = $this->parserJSONSignData($sp0fc69c, $sp60acd7, $sp4a73bc); } } else { if ('xml' == $this->format) { $sp4a73bc = @simplexml_load_string($sp60acd7); if (false !== $sp4a73bc) { $sp5987fc = true; $sp2f2822 = $this->parserXMLSignData($sp0fc69c, $sp60acd7); } } } if (false === $sp5987fc) { $this->logCommunicationError($sp9961ca['method'], $sp4eaf9a, 'HTTP_RESPONSE_NOT_WELL_FORMED', $sp60acd7); return false; } $this->checkResponseSign($sp0fc69c, $sp2f2822, $sp60acd7, $sp4a73bc); if (method_exists($sp0fc69c, 'getNeedEncrypt') && $sp0fc69c->getNeedEncrypt()) { if ('json' == $this->format) { $sp60acd7 = $this->encryptJSONSignSource($sp0fc69c, $sp60acd7); $spc1e80b = iconv($this->postCharset, $this->fileCharset . '//IGNORE', $sp60acd7); $sp4a73bc = json_decode($spc1e80b); } else { $sp60acd7 = $this->encryptXMLSignSource($sp0fc69c, $sp60acd7); $spc1e80b = iconv($this->postCharset, $this->fileCharset . '//IGNORE', $sp60acd7); $sp4a73bc = @simplexml_load_string($spc1e80b); } } return $sp4a73bc; } function characet($sp1835de, $sp3eacbd) { if (!empty($sp1835de)) { $sp002fb4 = $this->fileCharset; if (strcasecmp($sp002fb4, $sp3eacbd) != 0) { $sp1835de = mb_convert_encoding($sp1835de, $sp3eacbd, $sp002fb4); } } return $sp1835de; } public function exec($sp21b33e) { if (!isset($sp21b33e['method'])) { trigger_error('No api name passed'); } $sp98da92 = new LtInflector(); $sp98da92->conf['separator'] = '.'; $sp5900c7 = ucfirst($sp98da92->camelize(substr($sp21b33e['method'], 7))) . 'Request'; if (!class_exists($sp5900c7)) { trigger_error('No such api: ' . $sp21b33e['method']); } $sp6ce94d = isset($sp21b33e['session']) ? $sp21b33e['session'] : null; $sp74b2e1 = new $sp5900c7(); foreach ($sp21b33e as $spa746ef => $spa14be3) { $sp98da92->conf['separator'] = '_'; $sp75fa0a = $sp98da92->camelize($spa746ef); $sp98da92->conf['separator'] = '.'; $sp75fa0a = 'set' . $sp98da92->camelize($sp75fa0a); if (method_exists($sp74b2e1, $sp75fa0a)) { $sp74b2e1->{$sp75fa0a}($spa14be3); } } return $this->execute($sp74b2e1, $sp6ce94d); } protected function checkEmpty($spb66e06) { if (!isset($spb66e06)) { return true; } if ($spb66e06 === null) { return true; } if (trim($spb66e06) === '') { return true; } return false; } public function rsaCheckV1($spb9d69c, $sp17627d, $speac990 = 'RSA') { $sp23eef6 = $spb9d69c['sign']; $spb9d69c['sign_type'] = null; $spb9d69c['sign'] = null; return $this->verify($this->getSignContent($spb9d69c), $sp23eef6, $sp17627d, $speac990); } public function rsaCheckV2($spb9d69c, $sp17627d, $speac990 = 'RSA') { print_r($spb9d69c); $sp23eef6 = $spb9d69c['sign']; $spb9d69c['sign'] = null; return $this->verify($this->getSignContent($spb9d69c), $sp23eef6, $sp17627d, $speac990); } function verify($sp1835de, $sp23eef6, $sp17627d, $speac990 = 'RSA') { if ($this->checkEmpty($this->alipayPublicKey)) { $spc69241 = $this->alipayrsaPublicKey; $sp36d3e9 = '-----BEGIN PUBLIC KEY-----
' . wordwrap($spc69241, 64, '
', true) . '
-----END PUBLIC KEY-----'; } else { $spc69241 = file_get_contents($sp17627d); $sp36d3e9 = openssl_get_publickey($spc69241); } $sp36d3e9 or die('æ”¯ä»˜å®RSAå…¬é’¥é”™è¯¯ã€‚è¯·æ£€æŸ¥å…¬é’¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®'); if ('RSA2' == $speac990) { $spbcb528 = (bool) openssl_verify($sp1835de, base64_decode($sp23eef6), $sp36d3e9, OPENSSL_ALGO_SHA256); } else { $spbcb528 = (bool) openssl_verify($sp1835de, base64_decode($sp23eef6), $sp36d3e9); } if (!$this->checkEmpty($this->alipayPublicKey)) { openssl_free_key($sp36d3e9); } return $spbcb528; } public function checkSignAndDecrypt($spb9d69c, $sp9e34ef, $spa8598b, $sp4890ca, $sp2a1dff) { $spd588b5 = $spb9d69c['charset']; $sp5896e5 = $spb9d69c['biz_content']; if ($sp4890ca) { if (!$this->rsaCheckV2($spb9d69c, $sp9e34ef)) { echo '<br/>checkSign failure<br/>'; die; } } if ($sp2a1dff) { return $this->rsaDecrypt($sp5896e5, $spa8598b, $spd588b5); } return $sp5896e5; } public function encryptAndSign($sp5896e5, $sp9e34ef, $spa8598b, $spd588b5, $spc808c0, $sp3b4a88) { if ($spc808c0 && $sp3b4a88) { $sp063896 = $this->rsaEncrypt($sp5896e5, $sp9e34ef, $spd588b5); $sp23eef6 = $this->sign($sp5896e5); $sp5241d0 = "<?xml version=\"1.0\" encoding=\"{$spd588b5}\"?><alipay><response>{$sp063896}</response><encryption_type>RSA</encryption_type><sign>{$sp23eef6}</sign><sign_type>RSA</sign_type></alipay>"; return $sp5241d0; } if ($spc808c0 && !$sp3b4a88) { $sp063896 = $this->rsaEncrypt($sp5896e5, $sp9e34ef, $spd588b5); $sp5241d0 = "<?xml version=\"1.0\" encoding=\"{$spd588b5}\"?><alipay><response>{$sp063896}</response><encryption_type>RSA</encryption_type></alipay>"; return $sp5241d0; } if (!$spc808c0 && $sp3b4a88) { $sp23eef6 = $this->sign($sp5896e5); $sp5241d0 = "<?xml version=\"1.0\" encoding=\"{$spd588b5}\"?><alipay><response>{$sp5896e5}</response><sign>{$sp23eef6}</sign><sign_type>RSA</sign_type></alipay>"; return $sp5241d0; } $sp5241d0 = "<?xml version=\"1.0\" encoding=\"{$spd588b5}\"?>{$sp5896e5}"; return $sp5241d0; } public function rsaEncrypt($sp1835de, $sp9e34ef, $spd588b5) { $spc69241 = file_get_contents($sp9e34ef); $sp36d3e9 = openssl_get_publickey($spc69241); $sp5e0920 = $this->splitCN($sp1835de, 0, 30, $spd588b5); $sp6e2e32 = null; $sp37825f = array(); foreach ($sp5e0920 as $spc1fee6 => $sp243be7) { if (!openssl_public_encrypt($sp243be7, $sp6e2e32, $sp36d3e9)) { echo '<br/>' . openssl_error_string() . '<br/>'; } $spa00b68[] = $sp6e2e32; } $sp47ef5b = implode(',', $spa00b68); return $sp47ef5b; } public function rsaDecrypt($sp1835de, $spa8598b, $spd588b5) { $spc46b1e = file_get_contents($spa8598b); $sp36d3e9 = openssl_get_privatekey($spc46b1e); $sp53ae41 = explode(',', $sp1835de); $spf24f92 = ''; $sp6397f5 = ''; foreach ($sp53ae41 as $spc1fee6 => $sp384cbc) { if (!openssl_private_decrypt($sp384cbc, $sp6397f5, $sp36d3e9)) { echo '<br/>' . openssl_error_string() . '<br/>'; } $spf24f92 .= $sp6397f5; } return $spf24f92; } function splitCN($sp383076, $spc1fee6 = 0, $spf17716, $spd588b5) { $sp670ee0 = array(); for ($sp1b7341 = $spc1fee6; $sp1b7341 < strlen($sp383076); $sp1b7341 += $spf17716) { $sp36d3e9 = $this->subCNchar($sp383076, $sp1b7341, $spf17716, $spd588b5); if (!empty($sp36d3e9)) { $sp670ee0[] = $sp36d3e9; } } return $sp670ee0; } function subCNchar($spb67857, $sp8e9e98 = 0, $sp58d92e, $spd588b5 = 'gbk') { if (strlen($spb67857) <= $sp58d92e) { return $spb67857; } $sp217ad9['utf-8'] = '/[-]|[Â-ß][€-¿]|[à-ï][€-¿]{2}|[ð-ÿ][€-¿]{3}/'; $sp217ad9['gb2312'] = '/[-]|[°-÷][ -þ]/'; $sp217ad9['gbk'] = '/[-]|[-þ][@-þ]/'; $sp217ad9['big5'] = '/[-]|[-þ]([@-~]|¡-þ])/'; preg_match_all($sp217ad9[$spd588b5], $spb67857, $spdeecfb); $spdb8a90 = join('', array_slice($spdeecfb[0], $sp8e9e98, $sp58d92e)); return $spdb8a90; } function parserResponseSubCode($sp0fc69c, $sp5fe66a, $sp4a73bc, $spe9e29b) { if ('json' == $spe9e29b) { $spb0ddd2 = $sp0fc69c->getApiMethodName(); $sp98c38f = str_replace('.', '_', $spb0ddd2) . $this->RESPONSE_SUFFIX; $spaf1c08 = $this->ERROR_RESPONSE; $sp64d707 = strpos($sp5fe66a, $sp98c38f); $sp02c29f = strpos($sp5fe66a, $spaf1c08); if ($sp64d707 > 0) { $sp38d0bf = $sp4a73bc->{$sp98c38f}; } elseif ($sp02c29f > 0) { $sp38d0bf = $sp4a73bc->{$spaf1c08}; } else { return null; } if (isset($sp38d0bf->sub_code)) { return $sp38d0bf->sub_code; } else { return null; } } elseif ('xml' == $spe9e29b) { return $sp4a73bc->sub_code; } } function parserJSONSignData($sp0fc69c, $sp5fe66a, $spc39dae) { $sp2f2822 = new SignData(); $sp2f2822->sign = $this->parserJSONSign($spc39dae); $sp2f2822->signSourceData = $this->parserJSONSignSource($sp0fc69c, $sp5fe66a); return $sp2f2822; } function parserJSONSignSource($sp0fc69c, $sp5fe66a) { $spb0ddd2 = $sp0fc69c->getApiMethodName(); $sp98c38f = str_replace('.', '_', $spb0ddd2) . $this->RESPONSE_SUFFIX; $sp64d707 = strpos($sp5fe66a, $sp98c38f); $sp02c29f = strpos($sp5fe66a, $this->ERROR_RESPONSE); if ($sp64d707 > 0) { return $this->parserJSONSource($sp5fe66a, $sp98c38f, $sp64d707); } else { if ($sp02c29f > 0) { return $this->parserJSONSource($sp5fe66a, $this->ERROR_RESPONSE, $sp02c29f); } else { return null; } } } function parserJSONSource($sp5fe66a, $spc0e2ad, $sp0f0033) { $spf08491 = $sp0f0033 + strlen($spc0e2ad) + 2; $sp6d85bf = strpos($sp5fe66a, '"' . $this->SIGN_NODE_NAME . '"'); $sp90e55e = $sp6d85bf - 1; $spf5bed6 = $sp90e55e - $spf08491; if ($spf5bed6 < 0) { return null; } return substr($sp5fe66a, $spf08491, $spf5bed6); } function parserJSONSign($sp5363e1) { return $sp5363e1->sign; } function parserXMLSignData($sp0fc69c, $sp5fe66a) { $sp2f2822 = new SignData(); $sp2f2822->sign = $this->parserXMLSign($sp5fe66a); $sp2f2822->signSourceData = $this->parserXMLSignSource($sp0fc69c, $sp5fe66a); return $sp2f2822; } function parserXMLSignSource($sp0fc69c, $sp5fe66a) { $spb0ddd2 = $sp0fc69c->getApiMethodName(); $sp98c38f = str_replace('.', '_', $spb0ddd2) . $this->RESPONSE_SUFFIX; $sp64d707 = strpos($sp5fe66a, $sp98c38f); $sp02c29f = strpos($sp5fe66a, $this->ERROR_RESPONSE); if ($sp64d707 > 0) { return $this->parserXMLSource($sp5fe66a, $sp98c38f, $sp64d707); } else { if ($sp02c29f > 0) { return $this->parserXMLSource($sp5fe66a, $this->ERROR_RESPONSE, $sp02c29f); } else { return null; } } } function parserXMLSource($sp5fe66a, $spc0e2ad, $sp0f0033) { $spf08491 = $sp0f0033 + strlen($spc0e2ad) + 1; $sp6d85bf = strpos($sp5fe66a, '<' . $this->SIGN_NODE_NAME . '>'); $sp90e55e = $sp6d85bf - 1; $spf5bed6 = $sp90e55e - $spf08491 + 1; if ($spf5bed6 < 0) { return null; } return substr($sp5fe66a, $spf08491, $spf5bed6); } function parserXMLSign($sp5fe66a) { $sp51b966 = '<' . $this->SIGN_NODE_NAME . '>'; $spe13eec = '</' . $this->SIGN_NODE_NAME . '>'; $sp638478 = strpos($sp5fe66a, $sp51b966); $spa73cb6 = strpos($sp5fe66a, $spe13eec); if ($sp638478 < 0 || $spa73cb6 < 0) { return null; } $sp0f0033 = $sp638478 + strlen($sp51b966); $spf5bed6 = $spa73cb6 - $sp0f0033; if ($spf5bed6 < 0) { return null; } return substr($sp5fe66a, $sp0f0033, $spf5bed6); } public function checkResponseSign($sp0fc69c, $sp2f2822, $sp60acd7, $sp4a73bc) { if (!$this->checkEmpty($this->alipayPublicKey) || !$this->checkEmpty($this->alipayrsaPublicKey)) { if ($sp2f2822 == null || $this->checkEmpty($sp2f2822->sign) || $this->checkEmpty($sp2f2822->signSourceData)) { throw new Exception(' check sign Fail! The reason : signData is Empty'); } $speedf81 = $this->parserResponseSubCode($sp0fc69c, $sp60acd7, $sp4a73bc, $this->format); if (!$this->checkEmpty($speedf81) || $this->checkEmpty($speedf81) && !$this->checkEmpty($sp2f2822->sign)) { $spb24199 = $this->verify($sp2f2822->signSourceData, $sp2f2822->sign, $this->alipayPublicKey, $this->signType); if (!$spb24199) { if (strpos($sp2f2822->signSourceData, '\\/') > 0) { $sp2f2822->signSourceData = str_replace('\\/', '/', $sp2f2822->signSourceData); $spb24199 = $this->verify($sp2f2822->signSourceData, $sp2f2822->sign, $this->alipayPublicKey, $this->signType); if (!$spb24199) { throw new Exception('check sign Fail! [sign=' . $sp2f2822->sign . ', signSourceData=' . $sp2f2822->signSourceData . ']'); } } else { throw new Exception('check sign Fail! [sign=' . $sp2f2822->sign . ', signSourceData=' . $sp2f2822->signSourceData . ']'); } } } } } private function setupCharsets($sp0fc69c) { if ($this->checkEmpty($this->postCharset)) { $this->postCharset = 'UTF-8'; } $spb67857 = preg_match('/[\\x80-\\xff]/', $this->appId) ? $this->appId : print_r($sp0fc69c, true); $this->fileCharset = mb_detect_encoding($spb67857, 'UTF-8, GBK') == 'UTF-8' ? 'UTF-8' : 'GBK'; } private function encryptJSONSignSource($sp0fc69c, $sp5fe66a) { $spc7e3de = $this->parserEncryptJSONSignSource($sp0fc69c, $sp5fe66a); $sp382597 = substr($sp5fe66a, 0, $spc7e3de->startIndex); $sp3cd842 = substr($sp5fe66a, $spc7e3de->endIndex, strlen($sp5fe66a) + 1 - $spc7e3de->endIndex); $sp5896e5 = aliqr_decrypt($spc7e3de->encryptContent, $this->encryptKey); return $sp382597 . $sp5896e5 . $sp3cd842; } private function parserEncryptJSONSignSource($sp0fc69c, $sp5fe66a) { $spb0ddd2 = $sp0fc69c->getApiMethodName(); $sp98c38f = str_replace('.', '_', $spb0ddd2) . $this->RESPONSE_SUFFIX; $sp64d707 = strpos($sp5fe66a, $sp98c38f); $sp02c29f = strpos($sp5fe66a, $this->ERROR_RESPONSE); if ($sp64d707 > 0) { return $this->parserEncryptJSONItem($sp5fe66a, $sp98c38f, $sp64d707); } else { if ($sp02c29f > 0) { return $this->parserEncryptJSONItem($sp5fe66a, $this->ERROR_RESPONSE, $sp02c29f); } else { return null; } } } private function parserEncryptJSONItem($sp5fe66a, $spc0e2ad, $sp0f0033) { $spf08491 = $sp0f0033 + strlen($spc0e2ad) + 2; $sp6d85bf = strpos($sp5fe66a, '"' . $this->SIGN_NODE_NAME . '"'); $sp90e55e = $sp6d85bf - 1; if ($sp90e55e < 0) { $sp90e55e = strlen($sp5fe66a) - 1; } $spf5bed6 = $sp90e55e - $spf08491; $sp58e6bf = substr($sp5fe66a, $spf08491 + 1, $spf5bed6 - 2); $sp082d7f = new EncryptParseItem(); $sp082d7f->encryptContent = $sp58e6bf; $sp082d7f->startIndex = $spf08491; $sp082d7f->endIndex = $sp90e55e; return $sp082d7f; } private function encryptXMLSignSource($sp0fc69c, $sp5fe66a) { $spc7e3de = $this->parserEncryptXMLSignSource($sp0fc69c, $sp5fe66a); $sp382597 = substr($sp5fe66a, 0, $spc7e3de->startIndex); $sp3cd842 = substr($sp5fe66a, $spc7e3de->endIndex, strlen($sp5fe66a) + 1 - $spc7e3de->endIndex); $sp5896e5 = aliqr_decrypt($spc7e3de->encryptContent, $this->encryptKey); return $sp382597 . $sp5896e5 . $sp3cd842; } private function parserEncryptXMLSignSource($sp0fc69c, $sp5fe66a) { $spb0ddd2 = $sp0fc69c->getApiMethodName(); $sp98c38f = str_replace('.', '_', $spb0ddd2) . $this->RESPONSE_SUFFIX; $sp64d707 = strpos($sp5fe66a, $sp98c38f); $sp02c29f = strpos($sp5fe66a, $this->ERROR_RESPONSE); if ($sp64d707 > 0) { return $this->parserEncryptXMLItem($sp5fe66a, $sp98c38f, $sp64d707); } else { if ($sp02c29f > 0) { return $this->parserEncryptXMLItem($sp5fe66a, $this->ERROR_RESPONSE, $sp02c29f); } else { return null; } } } private function parserEncryptXMLItem($sp5fe66a, $spc0e2ad, $sp0f0033) { $spf08491 = $sp0f0033 + strlen($spc0e2ad) + 1; $spdb100f = '<' . $this->ENCRYPT_XML_NODE_NAME . '>'; $sp2432cd = '</' . $this->ENCRYPT_XML_NODE_NAME . '>'; $sp32b8ec = strpos($sp5fe66a, $sp2432cd); if ($sp32b8ec < 0) { $spf427c6 = new EncryptParseItem(); $spf427c6->encryptContent = null; $spf427c6->startIndex = 0; $spf427c6->endIndex = 0; return $spf427c6; } $sp38a925 = $spf08491 + strlen($spdb100f); $sp91d441 = $sp32b8ec - $sp38a925; $sp5896e5 = substr($sp5fe66a, $sp38a925, $sp91d441); $sp082d7f = new EncryptParseItem(); $sp082d7f->encryptContent = $sp5896e5; $sp082d7f->startIndex = $spf08491; $sp082d7f->endIndex = $sp32b8ec + strlen($sp2432cd); return $sp082d7f; } function echoDebug($spf0a6e9) { if ($this->debugInfo) { echo '<br/>' . $spf0a6e9; } } }