<?php
require_once 'AopEncrypt.php'; class AopClient { public $appId; public $rsaPrivateKeyFilePath; public $rsaPrivateKey; public $gatewayUrl = 'https://openapi.alipay.com/gateway.do'; public $format = 'json'; public $apiVersion = '1.0'; public $postCharset = 'UTF-8'; public $alipayPublicKey = null; public $alipayrsaPublicKey; public $debugInfo = false; private $fileCharset = 'UTF-8'; private $RESPONSE_SUFFIX = '_response'; private $ERROR_RESPONSE = 'error_response'; private $SIGN_NODE_NAME = 'sign'; private $ENCRYPT_XML_NODE_NAME = 'response_encrypted'; private $needEncrypt = false; public $signType = 'RSA'; public $encryptKey; public $encryptType = 'AES'; protected $alipaySdkVersion = 'alipay-sdk-php-20161101'; public function generateSign($sp636f0e, $sp6693a9 = 'RSA') { return $this->sign($this->getSignContent($sp636f0e), $sp6693a9); } public function rsaSign($sp636f0e, $sp6693a9 = 'RSA') { return $this->sign($this->getSignContent($sp636f0e), $sp6693a9); } protected function getSignContent($sp636f0e) { ksort($sp636f0e); $sp191a9d = ''; $sp3f53b5 = 0; foreach ($sp636f0e as $spc20e8d => $spc86f28) { if (false === $this->checkEmpty($spc86f28) && '@' != substr($spc86f28, 0, 1)) { $spc86f28 = $this->characet($spc86f28, $this->postCharset); if ($sp3f53b5 == 0) { $sp191a9d .= "{$spc20e8d}" . '=' . "{$spc86f28}"; } else { $sp191a9d .= '&' . "{$spc20e8d}" . '=' . "{$spc86f28}"; } $sp3f53b5++; } } unset($spc20e8d, $spc86f28); return $sp191a9d; } protected function sign($sp2bb3bd, $sp6693a9 = 'RSA') { if ($this->checkEmpty($this->rsaPrivateKeyFilePath)) { $sp366c33 = $this->rsaPrivateKey; $sp5f9727 = '-----BEGIN RSA PRIVATE KEY-----
' . wordwrap($sp366c33, 64, '
', true) . '
-----END RSA PRIVATE KEY-----'; } else { $sp366c33 = file_get_contents($this->rsaPrivateKeyFilePath); $sp5f9727 = openssl_get_privatekey($sp366c33); } $sp5f9727 or die('æ‚¨ä½¿ç”¨çš„ç§é’¥æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥RSAç§é’¥é…ç½®'); if ('RSA2' == $sp6693a9) { openssl_sign($sp2bb3bd, $spc768dc, $sp5f9727, OPENSSL_ALGO_SHA256); } else { openssl_sign($sp2bb3bd, $spc768dc, $sp5f9727); } if (!$this->checkEmpty($this->rsaPrivateKeyFilePath)) { openssl_free_key($sp5f9727); } $spc768dc = base64_encode($spc768dc); return $spc768dc; } protected function curl($spadfef0, $spe157fa = null) { $spe77a27 = curl_init(); curl_setopt($spe77a27, CURLOPT_URL, $spadfef0); curl_setopt($spe77a27, CURLOPT_FAILONERROR, false); curl_setopt($spe77a27, CURLOPT_RETURNTRANSFER, true); curl_setopt($spe77a27, CURLOPT_SSL_VERIFYPEER, false); $sp1ff9d7 = ''; $spba2cab = array(); $sp598692 = false; if (is_array($spe157fa) && 0 < count($spe157fa)) { foreach ($spe157fa as $spc20e8d => $spc86f28) { if ('@' != substr($spc86f28, 0, 1)) { $sp1ff9d7 .= "{$spc20e8d}=" . urlencode($this->characet($spc86f28, $this->postCharset)) . '&'; $spba2cab[$spc20e8d] = $this->characet($spc86f28, $this->postCharset); } else { $sp598692 = true; $spba2cab[$spc20e8d] = new \CURLFile(substr($spc86f28, 1)); } } unset($spc20e8d, $spc86f28); curl_setopt($spe77a27, CURLOPT_POST, true); if ($sp598692) { curl_setopt($spe77a27, CURLOPT_POSTFIELDS, $spba2cab); } else { curl_setopt($spe77a27, CURLOPT_POSTFIELDS, substr($sp1ff9d7, 0, -1)); } } if ($sp598692) { $spfc203b = array('content-type: multipart/form-data;charset=' . $this->postCharset . ';boundary=' . $this->getMillisecond()); } else { $spfc203b = array('content-type: application/x-www-form-urlencoded;charset=' . $this->postCharset); } curl_setopt($spe77a27, CURLOPT_HTTPHEADER, $spfc203b); $spb332de = curl_exec($spe77a27); if (curl_errno($spe77a27)) { throw new Exception(curl_error($spe77a27), 0); } else { $spa6c6a9 = curl_getinfo($spe77a27, CURLINFO_HTTP_CODE); if (200 !== $spa6c6a9) { throw new Exception($spb332de, $spa6c6a9); } } curl_close($spe77a27); return $spb332de; } protected function getMillisecond() { list($spce66eb, $sp09ecdd) = explode(' ', microtime()); return (double) sprintf('%.0f', (floatval($spce66eb) + floatval($sp09ecdd)) * 1000); } protected function logCommunicationError($sp38c83e, $sp01c843, $sp71d0d9, $spd1a382) { $spf0ae94 = isset($_SERVER['SERVER_ADDR']) ? $_SERVER['SERVER_ADDR'] : 'CLI'; $sp69114a = new LtLogger(); $sp69114a->conf['log_file'] = rtrim(AOP_SDK_WORK_DIR, '\\/') . '/' . 'logs/aop_comm_err_' . $this->appId . '_' . date('Y-m-d') . '.log'; $sp69114a->conf['separator'] = '^_^'; $spa74d01 = array(date('Y-m-d H:i:s'), $sp38c83e, $this->appId, $spf0ae94, PHP_OS, $this->alipaySdkVersion, $sp01c843, $sp71d0d9, str_replace('
', '', $spd1a382)); $sp69114a->log($spa74d01); } public function sdkExecute($spceaf29) { $this->setupCharsets($spceaf29); $sp636f0e['app_id'] = $this->appId; $sp636f0e['method'] = $spceaf29->getApiMethodName(); $sp636f0e['format'] = $this->format; $sp636f0e['sign_type'] = $this->signType; $sp636f0e['timestamp'] = date('Y-m-d H:i:s'); $sp636f0e['alipay_sdk'] = $this->alipaySdkVersion; $sp636f0e['charset'] = $this->postCharset; $spaa2e8b = $spceaf29->getApiVersion(); $sp636f0e['version'] = $this->checkEmpty($spaa2e8b) ? $this->apiVersion : $spaa2e8b; if ($sp45b937 = $spceaf29->getNotifyUrl()) { $sp636f0e['notify_url'] = $sp45b937; } $spfb88a9 = $spceaf29->getApiParas(); $sp636f0e['biz_content'] = $spfb88a9['biz_content']; ksort($sp636f0e); $sp636f0e['sign'] = $this->generateSign($sp636f0e, $this->signType); foreach ($sp636f0e as &$sp4d089d) { $sp4d089d = $this->characet($sp4d089d, $sp636f0e['charset']); } return http_build_query($sp636f0e); } public function pageExecute($spceaf29, $spf981e9 = 'POST') { $this->setupCharsets($spceaf29); if (strcasecmp($this->fileCharset, $this->postCharset)) { throw new Exception('æ–‡ä»¶ç¼–ç ï¼š[' . $this->fileCharset . '] ä¸Žè¡¨å•æäº¤ç¼–ç ï¼š[' . $this->postCharset . ']ä¸¤è€…ä¸ä¸€è‡´!'); } $spe0b13f = null; if (!$this->checkEmpty($spceaf29->getApiVersion())) { $spe0b13f = $spceaf29->getApiVersion(); } else { $spe0b13f = $this->apiVersion; } $sp0f7cfc['app_id'] = $this->appId; $sp0f7cfc['version'] = $spe0b13f; $sp0f7cfc['format'] = $this->format; $sp0f7cfc['sign_type'] = $this->signType; $sp0f7cfc['method'] = $spceaf29->getApiMethodName(); $sp0f7cfc['timestamp'] = date('Y-m-d H:i:s'); $sp0f7cfc['alipay_sdk'] = $this->alipaySdkVersion; $sp0f7cfc['terminal_type'] = $spceaf29->getTerminalType(); $sp0f7cfc['terminal_info'] = $spceaf29->getTerminalInfo(); $sp0f7cfc['prod_code'] = $spceaf29->getProdCode(); $sp0f7cfc['notify_url'] = $spceaf29->getNotifyUrl(); $sp0f7cfc['return_url'] = $spceaf29->getReturnUrl(); $sp0f7cfc['charset'] = $this->postCharset; $sp6a8129 = $spceaf29->getApiParas(); if (method_exists($spceaf29, 'getNeedEncrypt') && $spceaf29->getNeedEncrypt()) { $sp0f7cfc['encrypt_type'] = $this->encryptType; if ($this->checkEmpty($sp6a8129['biz_content'])) { throw new Exception(' api request Fail! The reason : encrypt request is not supperted!'); } if ($this->checkEmpty($this->encryptKey) || $this->checkEmpty($this->encryptType)) { throw new Exception(' encryptType and encryptKey must not null! '); } if ('AES' != $this->encryptType) { throw new Exception('åŠ å¯†ç±»åž‹åªæ”¯æŒAES'); } $spd96a4c = aliqr_encrypt($sp6a8129['biz_content'], $this->encryptKey); $sp6a8129['biz_content'] = $spd96a4c; } $sp0ff894 = array_merge($sp6a8129, $sp0f7cfc); $spbae43b = $this->getSignContent($sp0ff894); $sp0ff894['sign'] = $this->generateSign($sp0ff894, $this->signType); if ('GET' == $spf981e9) { $sp01c843 = $this->gatewayUrl . '?' . $spbae43b . '&sign=' . urlencode($sp0ff894['sign']); return $sp01c843; } else { return $this->buildRequestForm($sp0ff894); } } protected function buildRequestForm($sp93f5cb) { $spee702c = '<form id=\'alipaysubmit\' name=\'alipaysubmit\' action=\'' . $this->gatewayUrl . '?charset=' . trim($this->postCharset) . '\' method=\'POST\'>'; while (list($spc95936, $spfa4469) = each($sp93f5cb)) { if (false === $this->checkEmpty($spfa4469)) { $spfa4469 = str_replace('\'', '&apos;', $spfa4469); $spee702c .= '<input type=\'hidden\' name=\'' . $spc95936 . '\' value=\'' . $spfa4469 . '\'/>'; } } $spee702c = $spee702c . '<input type=\'submit\' value=\'ok\' style=\'display:none;\'\'></form>'; $spee702c = $spee702c . '<script>document.forms[\'alipaysubmit\'].submit();</script>'; return $spee702c; } public function execute($spceaf29, $sp74e318 = null, $sp951695 = null) { $this->setupCharsets($spceaf29); if (strcasecmp($this->fileCharset, $this->postCharset)) { throw new Exception('æ–‡ä»¶ç¼–ç ï¼š[' . $this->fileCharset . '] ä¸Žè¡¨å•æäº¤ç¼–ç ï¼š[' . $this->postCharset . ']ä¸¤è€…ä¸ä¸€è‡´!'); } $spe0b13f = null; if (!$this->checkEmpty($spceaf29->getApiVersion())) { $spe0b13f = $spceaf29->getApiVersion(); } else { $spe0b13f = $this->apiVersion; } $sp0f7cfc['app_id'] = $this->appId; $sp0f7cfc['version'] = $spe0b13f; $sp0f7cfc['format'] = $this->format; $sp0f7cfc['sign_type'] = $this->signType; $sp0f7cfc['method'] = $spceaf29->getApiMethodName(); $sp0f7cfc['timestamp'] = date('Y-m-d H:i:s'); $sp0f7cfc['auth_token'] = $sp74e318; $sp0f7cfc['alipay_sdk'] = $this->alipaySdkVersion; $sp0f7cfc['terminal_type'] = $spceaf29->getTerminalType(); $sp0f7cfc['terminal_info'] = $spceaf29->getTerminalInfo(); $sp0f7cfc['prod_code'] = $spceaf29->getProdCode(); $sp0f7cfc['notify_url'] = $spceaf29->getNotifyUrl(); $sp0f7cfc['charset'] = $this->postCharset; $sp0f7cfc['app_auth_token'] = $sp951695; $sp6a8129 = $spceaf29->getApiParas(); if (method_exists($spceaf29, 'getNeedEncrypt') && $spceaf29->getNeedEncrypt()) { $sp0f7cfc['encrypt_type'] = $this->encryptType; if ($this->checkEmpty($sp6a8129['biz_content'])) { throw new Exception(' api request Fail! The reason : encrypt request is not supperted!'); } if ($this->checkEmpty($this->encryptKey) || $this->checkEmpty($this->encryptType)) { throw new Exception(' encryptType and encryptKey must not null! '); } if ('AES' != $this->encryptType) { throw new Exception('åŠ å¯†ç±»åž‹åªæ”¯æŒAES'); } $spd96a4c = aliqr_encrypt($sp6a8129['biz_content'], $this->encryptKey); $sp6a8129['biz_content'] = $spd96a4c; } $sp0f7cfc['sign'] = $this->generateSign(array_merge($sp6a8129, $sp0f7cfc), $this->signType); $sp01c843 = $this->gatewayUrl . '?'; foreach ($sp0f7cfc as $sp5736f3 => $sp411d52) { $sp01c843 .= "{$sp5736f3}=" . urlencode($this->characet($sp411d52, $this->postCharset)) . '&'; } $sp01c843 = substr($sp01c843, 0, -1); try { $spf316c0 = $this->curl($sp01c843, $sp6a8129); } catch (Exception $spa0e498) { $this->logCommunicationError($sp0f7cfc['method'], $sp01c843, 'HTTP_ERROR_' . $spa0e498->getCode(), $spa0e498->getMessage()); return false; } $sp6502ab = false; $spf8be5b = iconv($this->postCharset, $this->fileCharset . '//IGNORE', $spf316c0); $spbf5b90 = null; if ('json' == $this->format) { $sp2741b7 = json_decode($spf8be5b); if (null !== $sp2741b7) { $sp6502ab = true; $spbf5b90 = $this->parserJSONSignData($spceaf29, $spf316c0, $sp2741b7); } } else { if ('xml' == $this->format) { $sp2741b7 = @simplexml_load_string($spf316c0); if (false !== $sp2741b7) { $sp6502ab = true; $spbf5b90 = $this->parserXMLSignData($spceaf29, $spf316c0); } } } if (false === $sp6502ab) { $this->logCommunicationError($sp0f7cfc['method'], $sp01c843, 'HTTP_RESPONSE_NOT_WELL_FORMED', $spf316c0); return false; } $this->checkResponseSign($spceaf29, $spbf5b90, $spf316c0, $sp2741b7); if (method_exists($spceaf29, 'getNeedEncrypt') && $spceaf29->getNeedEncrypt()) { if ('json' == $this->format) { $spf316c0 = $this->encryptJSONSignSource($spceaf29, $spf316c0); $spf8be5b = iconv($this->postCharset, $this->fileCharset . '//IGNORE', $spf316c0); $sp2741b7 = json_decode($spf8be5b); } else { $spf316c0 = $this->encryptXMLSignSource($spceaf29, $spf316c0); $spf8be5b = iconv($this->postCharset, $this->fileCharset . '//IGNORE', $spf316c0); $sp2741b7 = @simplexml_load_string($spf8be5b); } } return $sp2741b7; } function characet($sp2bb3bd, $sp2cb282) { if (!empty($sp2bb3bd)) { $sp95866b = $this->fileCharset; if (strcasecmp($sp95866b, $sp2cb282) != 0) { $sp2bb3bd = mb_convert_encoding($sp2bb3bd, $sp2cb282, $sp95866b); } } return $sp2bb3bd; } public function exec($sp85fb02) { if (!isset($sp85fb02['method'])) { trigger_error('No api name passed'); } $sp552f16 = new LtInflector(); $sp552f16->conf['separator'] = '.'; $sp5a7fb3 = ucfirst($sp552f16->camelize(substr($sp85fb02['method'], 7))) . 'Request'; if (!class_exists($sp5a7fb3)) { trigger_error('No such api: ' . $sp85fb02['method']); } $spaf63c1 = isset($sp85fb02['session']) ? $sp85fb02['session'] : null; $sp2cd750 = new $sp5a7fb3(); foreach ($sp85fb02 as $sp932742 => $sp54ded4) { $sp552f16->conf['separator'] = '_'; $spfa8f63 = $sp552f16->camelize($sp932742); $sp552f16->conf['separator'] = '.'; $spfa8f63 = 'set' . $sp552f16->camelize($spfa8f63); if (method_exists($sp2cd750, $spfa8f63)) { $sp2cd750->{$spfa8f63}($sp54ded4); } } return $this->execute($sp2cd750, $spaf63c1); } protected function checkEmpty($sp4d089d) { if (!isset($sp4d089d)) { return true; } if ($sp4d089d === null) { return true; } if (trim($sp4d089d) === '') { return true; } return false; } public function rsaCheckV1($sp636f0e, $spd4dcd4, $sp6693a9 = 'RSA') { $spc768dc = $sp636f0e['sign']; $sp636f0e['sign_type'] = null; $sp636f0e['sign'] = null; return $this->verify($this->getSignContent($sp636f0e), $spc768dc, $spd4dcd4, $sp6693a9); } public function rsaCheckV2($sp636f0e, $spd4dcd4, $sp6693a9 = 'RSA') { print_r($sp636f0e); $spc768dc = $sp636f0e['sign']; $sp636f0e['sign'] = null; return $this->verify($this->getSignContent($sp636f0e), $spc768dc, $spd4dcd4, $sp6693a9); } function verify($sp2bb3bd, $spc768dc, $spd4dcd4, $sp6693a9 = 'RSA') { if ($this->checkEmpty($this->alipayPublicKey)) { $spcb1de1 = $this->alipayrsaPublicKey; $sp5f9727 = '-----BEGIN PUBLIC KEY-----
' . wordwrap($spcb1de1, 64, '
', true) . '
-----END PUBLIC KEY-----'; } else { $spcb1de1 = file_get_contents($spd4dcd4); $sp5f9727 = openssl_get_publickey($spcb1de1); } $sp5f9727 or die('æ”¯ä»˜å®RSAå…¬é’¥é”™è¯¯ã€‚è¯·æ£€æŸ¥å…¬é’¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®'); if ('RSA2' == $sp6693a9) { $spfe67da = (bool) openssl_verify($sp2bb3bd, base64_decode($spc768dc), $sp5f9727, OPENSSL_ALGO_SHA256); } else { $spfe67da = (bool) openssl_verify($sp2bb3bd, base64_decode($spc768dc), $sp5f9727); } if (!$this->checkEmpty($this->alipayPublicKey)) { openssl_free_key($sp5f9727); } return $spfe67da; } public function checkSignAndDecrypt($sp636f0e, $sp1e8af2, $spfbd1e1, $sp353632, $spfdd4d8) { $sp9d5b1a = $sp636f0e['charset']; $spc7d01c = $sp636f0e['biz_content']; if ($sp353632) { if (!$this->rsaCheckV2($sp636f0e, $sp1e8af2)) { echo '<br/>checkSign failure<br/>'; die; } } if ($spfdd4d8) { return $this->rsaDecrypt($spc7d01c, $spfbd1e1, $sp9d5b1a); } return $spc7d01c; } public function encryptAndSign($spc7d01c, $sp1e8af2, $spfbd1e1, $sp9d5b1a, $spa73201, $sp17ea0d) { if ($spa73201 && $sp17ea0d) { $sp5dd9f8 = $this->rsaEncrypt($spc7d01c, $sp1e8af2, $sp9d5b1a); $spc768dc = $this->sign($spc7d01c); $sp651d08 = "<?xml version=\"1.0\" encoding=\"{$sp9d5b1a}\"?><alipay><response>{$sp5dd9f8}</response><encryption_type>RSA</encryption_type><sign>{$spc768dc}</sign><sign_type>RSA</sign_type></alipay>"; return $sp651d08; } if ($spa73201 && !$sp17ea0d) { $sp5dd9f8 = $this->rsaEncrypt($spc7d01c, $sp1e8af2, $sp9d5b1a); $sp651d08 = "<?xml version=\"1.0\" encoding=\"{$sp9d5b1a}\"?><alipay><response>{$sp5dd9f8}</response><encryption_type>RSA</encryption_type></alipay>"; return $sp651d08; } if (!$spa73201 && $sp17ea0d) { $spc768dc = $this->sign($spc7d01c); $sp651d08 = "<?xml version=\"1.0\" encoding=\"{$sp9d5b1a}\"?><alipay><response>{$spc7d01c}</response><sign>{$spc768dc}</sign><sign_type>RSA</sign_type></alipay>"; return $sp651d08; } $sp651d08 = "<?xml version=\"1.0\" encoding=\"{$sp9d5b1a}\"?>{$spc7d01c}"; return $sp651d08; } public function rsaEncrypt($sp2bb3bd, $sp1e8af2, $sp9d5b1a) { $spcb1de1 = file_get_contents($sp1e8af2); $sp5f9727 = openssl_get_publickey($spcb1de1); $spe866b1 = $this->splitCN($sp2bb3bd, 0, 30, $sp9d5b1a); $sp81bf38 = null; $sp79f633 = array(); foreach ($spe866b1 as $sp0464e0 => $sp01deed) { if (!openssl_public_encrypt($sp01deed, $sp81bf38, $sp5f9727)) { echo '<br/>' . openssl_error_string() . '<br/>'; } $sp17704f[] = $sp81bf38; } $sp6656a4 = implode(',', $sp17704f); return $sp6656a4; } public function rsaDecrypt($sp2bb3bd, $spfbd1e1, $sp9d5b1a) { $sp366c33 = file_get_contents($spfbd1e1); $sp5f9727 = openssl_get_privatekey($sp366c33); $sp94e5f1 = explode(',', $sp2bb3bd); $sp9496b9 = ''; $spb517c7 = ''; foreach ($sp94e5f1 as $sp0464e0 => $sp881ee8) { if (!openssl_private_decrypt($sp881ee8, $spb517c7, $sp5f9727)) { echo '<br/>' . openssl_error_string() . '<br/>'; } $sp9496b9 .= $spb517c7; } return $sp9496b9; } function splitCN($sp2b43d5, $sp0464e0 = 0, $sp364798, $sp9d5b1a) { $spc16e9b = array(); for ($sp3f53b5 = $sp0464e0; $sp3f53b5 < strlen($sp2b43d5); $sp3f53b5 += $sp364798) { $sp5f9727 = $this->subCNchar($sp2b43d5, $sp3f53b5, $sp364798, $sp9d5b1a); if (!empty($sp5f9727)) { $spc16e9b[] = $sp5f9727; } } return $spc16e9b; } function subCNchar($spba2cdb, $spcffadb = 0, $spf9d313, $sp9d5b1a = 'gbk') { if (strlen($spba2cdb) <= $spf9d313) { return $spba2cdb; } $spa7f486['utf-8'] = '/[-]|[Â-ß][€-¿]|[à-ï][€-¿]{2}|[ð-ÿ][€-¿]{3}/'; $spa7f486['gb2312'] = '/[-]|[°-÷][ -þ]/'; $spa7f486['gbk'] = '/[-]|[-þ][@-þ]/'; $spa7f486['big5'] = '/[-]|[-þ]([@-~]|¡-þ])/'; preg_match_all($spa7f486[$sp9d5b1a], $spba2cdb, $sp9eadee); $spbfeb46 = join('', array_slice($sp9eadee[0], $spcffadb, $spf9d313)); return $spbfeb46; } function parserResponseSubCode($spceaf29, $sp0f8bbb, $sp2741b7, $sp5e1fb8) { if ('json' == $sp5e1fb8) { $sp38c83e = $spceaf29->getApiMethodName(); $sp01775c = str_replace('.', '_', $sp38c83e) . $this->RESPONSE_SUFFIX; $sp8c7d26 = $this->ERROR_RESPONSE; $spffa0fb = strpos($sp0f8bbb, $sp01775c); $sp5367be = strpos($sp0f8bbb, $sp8c7d26); if ($spffa0fb > 0) { $sp965580 = $sp2741b7->{$sp01775c}; } elseif ($sp5367be > 0) { $sp965580 = $sp2741b7->{$sp8c7d26}; } else { return null; } if (isset($sp965580->sub_code)) { return $sp965580->sub_code; } else { return null; } } elseif ('xml' == $sp5e1fb8) { return $sp2741b7->sub_code; } } function parserJSONSignData($spceaf29, $sp0f8bbb, $sp197c6f) { $spbf5b90 = new SignData(); $spbf5b90->sign = $this->parserJSONSign($sp197c6f); $spbf5b90->signSourceData = $this->parserJSONSignSource($spceaf29, $sp0f8bbb); return $spbf5b90; } function parserJSONSignSource($spceaf29, $sp0f8bbb) { $sp38c83e = $spceaf29->getApiMethodName(); $sp01775c = str_replace('.', '_', $sp38c83e) . $this->RESPONSE_SUFFIX; $spffa0fb = strpos($sp0f8bbb, $sp01775c); $sp5367be = strpos($sp0f8bbb, $this->ERROR_RESPONSE); if ($spffa0fb > 0) { return $this->parserJSONSource($sp0f8bbb, $sp01775c, $spffa0fb); } else { if ($sp5367be > 0) { return $this->parserJSONSource($sp0f8bbb, $this->ERROR_RESPONSE, $sp5367be); } else { return null; } } } function parserJSONSource($sp0f8bbb, $sp97c0f7, $sp6e08f3) { $sp3c47c7 = $sp6e08f3 + strlen($sp97c0f7) + 2; $sp2d1d00 = strpos($sp0f8bbb, '"' . $this->SIGN_NODE_NAME . '"'); $sp532b87 = $sp2d1d00 - 1; $sp121f4e = $sp532b87 - $sp3c47c7; if ($sp121f4e < 0) { return null; } return substr($sp0f8bbb, $sp3c47c7, $sp121f4e); } function parserJSONSign($spde59fb) { return $spde59fb->sign; } function parserXMLSignData($spceaf29, $sp0f8bbb) { $spbf5b90 = new SignData(); $spbf5b90->sign = $this->parserXMLSign($sp0f8bbb); $spbf5b90->signSourceData = $this->parserXMLSignSource($spceaf29, $sp0f8bbb); return $spbf5b90; } function parserXMLSignSource($spceaf29, $sp0f8bbb) { $sp38c83e = $spceaf29->getApiMethodName(); $sp01775c = str_replace('.', '_', $sp38c83e) . $this->RESPONSE_SUFFIX; $spffa0fb = strpos($sp0f8bbb, $sp01775c); $sp5367be = strpos($sp0f8bbb, $this->ERROR_RESPONSE); if ($spffa0fb > 0) { return $this->parserXMLSource($sp0f8bbb, $sp01775c, $spffa0fb); } else { if ($sp5367be > 0) { return $this->parserXMLSource($sp0f8bbb, $this->ERROR_RESPONSE, $sp5367be); } else { return null; } } } function parserXMLSource($sp0f8bbb, $sp97c0f7, $sp6e08f3) { $sp3c47c7 = $sp6e08f3 + strlen($sp97c0f7) + 1; $sp2d1d00 = strpos($sp0f8bbb, '<' . $this->SIGN_NODE_NAME . '>'); $sp532b87 = $sp2d1d00 - 1; $sp121f4e = $sp532b87 - $sp3c47c7 + 1; if ($sp121f4e < 0) { return null; } return substr($sp0f8bbb, $sp3c47c7, $sp121f4e); } function parserXMLSign($sp0f8bbb) { $spe3c33b = '<' . $this->SIGN_NODE_NAME . '>'; $spa685ad = '</' . $this->SIGN_NODE_NAME . '>'; $spcd47e2 = strpos($sp0f8bbb, $spe3c33b); $spbb1b96 = strpos($sp0f8bbb, $spa685ad); if ($spcd47e2 < 0 || $spbb1b96 < 0) { return null; } $sp6e08f3 = $spcd47e2 + strlen($spe3c33b); $sp121f4e = $spbb1b96 - $sp6e08f3; if ($sp121f4e < 0) { return null; } return substr($sp0f8bbb, $sp6e08f3, $sp121f4e); } public function checkResponseSign($spceaf29, $spbf5b90, $spf316c0, $sp2741b7) { if (!$this->checkEmpty($this->alipayPublicKey) || !$this->checkEmpty($this->alipayrsaPublicKey)) { if ($spbf5b90 == null || $this->checkEmpty($spbf5b90->sign) || $this->checkEmpty($spbf5b90->signSourceData)) { throw new Exception(' check sign Fail! The reason : signData is Empty'); } $sp4cf071 = $this->parserResponseSubCode($spceaf29, $spf316c0, $sp2741b7, $this->format); if (!$this->checkEmpty($sp4cf071) || $this->checkEmpty($sp4cf071) && !$this->checkEmpty($spbf5b90->sign)) { $sp8c5ad5 = $this->verify($spbf5b90->signSourceData, $spbf5b90->sign, $this->alipayPublicKey, $this->signType); if (!$sp8c5ad5) { if (strpos($spbf5b90->signSourceData, '\\/') > 0) { $spbf5b90->signSourceData = str_replace('\\/', '/', $spbf5b90->signSourceData); $sp8c5ad5 = $this->verify($spbf5b90->signSourceData, $spbf5b90->sign, $this->alipayPublicKey, $this->signType); if (!$sp8c5ad5) { throw new Exception('check sign Fail! [sign=' . $spbf5b90->sign . ', signSourceData=' . $spbf5b90->signSourceData . ']'); } } else { throw new Exception('check sign Fail! [sign=' . $spbf5b90->sign . ', signSourceData=' . $spbf5b90->signSourceData . ']'); } } } } } private function setupCharsets($spceaf29) { if ($this->checkEmpty($this->postCharset)) { $this->postCharset = 'UTF-8'; } $spba2cdb = preg_match('/[\\x80-\\xff]/', $this->appId) ? $this->appId : print_r($spceaf29, true); $this->fileCharset = mb_detect_encoding($spba2cdb, 'UTF-8, GBK') == 'UTF-8' ? 'UTF-8' : 'GBK'; } private function encryptJSONSignSource($spceaf29, $sp0f8bbb) { $spcd4b56 = $this->parserEncryptJSONSignSource($spceaf29, $sp0f8bbb); $sp3e235d = substr($sp0f8bbb, 0, $spcd4b56->startIndex); $sp9f6342 = substr($sp0f8bbb, $spcd4b56->endIndex, strlen($sp0f8bbb) + 1 - $spcd4b56->endIndex); $spc7d01c = aliqr_decrypt($spcd4b56->encryptContent, $this->encryptKey); return $sp3e235d . $spc7d01c . $sp9f6342; } private function parserEncryptJSONSignSource($spceaf29, $sp0f8bbb) { $sp38c83e = $spceaf29->getApiMethodName(); $sp01775c = str_replace('.', '_', $sp38c83e) . $this->RESPONSE_SUFFIX; $spffa0fb = strpos($sp0f8bbb, $sp01775c); $sp5367be = strpos($sp0f8bbb, $this->ERROR_RESPONSE); if ($spffa0fb > 0) { return $this->parserEncryptJSONItem($sp0f8bbb, $sp01775c, $spffa0fb); } else { if ($sp5367be > 0) { return $this->parserEncryptJSONItem($sp0f8bbb, $this->ERROR_RESPONSE, $sp5367be); } else { return null; } } } private function parserEncryptJSONItem($sp0f8bbb, $sp97c0f7, $sp6e08f3) { $sp3c47c7 = $sp6e08f3 + strlen($sp97c0f7) + 2; $sp2d1d00 = strpos($sp0f8bbb, '"' . $this->SIGN_NODE_NAME . '"'); $sp532b87 = $sp2d1d00 - 1; if ($sp532b87 < 0) { $sp532b87 = strlen($sp0f8bbb) - 1; } $sp121f4e = $sp532b87 - $sp3c47c7; $sp52bdd5 = substr($sp0f8bbb, $sp3c47c7 + 1, $sp121f4e - 2); $spfb1ec9 = new EncryptParseItem(); $spfb1ec9->encryptContent = $sp52bdd5; $spfb1ec9->startIndex = $sp3c47c7; $spfb1ec9->endIndex = $sp532b87; return $spfb1ec9; } private function encryptXMLSignSource($spceaf29, $sp0f8bbb) { $spcd4b56 = $this->parserEncryptXMLSignSource($spceaf29, $sp0f8bbb); $sp3e235d = substr($sp0f8bbb, 0, $spcd4b56->startIndex); $sp9f6342 = substr($sp0f8bbb, $spcd4b56->endIndex, strlen($sp0f8bbb) + 1 - $spcd4b56->endIndex); $spc7d01c = aliqr_decrypt($spcd4b56->encryptContent, $this->encryptKey); return $sp3e235d . $spc7d01c . $sp9f6342; } private function parserEncryptXMLSignSource($spceaf29, $sp0f8bbb) { $sp38c83e = $spceaf29->getApiMethodName(); $sp01775c = str_replace('.', '_', $sp38c83e) . $this->RESPONSE_SUFFIX; $spffa0fb = strpos($sp0f8bbb, $sp01775c); $sp5367be = strpos($sp0f8bbb, $this->ERROR_RESPONSE); if ($spffa0fb > 0) { return $this->parserEncryptXMLItem($sp0f8bbb, $sp01775c, $spffa0fb); } else { if ($sp5367be > 0) { return $this->parserEncryptXMLItem($sp0f8bbb, $this->ERROR_RESPONSE, $sp5367be); } else { return null; } } } private function parserEncryptXMLItem($sp0f8bbb, $sp97c0f7, $sp6e08f3) { $sp3c47c7 = $sp6e08f3 + strlen($sp97c0f7) + 1; $spd90f52 = '<' . $this->ENCRYPT_XML_NODE_NAME . '>'; $sp579641 = '</' . $this->ENCRYPT_XML_NODE_NAME . '>'; $sp57f23f = strpos($sp0f8bbb, $sp579641); if ($sp57f23f < 0) { $sp83d892 = new EncryptParseItem(); $sp83d892->encryptContent = null; $sp83d892->startIndex = 0; $sp83d892->endIndex = 0; return $sp83d892; } $sp5f7481 = $sp3c47c7 + strlen($spd90f52); $sp8e2978 = $sp57f23f - $sp5f7481; $spc7d01c = substr($sp0f8bbb, $sp5f7481, $sp8e2978); $spfb1ec9 = new EncryptParseItem(); $spfb1ec9->encryptContent = $spc7d01c; $spfb1ec9->startIndex = $sp3c47c7; $spfb1ec9->endIndex = $sp57f23f + strlen($sp579641); return $spfb1ec9; } function echoDebug($spb0c78a) { if ($this->debugInfo) { echo '<br/>' . $spb0c78a; } } }